<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="技术日记和杂七杂八的dx">
<meta property="og:type" content="website">
<meta property="og:title" content="地球上的小东西">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="地球上的小东西">
<meta property="og:description" content="技术日记和杂七杂八的dx">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="oldnineping">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>地球上的小东西</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球上的小东西</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">hiahiahiahia</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/08/View%E7%9A%84%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/08/View%E7%9A%84%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">View的触摸反馈原理全解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-08 14:49:26" itemprop="dateCreated datePublished" datetime="2021-10-08T14:49:26+08:00">2021-10-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">自定义view布局02:View绘制流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-07 17:58:44" itemprop="dateCreated datePublished" datetime="2021-09-07T17:58:44+08:00">2021-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-08 15:03:21" itemprop="dateModified" datetime="2021-10-08T15:03:21+08:00">2021-10-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="View-绘制流程"><a href="#View-绘制流程" class="headerlink" title="View 绘制流程"></a>View 绘制流程</h1><h2 id="View-绘制流程主要对象图示"><a href="#View-绘制流程主要对象图示" class="headerlink" title="View 绘制流程主要对象图示"></a>View 绘制流程主要对象图示</h2><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180408351.png" alt=" "></p>
<h2 id="View绘制流程函数调用"><a href="#View绘制流程函数调用" class="headerlink" title="View绘制流程函数调用"></a>View绘制流程函数调用</h2><p>虚线表示至少一次消息处理(API29  之后)</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180743677.png" alt="image-20210907180743677"></p>
<h2 id="Activity与View"><a href="#Activity与View" class="headerlink" title="Activity与View"></a>Activity与View</h2><p>Activity与View是通过PhoneWindow(Window) 对象关联的</p>
<p>Activity 与通过attach()方法Window（实际是PhoneWIndow）关联，</p>
<p>Window通过setContentView()与View关联</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165219071.png" alt="image-20210908165219071"></p>
<h3 id="Activity的实例化和生命周期"><a href="#Activity的实例化和生命周期" class="headerlink" title="Activity的实例化和生命周期"></a>Activity的实例化和生命周期</h3><p>ActivityThread类负责实例化Acitivty类并调用Activity的生命周期方法</p>
<p>所谓的</p>
<p>ActivityThread类中的</p>
<ul>
<li><code>handleLaunchActivity()</code>-&gt;<code>performLaunchActivity()</code>方法会实例化Activity对象并调用Activity对象的onCreate()</li>
<li><code>handleStartActivity()</code>方法调用Activity的onStart()</li>
<li><code>handleResumeActivity()</code>-&gt;<code> performResumeActivity()</code>方法调用Activity的<code>onResume()</code></li>
</ul>
<h4 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a>ActivityThread</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用onCreate</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">          PendingTransactionActions pendingActions, Intent customIntent) &#123;</span><br><span class="line">...                                         </span><br><span class="line">       <span class="comment">// 实例化Activity对象</span></span><br><span class="line">      <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);                                  		...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">     ...</span><br><span class="line">        Activity activity = <span class="literal">null</span>;</span><br><span class="line">    		java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">    			<span class="comment">//调用Instrumentation.newActivity() 方法创建一个Activity对象并返回</span></span><br><span class="line">          activity = mInstrumentation.newActivity(</span><br><span class="line">                  cl, component.getClassName(), r.intent);</span><br><span class="line">     ...</span><br><span class="line">    <span class="comment">// 调用activity  attach方法</span></span><br><span class="line">    activity.attach(appContext,...);</span><br><span class="line">   		 ...</span><br><span class="line">    <span class="comment">// 最终会调用 activity onCreate方法</span></span><br><span class="line">    <span class="comment">// 通过 Instrumentation.callActivityOnCreate() 调用</span></span><br><span class="line">    <span class="comment">// 所以可以看出Activity onCreate() 调用发生在 attach() 方法之后</span></span><br><span class="line">    <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">              &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用resume </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> void  (IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 调用Activity onResume方法</span></span><br><span class="line">      <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">		...</span><br><span class="line">      <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">          <span class="comment">// 也就是PhoneWindow</span></span><br><span class="line">          r.window = r.activity.getWindow();</span><br><span class="line">          View decor = r.window.getDecorView();</span><br><span class="line">					<span class="comment">// 获得的是  WindowManagerImpl </span></span><br><span class="line">          ViewManager wm = a.getWindowManager();</span><br><span class="line">          <span class="comment">// 获得窗口属性</span></span><br><span class="line">          WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">          a.mDecor = decor;</span><br><span class="line">         </span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                  a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 将decorView窗口属性放进去</span></span><br><span class="line">                <span class="comment">// 使用的是 WindowManagerImpl 的addView 方法</span></span><br><span class="line">                  wm.addView(decor, l);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// The activity will get a callback for this &#123;@link LayoutParams&#125; change</span></span><br><span class="line">                  <span class="comment">// earlier. However, at that time the decor will not be set (this is set</span></span><br><span class="line">                  <span class="comment">// in this method), so no action will be taken. This call ensures the</span></span><br><span class="line">                  <span class="comment">// callback occurs with the decor set.</span></span><br><span class="line">                  a.onWindowAttributesChanged(l);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@VisibleForTesting</span><span class="comment">// 会调用 activity的onResume方法</span></span><br><span class="line">  <span class="keyword">public</span> ActivityClientRecord performResumeActivity(IBinder token, boolean finalStateRequest,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">   r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="实例化Activity"><a href="#实例化Activity" class="headerlink" title="实例化Activity"></a>实例化Activity</h4><p>利用反射实例化Activity</p>
<h5 id="Instrumentation-newActivity"><a href="#Instrumentation-newActivity" class="headerlink" title="Instrumentation.newActivity()"></a>Instrumentation.newActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    String pkg = intent != <span class="keyword">null</span> &amp;&amp; intent.getComponent() != <span class="keyword">null</span></span><br><span class="line">            ? intent.getComponent().getPackageName() : <span class="keyword">null</span>;</span><br><span class="line">          <span class="comment">// instantiateActivity方法 利用反射实例化Activity对象 </span></span><br><span class="line">    <span class="keyword">return</span> getFactory(pkg).instantiateActivity(cl, className, intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">Activity <span class="title">instantiateActivity</span><span class="params">(<span class="meta">@NonNull</span> ClassLoader cl, <span class="meta">@NonNull</span> String className, <span class="meta">@Nullable</span> Intent intent)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">       <span class="comment">// 反射实例化Activity对象  </span></span><br><span class="line">        <span class="keyword">return</span> (Activity) cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Activity生命周期方法"><a href="#Activity生命周期方法" class="headerlink" title="Activity生命周期方法"></a>Activity生命周期方法</h3><h4 id="attach"><a href="#attach" class="headerlink" title="attach()"></a>attach()</h4><p>它是Activity内部的初始化方法(activity对象创建出来后就马上调用)</p>
<p><code>attach() </code>的调用发生在<code>onCreate()</code>之前</p>
<p>被<code>ActivityThread</code>调用，在<code> handleLaunchActivity()</code>-&gt; <code> -</code>&gt; <code>activity.attach(appContext,...);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// Window 对象被赋值</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">		...</span><br><span class="line">      <span class="comment">// 对Window设置WindowManager</span></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);   </span><br><span class="line">	  <span class="comment">// 对Activity的 WindowManager赋值， get出来的是 WindowManagerImpl </span></span><br><span class="line">   mWindowManager = mWindow.getWindowManager();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h4 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate()"></a>onCreate()</h4><p>和attach()一样被ActivityThread调用，在</p>
<p><code>ActivityThread.handleLaunchActivity()</code>-&gt; <code>ActivityThread.performLaunchActivity()</code>-&gt;</p>
<p><code>Instrumentation.callActivityOnCreate()</code>-&gt;<code>Activity.performCreate()</code>-&gt;<code>Activity.onCreate()</code></p>
<h5 id="Instrumentation-callActivityOnCreate"><a href="#Instrumentation-callActivityOnCreate" class="headerlink" title="Instrumentation.callActivityOnCreate()"></a>Instrumentation.callActivityOnCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">        PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//调用Acitivity 对象的 performCreate() </span></span><br><span class="line">    <span class="comment">// performCreate() 会调用内部的onCreate方法</span></span><br><span class="line">    activity.performCreate(icicle, persistentState);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Activity-performCreate"><a href="#Activity-performCreate" class="headerlink" title="Activity.performCreate()"></a>Activity.performCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">  			<span class="comment">// 调用onCreate方法</span></span><br><span class="line">        <span class="keyword">if</span> (persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">            onCreate(icicle, persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onCreate(icicle);</span><br><span class="line">        &#125;</span><br><span class="line">        ..</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="onResume"><a href="#onResume" class="headerlink" title="onResume()"></a>onResume()</h4><p><code>ActivityThread.handleResumeActivity()</code>-&gt;<code>ActivityThread.performResumeActivity()</code>-&gt;</p>
<p><code>Activity.performResume()</code>-&gt;<code>Instrumentation.callActivityOnResume()</code>-&gt;<code>Activity.OnResume()</code></p>
<h5 id="Activity-performResume"><a href="#Activity-performResume" class="headerlink" title="Activity.performResume()"></a>Activity.performResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">(<span class="keyword">boolean</span> followedByPause, String reason)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">  ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Instrumentation-callActivityOnResume"><a href="#Instrumentation-callActivityOnResume" class="headerlink" title="Instrumentation.callActivityOnResume()"></a>Instrumentation.callActivityOnResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">    activity.onResume();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                am.match(activity, activity, activity.getIntent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Activity-setContentView"><a href="#Activity-setContentView" class="headerlink" title="Activity.setContentView()"></a>Activity.setContentView()</h3><p>Activity 设置布局是通过window（确切的说是PhoneWindow）对象连接的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Activity 内部window是 PhoneWindow对象</span></span><br><span class="line">      getWindow().setContentView(layoutResID);</span><br><span class="line">      initWindowDecorActionBar();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h2 id="Window-amp-PhoneWindow"><a href="#Window-amp-PhoneWindow" class="headerlink" title="Window&amp;PhoneWindow"></a>Window&amp;PhoneWindow</h2><p>Window与View通过DecorVIew产生联系</p>
<p>Activity内部持有 mWindow对象，mWindow 依赖PhoneWindow对象</p>
<p>PhoneWindow持有mDecor对象，mDecor其实是DecorView对象（继承自FrameLayout）</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165416162.png" alt="image-20210908165416162"></p>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><h4 id="Window-getLocalFeatures"><a href="#Window-getLocalFeatures" class="headerlink" title="Window.getLocalFeatures()"></a>Window.getLocalFeatures()</h4><p>Windows的特征，Activity中调用的<code>requestWindowFeature(Window.FEATURE_NO_TITLE)</code>就是修改的这个值</p>
<p><strong>为什么requestWindowFeature() 方法要写在setContentView前面？</strong></p>
<p>因为setContentView() 要用到getLocalFeatures()的返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getLocalFeatures</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mLocalFeatures;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h4><p>实际调用的是DecorView的findviewby，id，就是找到系统布局模版中id是@android:id/content的布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">findViewById</span><span class="params">(<span class="meta">@IdRes</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getDecorView().findViewById(id);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getAttributes"><a href="#getAttributes" class="headerlink" title="getAttributes"></a>getAttributes</h4><p>窗口属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WindowManager.LayoutParams mWindowAttributes =</span><br><span class="line">      <span class="keyword">new</span> WindowManager.LayoutParams();</span><br><span class="line">     </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">      type = TYPE_APPLICATION;</span><br><span class="line">      format = PixelFormat.OPAQUE;</span><br><span class="line">  &#125;    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> WindowManager.<span class="function">LayoutParams <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mWindowAttributes;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="setWindowManager"><a href="#setWindowManager" class="headerlink" title="setWindowManager"></a>setWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 创建一个 WindowManagerImpl 对象</span></span><br><span class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h3><p>Activity 调用 <code>setContentView(int layoutResID)</code>时实际调用的是<code>window.setContentView(int resId)</code></p>
<p>而Activity 内部持有的是PhoneWindow对象的实例，所以其实调用的是PhonewIndow对象的方法</p>
<h4 id="调用installDecor-初始化的过程："><a href="#调用installDecor-初始化的过程：" class="headerlink" title="调用installDecor()初始化的过程："></a>调用installDecor()初始化的过程：</h4><ul>
<li><p>与DecorVIew建立联系</p>
<p>实例化一个DecorView对象，交给PhoneWIndow</p>
<p><code>setContentView(int layoutResID)</code> -&gt;<code>installDecor()</code>-&gt;<code> generateDecor(-1);</code></p>
</li>
<li><p>帮助 DecorView 添加一个根布局（root）</p>
<p>根据Window.getLocalFeatures()获得开发者配置的WIndow特性，选择不同的布局模板，交给DecorVIew创建根布局</p>
<p> <code>setContentView(int layoutResID)</code> -&gt; <code>installDecor();</code>-&gt;<code>generateLayout(mDecor)</code></p>
<p>-&gt; <code> mDecor.onResourcesLoaded(mLayoutInflater, layoutResource)</code></p>
</li>
</ul>
<p>![image-20210909142715857](../../../Library/Application Support/typora-user-images/image-20210909142715857.png)</p>
<ul>
<li><p>将Activity 自定义的布局加入Decor的根布局中id为<code>@android:id/content</code>的FrameLayout中</p>
<p>![image-20210909150251632](../../../Library/Application Support/typora-user-images/image-20210909150251632.png)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">MenuBuilder</span>.<span class="title">Callback</span> </span>&#123;  </span><br><span class="line">  	<span class="comment">// DecorView是 Window里面的顶层View</span></span><br><span class="line">		<span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">  			 <span class="comment">// 初始化时 mContentParent 是 null</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 初始化Decor</span></span><br><span class="line">            installDecor();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 将Activity的布局 layoutResID ，传入DecorView的根布局中</span></span><br><span class="line">            </span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line"> 		&#125;</span><br><span class="line">   <span class="comment">// 初始化 DecorView 并为它添加根布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mForceDecorInstall = <span class="keyword">false</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建 DecorView 对象 赋值给mDecor</span></span><br><span class="line">            mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">            mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 初始化时mContentParent是 null的</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 给mContentParent 赋值</span></span><br><span class="line">          <span class="comment">//generateLayout() 返回的是ID为 android.R.id.content的FrameLayout（系统模版布局中）</span></span><br><span class="line">            mContentParent = generateLayout(mDecor); </span><br><span class="line">        &#125;      </span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 根据一些常用的配置进行设置</span></span><br><span class="line">			<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowNoTitle, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_NO_TITLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBar, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t allow an action bar if there is no title.</span></span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBarOverlay, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR_OVERLAY);</span><br><span class="line">        &#125;  </span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// Inflate the window decor.</span></span><br><span class="line">       <span class="keyword">int</span> layoutResource;</span><br><span class="line">       <span class="comment">// features调用Window.getLocalFeatures()</span></span><br><span class="line">       <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="comment">// features 表示window的特性 ，比如有无title ，actionbar等</span></span><br><span class="line">      <span class="comment">// 根据 features 的不同对 layoutResource 赋值成不同的布局，就可以体现不同特性</span></span><br><span class="line">      <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            layoutResource = R.layout.screen_progress;</span><br><span class="line">           </span><br><span class="line">        &#125; </span><br><span class="line">         ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// 赋值 给  layoutResource 指定布局</span></span><br><span class="line">            layoutResource = R.layout.screen_simple;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDecor.startChanging();</span><br><span class="line">  			<span class="comment">// 通过传入的打气筒和 layoutResource，创建一个View命名为root</span></span><br><span class="line">        <span class="comment">//  mDecor通过addView(root) 将view对象添加到内部 </span></span><br><span class="line">        mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">				<span class="comment">// 调用的是window.findViewById()-&gt;DecorView.findViewById()</span></span><br><span class="line">  			<span class="comment">// 最终要找到的是系统模版中id是@android:id/content的ViewGroup</span></span><br><span class="line">        ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">        </span><br><span class="line">  			<span class="comment">// 根据配置做出一些设置</span></span><br><span class="line">  				...</span><br><span class="line">        <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) </span><br><span class="line">            mDecor.setWindowBackground(mBackgroundDrawable);</span><br><span class="line">            ...</span><br><span class="line">            mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回的是系统模板中id为android.R.id.content的FrameLayout  </span></span><br><span class="line">        <span class="keyword">return</span> contentParent;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="screen-simple-xml"><a href="#screen-simple-xml" class="headerlink" title="screen_simple.xml"></a>screen_simple.xml</h4><p>android-sdk-macosx/platforms/android-30/data/res/layout/screen_simple.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Actionbar 的布局，ViewStub可以节约内存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_mode_bar_stub&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">&quot;@+id/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">&quot;@layout/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">&quot;?attr/actionBarTheme&quot;</span> /&gt;</span></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">         android:id=&quot;@android:id/content&quot;</span><br><span class="line">         android:layout_width=&quot;match_parent&quot;</span><br><span class="line">         android:layout_height=&quot;match_parent&quot;</span><br><span class="line">         android:foregroundInsidePadding=&quot;false&quot;</span><br><span class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="DecorView"><a href="#DecorView" class="headerlink" title="DecorView"></a>DecorView</h2><ul>
<li><p>根据PhoneWindow 传递的根布局信息创建根布局</p>
<p><code>onResourcesLoaded()</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 创建DecorView实例</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">        <span class="comment">// new 一个DecorView 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// 将PhoneWindow根据window内部feature属性设置的根布局加入到DecorView内部 </span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onResourcesLoaded</span><span class="params">(LayoutInflater inflater, <span class="keyword">int</span> layoutResource)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="comment">// 创建一个View对象，</span></span><br><span class="line">        <span class="keyword">final</span> View root = inflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (mDecorCaptionView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDecorCaptionView.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addView(mDecorCaptionView,</span><br><span class="line">                        <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">            &#125;</span><br><span class="line">            mDecorCaptionView.addView(root,</span><br><span class="line">                    <span class="keyword">new</span> ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//通过add View 将这系统模板布局View加入到DecorView里面</span></span><br><span class="line">         </span><br><span class="line">            addView(root, <span class="number">0</span>, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        mContentRoot = (ViewGroup) root;</span><br><span class="line">        initializeElevation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h2><p>DecorView的父View（其实不是一个View）</p>
<p>打印<code>println(window.decorView.parent.toString())</code>得到parent为ViewRootImpl</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210909160559140.png" alt="image-20210909160559140"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">ThreadedRenderer</span>.<span class="title">DrawCallbacks</span> </span>&#123; </span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> Thread mThread;</span><br><span class="line">    <span class="keyword">final</span> View.AttachInfo mAttachInfo;</span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123; </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMessageName</span><span class="params">(Message message)</span> </span>&#123;...&#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123; ...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">// 构造时赋值mThread对象</span></span><br><span class="line">    <span class="comment">// ViewRootImpl构造方法仅在WindowManagerGlobal中调用过</span></span><br><span class="line">    <span class="comment">// 调用它的方法是ActivityThread.performResumeActivity() ，所以mThread必然是主线程</span></span><br><span class="line">    <span class="comment">// checkThread()中将使用mThread  </span></span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">    <span class="comment">// 创建对象，传入handler</span></span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler,    	<span class="keyword">this</span>, context);  </span><br><span class="line">    ...</span><br><span class="line">    &#125;        </span><br><span class="line">    <span class="comment">//检查线程    </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 判断   Thread.currentThread()是否和 mThread对象 相同</span></span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 防止重复绘制的</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">            <span class="comment">// 检查线程</span></span><br><span class="line">            checkThread();</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> 	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// view 即为DecorView</span></span><br><span class="line">     mView = view;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 第一次调用 requestLayout，是自主调用，不是成为其他View的Parent后被迫调用</span></span><br><span class="line">     requestLayout();</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 将ViewRootImpl 设置为DecorView的 Parent</span></span><br><span class="line">     <span class="comment">// 这样才能串联自定义布局-&gt;系统模板布局-&gt;DocerView-ViewRootImpl</span></span><br><span class="line">     view.assignParent(<span class="keyword">this</span>);</span><br><span class="line"> 	&#125;  </span><br><span class="line">          </span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">          <span class="comment">// 向主线程post 一个 Runnable 对象： mTraversalRunnable, </span></span><br><span class="line">          <span class="comment">// postCallback类似handler post，是一个异步操作</span></span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">     ..</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// runnable 调用了doTraversal()方法</span></span><br><span class="line">          <span class="comment">// 因为被异步post ，所以doTraversal会在下次循环时调用</span></span><br><span class="line">            doTraversal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 下次循环调用的  performTraversals()</span></span><br><span class="line">            performTraversals();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 核心方法 Traversals: 遍历</span></span><br><span class="line">    <span class="comment">// 生命周期就是拿着一个对象，调用对象上面的方法，</span></span><br><span class="line">    <span class="comment">// 这个方法也是依托顶层DecorView来出发（如同ActivityThread对应Activity生命周期方法的调用）</span></span><br><span class="line">    <span class="comment">// 它们是： performMeasure()， performLayout(), performDraw(),         </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 状态设置</span></span><br><span class="line">			... </span><br><span class="line">        mIsInTraversal = <span class="keyword">true</span>;</span><br><span class="line">        mWillDrawSoon = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;  </span><br><span class="line">       <span class="comment">// 1. 测量过程  调用decoerview.perform Measur() 先测量Window，再测量View树</span></span><br><span class="line">                </span><br><span class="line">      <span class="comment">// 尺寸相关，窗口属性， 预定义宽高，</span></span><br><span class="line">      <span class="comment">// 如果是Activity它的值和 ActivityThread，WindowManager.addView() 的窗口属性是一样的</span></span><br><span class="line">      WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line">        <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 第一次必然进入，  mLayoutRequested = true，布局必然重新布置</span></span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">           <span class="comment">// 判断一下Window的级别         </span></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Activity lp type参数是Application，而非系统窗口/键盘</span></span><br><span class="line">              <span class="comment">// 所以赋值为屏幕的宽高</span></span><br><span class="line">                desiredWindowWidth = frame.width();</span><br><span class="line">                desiredWindowHeight = frame.height();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将DecorView依附到Window上</span></span><br><span class="line">            <span class="comment">//host 是DecorView</span></span><br><span class="line">            host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; ...&#125; </span><br><span class="line">         <span class="comment">//传如DecorView，完成系统状态栏/导航栏的添加</span></span><br><span class="line">					dispatchApplyInsets(host); </span><br><span class="line">            ...</span><br><span class="line">       <span class="comment">// View执行post操作时，若发生崩溃 AttachInfo == null，</span></span><br><span class="line">       <span class="comment">// 也就拿不到handler对象，可执行的runnable会暂时存在一个队列中</span></span><br><span class="line">       <span class="comment">// 此时就是执行队列中runnable的时机  </span></span><br><span class="line">       getRunQueue().executeActions(mAttachInfo.mHandler);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//  第一次绘执行performTravelsal  mLayoutRequested = true    </span></span><br><span class="line">      <span class="comment">//  mStopped只有Acitivity Stop的时候才为true  </span></span><br><span class="line">      <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">      <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="comment">// 第一次测量：对整个视图树的测量，是确定window的大小</span></span><br><span class="line">            windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                    desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 第一次执行必然进入</span></span><br><span class="line">      <span class="keyword">if</span> (mFirst || windowShouldResize || viewVisibilityChanged || cutoutChanged || params != <span class="keyword">null</span>|| mForceNextWindowRelayout) &#123;</span><br><span class="line">          ...</span><br><span class="line">           <span class="comment">// 屏幕的宽高已经确定，但Window大小并不是应用层决定的，所有的服务都是系统服务WMS完成的，</span></span><br><span class="line">           <span class="comment">// 所以尺寸调整在relayoutWindow方法通知WMS，同时执行时我们的Window尺寸会从初识值变成固定值</span></span><br><span class="line">           relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);  </span><br><span class="line">          ... </span><br><span class="line">             updatedConfiguration = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// mStopped只有Acitivity Stop的时候才为true，所以activity启动状态下一定为true</span></span><br><span class="line">      <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                        (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);             <span class="comment">// updatedConfiguration 第一次进入时设置为true，可以进入</span></span><br><span class="line">                <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                        || mHeight != host.getMeasuredHeight() || dispatchApplyInsets ||</span><br><span class="line">                        updatedConfiguration) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                     <span class="comment">//第二次测量尺寸，这次是真正的测量， mDecorView 测量所有子View</span></span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                   ....</span><br><span class="line">                    layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ... </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//2. 视图树的布局过程 调用 DecorView的 performLayout 对View树进行布局，</span></span><br><span class="line">        <span class="comment">//这一步可以得到View真正的位置和大小</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment">// didLayout= true ，所以 triggerGlobalLayoutListener = true</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);          </span><br><span class="line">        <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">                || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">        <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">           <span class="comment">//调用子View的layout方法进行布局，布局完成后就能确定尺寸和位置了</span></span><br><span class="line">            performLayout(lp, mWidth, mHeight);</span><br><span class="line">					...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">if</span> (triggerGlobalLayoutListener) &#123;</span><br><span class="line">            mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">// 整个布局树已经完成，触发回调，这也是为什么这个回调会被推荐用来获取控件的大小</span></span><br><span class="line">          <span class="comment">// 因为用post的方法，在onResume中取，会在下一个消息序列获取宽和高</span></span><br><span class="line">          <span class="comment">// 而使用回调可以在同一个消息队列中获得宽和高</span></span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnGlobalLayout();</span><br><span class="line">        &#125;</span><br><span class="line">			 ...</span><br><span class="line">         <span class="comment">//3. 绘制过程 调用DecorView的performDraw()方法对View进行绘制</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">// isViewVisible若 = false 则不绘制</span></span><br><span class="line">        <span class="keyword">boolean</span> cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cancelDraw) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">					<span class="comment">// 大多数情况下都会走入 performDraw，API 29之前</span></span><br><span class="line">          <span class="comment">// 要判断SurfaceView是否是新创建的，</span></span><br><span class="line">          <span class="comment">// 若是新创建的，则在第二次调用performTraversals时才能调用performDraw</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 绘制过程不是直接调用DecorView的方法，重点是根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            performDraw();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 若因为某些原因没能成功执行 performDraw() </span></span><br><span class="line">          <span class="comment">// 测量，布局流程也不会重新执行一遍，只重新执行绘制 performMeasrue() ，performLayout()</span></span><br><span class="line">          <span class="comment">// 因为若是测量过 mLayoutRequested = true ，不会重新走测量/逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">                <span class="comment">// Try again</span></span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mContentCaptureEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">            notifyContentCatpureEvents();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = <span class="keyword">false</span>;          </span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">measureHierarchy</span><span class="params">(<span class="keyword">final</span> View host, <span class="keyword">final</span> WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Resources res, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowWidth, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 是否是一次成功的测量，默认false</span></span><br><span class="line">        <span class="keyword">boolean</span> goodMeasure = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">if</span> (!goodMeasure) &#123;</span><br><span class="line">          <span class="comment">// 传入布局，也就是window的宽高和布局参数传进去，也就是View中 onMeasure方法需要的</span></span><br><span class="line">            childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">          <span class="comment">// 第一次：测量大小，其实是测量window的大小，开始测量</span></span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">            ..</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开始测量  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// mView 也就是DecorView，执行measure方法，接下来一层一层的子View也会进行遍历，完成测量</span></span><br><span class="line">            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 获得测量参数  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> measureSpec;</span><br><span class="line">        <span class="keyword">switch</span> (rootDimension) &#123;</span><br><span class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</span><br><span class="line">            <span class="comment">// Window can&#x27;t resize. Force root view to be windowSize.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</span><br><span class="line">          ...</span><br><span class="line">        <span class="keyword">return</span> measureSpec;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 布局过程</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="keyword">final</span> View host = mView;</span><br><span class="line">        ... <span class="comment">// 调用 decorView和所有子View的 layout 进行布局</span></span><br><span class="line">            host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">           ...</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 绘制过程</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">          <span class="comment">// 根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;</span><br><span class="line">              ...</span><br><span class="line">                <span class="comment">// 硬件绘制 draw() 方法</span></span><br><span class="line">                mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ...</span><br><span class="line">								<span class="comment">// 软件绘制 draw() 方法</span></span><br><span class="line">                <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset,</span><br><span class="line">                        scalingRequired, dirty, surfaceInsets)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> scalingRequired, Rect dirty, Rect surfaceInsets)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">						<span class="comment">// 软件绘制</span></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line">           ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;      </span><br><span class="line">      </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h2 id="View-class"><a href="#View-class" class="headerlink" title="View.class"></a>View.class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@UiThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">Drawable</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span></span><br><span class="line"><span class="class">        <span class="title">AccessibilityEventSource</span> </span>&#123;	</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    AttachInfo mAttachInfo;  </span><br><span class="line">    <span class="keyword">final</span> Handler mHandler;          </span><br><span class="line">    <span class="comment">// 设置View的Parent      </span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">assignParent</span><span class="params">(ViewParent parent)</span> </span>&#123;</span><br><span class="line">		  </span><br><span class="line">    		<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">   		     mParent = parent;</span><br><span class="line">    		&#125; ..</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">	</span><br><span class="line">		<span class="comment">// 建立View和Window之间的依赖</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchAttachedToWindow</span><span class="params">(AttachInfo info, <span class="keyword">int</span> visibility)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// AttachInfo是ViewRootImpl传入的，我们可以用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">        mAttachInfo = info;</span><br><span class="line">				...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 系统自带方法也是用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAttachedToWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAttachInfo != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切换线程需要借助handler，handler是随着AttachInfo传来的</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">        <span class="comment">// 有时发生崩溃了，但是View仍然被创建出来了，Handler就是空的，此时post不会立刻发送Runnable</span></span><br><span class="line">        <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> attachInfo.mHandler.post(action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若发生崩溃，attachInfo = null ，先把Runnable存到一个队列当中</span></span><br><span class="line">        getRunQueue().post(action);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mHandler是创建AttachInfo对象时构造函数传来的，而AttachInfo对象是ViewRootImpl构造函数中创建的</span></span><br><span class="line">          </span><br><span class="line">    AttachInfo(IWindowSession session, IWindow window, Display display,</span><br><span class="line">                ViewRootImpl viewRootImpl, Handler handler, Callbacks effectPlayer,</span><br><span class="line">                Context context) &#123;</span><br><span class="line">            ...</span><br><span class="line">            mViewRootImpl = viewRootImpl;</span><br><span class="line">            mHandler = handler;</span><br><span class="line">            ...</span><br><span class="line">        &#125;  </span><br><span class="line">    <span class="comment">// 表示正在布局中，防止重复布局的措施      </span></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">         <span class="comment">// 表示正在布局的flag，在layout中才会消除掉</span></span><br><span class="line">        mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据flag确定View是否处于布局过程中      </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLayoutRequested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line">    &#125;          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">     ....</span><br><span class="line">			<span class="comment">// 重置标志位</span></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">      <span class="comment">// 判断是否已经在布局中，若正在布局中，则不会往上层调用 requestLayout()</span></span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">            mParent.requestLayout();</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WindowManagerImpl，WindowManager，WIndowManagerGlobal"><a href="#WindowManagerImpl，WindowManager，WIndowManagerGlobal" class="headerlink" title="WindowManagerImpl，WindowManager，WIndowManagerGlobal"></a>WindowManagerImpl，WindowManager，WIndowManagerGlobal</h2><p>每个Acitivty 都有一个WIndowManager对象，一个程序可能有很多歌WIndowManagerImpl，不同Manager都会把操作转交给WindowManagerGlobal，这样以后想做统一操作在Global中操作非常简单</p>
<h3 id="WindowManagerGlobal"><a href="#WindowManagerGlobal" class="headerlink" title="WindowManagerGlobal"></a>WindowManagerGlobal</h3><p>记录所有的View和ViewRootImpl 这个类是隐藏的，可以得到</p>
<p>Activity在生命周期中能拿到Global，而Dialog没有生命周期，只能用反射拿到所有底层View和所有属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerGlobal</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 记录所有的View和ViewRootImpl，布局参数</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;ViewRootImpl&gt;();    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;WindowManager.LayoutParams&gt;();		</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">      ViewRootImpl root;</span><br><span class="line">       <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);	</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 每次创建后都会存储View，ViewRootImpl和各种参数</span></span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">      <span class="comment">// 和Windows的布局参数是统一的</span></span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 关键 调用 ViewRootImpl的setView方法</span></span><br><span class="line">      root.setView(view, wparams, panelParentView, userId);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WindowManagerImpl"><a href="#WindowManagerImpl" class="headerlink" title="WindowManagerImpl"></a>WindowManagerImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h4 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h4><p>Activity 的成员变量，是一个接口继承了ViewManager，实际上使用的实例是WindowManagerImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemService(Context.WINDOW_SERVICE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowManager</span> <span class="keyword">extends</span> <span class="title">ViewManager</span> </span>&#123;</span><br><span class="line">  	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ViewManager"><a href="#ViewManager" class="headerlink" title="ViewManager"></a>ViewManager</h4><p>只是一个接口 ActivityThread 中 有使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title">WindowManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">// global是个单例对象</span></span><br><span class="line">	 <span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br><span class="line">  </span><br><span class="line"> 		 <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">       <span class="comment">//add View 丢该global去做</span></span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="在子线程中更新-UI-不报错的几种方式"><a href="#在子线程中更新-UI-不报错的几种方式" class="headerlink" title="在子线程中更新 UI 不报错的几种方式"></a>在子线程中更新 UI 不报错的几种方式</h2><p>子线程更新UI不一定会报错</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">requestWindowFeature(Window.FEATURE_NO_TITLE)</span><br><span class="line">setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">text = findViewById(R.id.text)</span><br><span class="line"><span class="comment">// 直接在子线程更新ui 不会崩溃</span></span><br><span class="line">thread &#123;</span><br><span class="line">    text.text = <span class="string">&quot;ok!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text.setOnClickListener(<span class="keyword">object</span>: View.OnClickListener &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        println(window.decorView.parent.toString())</span><br><span class="line">        <span class="comment">// 子线程更新 ui 会崩溃</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            text.text = <span class="string">&quot;onCreate!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>报错信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Process: com.hencoder.customviewdrawing, PID: 23675</span><br><span class="line">  android.view.ViewRootImpl<span class="variable">$CalledFromWrongThreadException</span>: Only the original thread that created a view hierarchy can touch its views.</span><br><span class="line">      at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:8825)</span><br><span class="line">      at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1535)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.widget.TextView.checkForRelayout(TextView.java:9762)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6326)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6154)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6106)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:31)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:26)</span><br><span class="line">      at kotlin.concurrent.ThreadsKt$thread$thread<span class="variable">$1</span>.run(Thread.kt:30)</span><br></pre></td></tr></table></figure>
<p>对应报错的位置则是View.requestLayout() 中一致调用到ViewRootImpl.requestLayout()</p>
<p>而ViewRootImpl是decorView的parentView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mMeasureCache != <span class="keyword">null</span>) mMeasureCache.clear();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// Only trigger request-during-layout logic if this is the view requesting it,</span></span><br><span class="line">           <span class="comment">// not the views in its parent hierarchy</span></span><br><span class="line">           ViewRootImpl viewRoot = getViewRootImpl();</span><br><span class="line">           <span class="keyword">if</span> (viewRoot != <span class="keyword">null</span> &amp;&amp; viewRoot.isInLayout()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">this</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">       mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line">			<span class="comment">// 若parent == null 根本不会调用  ViewRootImp.requestLayout()</span></span><br><span class="line">       <span class="comment">//  更不会调用  ViewRootImpl.checkThread();</span></span><br><span class="line">       <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">           mParent.requestLayout();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">this</span>) &#123;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="为什么子线程更新UI会报错？"><a href="#为什么子线程更新UI会报错？" class="headerlink" title="为什么子线程更新UI会报错？"></a>为什么子线程更新UI会报错？</h3><p>ViewRootImpl成为控件树最顶层DecorView的Parent时，这样才有可能更新UI的时候触发他的requestLayout(),</p>
<p>只有触发了requestLayout()才会调用它的检查线程方法checkThread()</p>
<h3 id="1-主线程申请成功后子线程申请"><a href="#1-主线程申请成功后子线程申请" class="headerlink" title="1.主线程申请成功后子线程申请"></a>1.主线程申请成功后子线程申请</h3><p>利用View 防止重复绘制的优化，先进行一次requestLayout()，第二次就会被忽略</p>
<p>若调用View 触发requestLayout()，会让整条View链的所有View 设置一个Flag：<code> mPrivateFlags |= PFLAG_FORCE_LAYOUT;</code>,表示正在布局，在layout的时候才会把它消除掉，</p>
<p>再次调用View的requestLayout()时，View会根据标志位判断，若标志位表示正在布局，则代表已经申请过requestLayout(），View不会再调用上层父布局的requestLayout()，这样就不会触发ViewRootImpl的线程检查</p>
<p>类似的，TextView里面</p>
<p>现在主线程调用setText，会触发 reqeustLayout()</p>
<p>子线程调用setText时，相当于连续触发reqeustLayout()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">     setTextInternal(text);<span class="comment">// 已经设置好文字了</span></span><br><span class="line">    <span class="keyword">if</span> (mLayout != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// mLayout 不为空，会触发requestLayout()</span></span><br><span class="line">        checkForRelayout();</span><br><span class="line">    &#125;   ....         </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ....  requestLayout(); ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> textview = findViewById&lt;TextView&gt;(R.id.textview)</span><br><span class="line"></span><br><span class="line">textview.setOnClickLitener &#123;</span><br><span class="line">  textView.text = <span class="string">&quot;Main&quot;</span> <span class="comment">// 或者    it.requestLayout()</span></span><br><span class="line">  tread &#123;</span><br><span class="line">    textview.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                             </p>
<h3 id="2-在子线程中创建-ViewRootImpl"><a href="#2-在子线程中创建-ViewRootImpl" class="headerlink" title="2. 在子线程中创建 ViewRootImpl"></a><strong>2.</strong> 在子线程中创建 ViewRootImpl</h3><p>ViewRootImpl检查线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line"> ... mThread = Thread.currentThread(); ...</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查线程使用的mThread 对象</span></span><br><span class="line">      <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>mThread对象是初始化时构建的，创建ViewRootImpl时所在的线程就是mThread所在的线程<br>ViewRootImpl是WindowManagerGlobal 调用addView()时创建的<br>由于WindowMangaerGlobal是隐藏类，我们可以通过WindowManager来做这件事 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">thread &#123;</span><br><span class="line">  <span class="comment">// ViewRootImpl 需要一个Handler（ ViewRootHandler），而Handler需要Looper，子线程没有Looper</span></span><br><span class="line">  Looper.prepare()</span><br><span class="line">  <span class="comment">// 在子线程中创建一个View</span></span><br><span class="line">  <span class="keyword">val</span> button = Button(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// 让它在子线程中创建一个ViewRootImpl，它最终会调用WindowManagerGlobal.addView()</span></span><br><span class="line">  windowManager.addView(button,WinowManager.LayoutParams())</span><br><span class="line">  button.setOnClickLitener &#123;</span><br><span class="line">    buttun.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span> : <span class="subst">$&#123;SystemClock.uptimeMillis()&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 只有Handler和Looper ，handler无法正常处理任务，还需要让Looper轮训起来</span></span><br><span class="line">  Looper.loop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="子线程弹Toast"><a href="#子线程弹Toast" class="headerlink" title="子线程弹Toast"></a>子线程弹Toast</h4><p>报错不同，但是同样可以通过代码前后增加<code>   Looper.prepare()</code>,<code>    Looper.loop()</code>解决</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210916223001494.png" alt="image-20210916223001494"></p>
<h3 id="3-利用硬件加速机制绕开-requestLayout"><a href="#3-利用硬件加速机制绕开-requestLayout" class="headerlink" title="3. 利用硬件加速机制绕开 requestLayout()"></a>3. 利用硬件加速机制绕开 requestLayout()</h3><p>在硬件加速的支持下，如果控件只是经常了 invalidate() ，而没有触发requestLayout() 是不会触发。ViewRootImpl的checkThread() 的。</p>
<p>子View会依赖父ViewGroup的invalidate()实现，而作为最顶层的ViewRootImpl，它的invalidate()方法会直接调用scheduleTraversals();绘制图形，而不像requestLayout() 在调用scheduleTraversals()之前要chekThread</p>
<p>TextView.setView()会调用  checkForRelayout() 方法，宽度不变或者宽高都不变则只会调用invalidate();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">      checkForRelayout() </span><br><span class="line">   &#125;    </span><br><span class="line"></span><br><span class="line">	<span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 判断宽度是不是固定/不变的</span></span><br><span class="line">       <span class="keyword">if</span> ((mLayoutParams.width != LayoutParams.WRAP_CONTENT</span><br><span class="line">               || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))</span><br><span class="line">               &amp;&amp; (mHint == <span class="keyword">null</span> || mHintLayout != <span class="keyword">null</span>)</span><br><span class="line">               &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">           makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,</span><br><span class="line">                         mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(), <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mEllipsize != TextUtils.TruncateAt.MARQUEE) &#123;</span><br><span class="line">               <span class="comment">// In a fixed-height view, so use our new text layout.</span></span><br><span class="line">               <span class="keyword">if</span> (mLayoutParams.height != LayoutParams.WRAP_CONTENT</span><br><span class="line">                       &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 高度是不是和以前一样/固定的</span></span><br><span class="line">               <span class="keyword">if</span> (mLayout.getHeight() == oldht</span><br><span class="line">                       &amp;&amp; (mHintLayout == <span class="keyword">null</span> || mHintLayout.getHeight() == oldht)) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                 <span class="comment">// 只调用invalidate()</span></span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 同时调用  invalidate 和 requestLayout</span></span><br><span class="line">           requestLayout();</span><br><span class="line">           invalidate();</span><br><span class="line">       &#125; 。。。</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       invalidate(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">       invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 的最终调用</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">         </span></span></span><br><span class="line"><span class="function"><span class="params">     ...</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">final</span> ViewParent p = mParent;</span></span></span><br><span class="line"><span class="function"><span class="params">          ...</span></span></span><br><span class="line"><span class="function"><span class="params">               // 父ViewGroup的  invalidateChild ，传入自身          </span></span></span><br><span class="line"><span class="function"><span class="params">               p.invalidateChild(<span class="keyword">this</span>, damage)</span></span>;</span><br><span class="line">          ...</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ViewGroup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span> &amp;&amp; attachInfo.mHardwareAccelerated) &#123;</span><br><span class="line">        <span class="comment">// 如果是硬件加速，则进入硬件加速捷径</span></span><br><span class="line">        onDescendantInvalidated(child, child);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View target)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//一致调用它的parent的方法，最顶层为ViewRootImpl</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParent.onDescendantInvalidated(<span class="keyword">this</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewRootImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View descendant)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 直接调用了 invalidate</span></span><br><span class="line">      invalidate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      mDirty.set(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</span><br><span class="line">      <span class="keyword">if</span> (!mWillDrawSoon) &#123;</span><br><span class="line">        <span class="comment">// 直接绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">      <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">          <span class="comment">// 检查线程</span></span><br><span class="line">          checkThread();</span><br><span class="line">          mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">          <span class="comment">// 绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-SurfaceView"><a href="#4-SurfaceView" class="headerlink" title="4.SurfaceView"></a>4.SurfaceView</h3><p>Android 中有一个控件 SurfaceView ，它可以通过 holder 获得 Canvas 对象， 可以直接在子线程中更新 UI。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">自定义view布局01:布局流程完全解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-06 17:53:02" itemprop="dateCreated datePublished" datetime="2021-09-06T17:53:02+08:00">2021-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-07 17:50:59" itemprop="dateModified" datetime="2021-09-07T17:50:59+08:00">2021-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="布局流程完全解析"><a href="#布局流程完全解析" class="headerlink" title="布局流程完全解析"></a>布局流程完全解析</h1><h2 id="布局过程"><a href="#布局过程" class="headerlink" title="布局过程"></a>布局过程</h2><p>确定每个 View 的位置和尺寸 </p>
<p>作用: 为<strong>绘制</strong>和<strong>触摸范围</strong>做支持</p>
<ul>
<li><strong>绘制</strong>: 知道往哪里绘制</li>
<li><strong>触摸反馈</strong>: 知道用户点的是哪里</li>
</ul>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="从整体看"><a href="#从整体看" class="headerlink" title="从整体看"></a>从整体看</h3><ul>
<li>测量流程:从根 View 递归调用每一级子 View 的 measure() 方法，对它们进行测量</li>
<li>布局流程:从根 View 递归调用每一级子 View 的 layout() 方法，把测量过程得 出的子 View 的位置和尺寸传给子 View，子 View 保存</li>
</ul>
<p>View onLayout是空方法</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907111935951.png" alt="image-20210907111935951" style="zoom: 67%;">

<p>View Group需要处理子View的布局</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907112056602.png" alt="image-20210907112056602"></p>
<h4 id="为什么要分两个流程"><a href="#为什么要分两个流程" class="headerlink" title="为什么要分两个流程?"></a>为什么要分两个流程?</h4><p>因为可能会重复测量</p>
<p>测量是一个动态的过程我们要测量多个子View ，有些子View可能要测量多次</p>
<p>比如下面的例子第一个子View是 match_parent ，第一次测量是没有结果的，需要两次测量，把测量/布局分成两个流程，可以让布局只使用最后保存的生效的数值，提高效率</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210906175625735.png" alt="image-20210906175625735"></p>
<h3 id="从个体看对于每个View"><a href="#从个体看对于每个View" class="headerlink" title="从个体看对于每个View"></a>从个体看对于每个View</h3><ol>
<li><p>运行前，开发者在 xml 文件里写入对 View 的布局要求 layout_xxx</p>
</li>
<li><p>父 View 在自己的 onMeasure() 中，根据开发者在 xml 中写的对子 View 的要 求，和自己的可用空间，得出对子 View 的具体尺寸要求（结合上一步开发者写入的 layout_xxx和父View的可用空间计算）</p>
<p> <img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907110500303.png" alt="image-20210907110500303"></p>
</li>
<li><p>子 View 在自己的 onMeasure() 中，根据父 View 的要求和自己的特性算出自己 的期望尺寸</p>
<ul>
<li>如果是 ViewGroup，还会在这里调用每个子 View 的 measure() 进行测量</li>
</ul>
</li>
<li><p>父 View 在子 View 计算出期望尺寸后，得出子 View 的实际尺寸和位置</p>
</li>
<li><p>子 View 在自己的 layout() 方法中，将父 View 传进来的自己的实际尺寸和位置 保存</p>
<ul>
<li>如果是 ViewGroup，还会在 onLayout() 里调用每个子 View 的 layout() 把 它们的尺寸位置传给它们</li>
</ul>
</li>
</ol>
<h2 id="自定义布局"><a href="#自定义布局" class="headerlink" title="自定义布局"></a>自定义布局</h2><p>具体实现方式：</p>
<ul>
<li>继承已有View，简单修改它们的尺寸：重写 onMeasure()<ul>
<li>SquareImageView 方形view</li>
</ul>
</li>
<li>对自定义View完全进行自定义运算：重写onMeasure()<ul>
<li>CircleView 圆形view，外部根据内部图形设定宽高</li>
</ul>
</li>
<li>自定义Layout：重写omMeasure()和onLayout()<ul>
<li>TagLayout 标签布局（Android的flex-box 类似）</li>
</ul>
</li>
</ul>
<h3 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h3><h4 id="自定义View方式一：简单改写已有View的尺寸"><a href="#自定义View方式一：简单改写已有View的尺寸" class="headerlink" title="自定义View方式一：简单改写已有View的尺寸"></a>自定义View方式一：简单改写已有View的尺寸</h4><ol>
<li><p>重写onMeasure()</p>
</li>
<li><p>用getMeasuredWidth()和getMeasuredHeight()获取到测量出的尺寸</p>
</li>
<li><p>计算出最终要的尺寸</p>
</li>
<li><p>用setOnMeasuredDimension(width, height)把结果保存</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareImageView</span></span>(context: Context?, attrs: AttributeSet?) : AppCompatImageView(context, attrs) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">		<span class="comment">// 使用系统计算过的宽&amp;高，计算比较小的那个</span></span><br><span class="line">    <span class="keyword">val</span> size = min(measuredWidth, measuredHeight)</span><br><span class="line">    <span class="comment">// 存储宽高，并非作为返回值给父类，而是使用时自己或父类去拿</span></span><br><span class="line">    setMeasuredDimension(size, size)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="重写layout也能改写尺寸，为什么要重写onMeaSure"><a href="#重写layout也能改写尺寸，为什么要重写onMeaSure" class="headerlink" title="重写layout也能改写尺寸，为什么要重写onMeaSure"></a>重写layout也能改写尺寸，为什么要重写onMeaSure</h4><p>若直接重写layout的确能改写尺寸，但是父View是不知道你的改动的，会造成位置错误</p>
<p>Eg</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;com.hencoder.layoutsize.view.SquareImageView</span><br><span class="line">        android:layout_width=&quot;300dp&quot;</span><br><span class="line">        android:layout_height=&quot;200dp&quot;</span><br><span class="line">        android:src=&quot;@drawable/avatar_rengwuxian&quot;</span><br><span class="line">         /&gt;</span><br><span class="line">    &lt;View</span><br><span class="line">        android:layout_width=&quot;200dp&quot;</span><br><span class="line">        android:layout_height=&quot;200dp&quot;</span><br><span class="line">        android:background=&quot;@color/purple_200&quot;/&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于Android系统你的布局应该是这样的</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907085754293.png" alt="image-20210907085754293"></p>
<p>若在layout中修改了尺寸，但系统不知道你的修改，结果就是：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareImageView</span></span>(context: Context?, attrs: AttributeSet?) : AppCompatImageView(context, attrs) &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">layout</span><span class="params">(l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> width = r - l</span><br><span class="line">    <span class="keyword">val</span> height = b - t</span><br><span class="line">    <span class="keyword">val</span> size = min(width,height)</span><br><span class="line">    <span class="keyword">super</span>.layout(l, t, l+size, t+size)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907085940819.png" alt="image-20210907085940819"></p>
<h4 id="测量尺寸的方法"><a href="#测量尺寸的方法" class="headerlink" title="测量尺寸的方法"></a>测量尺寸的方法</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">getMeasuredHeight() <span class="comment">// 测量期望尺寸 高</span></span><br><span class="line">getMeasuredWidth()  <span class="comment">// 测量期望尺寸 宽</span></span><br><span class="line">getHeight() <span class="comment">// 测量实际尺寸 高</span></span><br><span class="line">getWidth() <span class="comment">// 测量实际尺寸 宽</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//  View.class 中  getWidth() ，getHeight() 能获得View实际应用的值</span></span><br><span class="line"> </span><br><span class="line">  <span class="meta">@ViewDebug</span>.ExportedProperty(category = <span class="string">&quot;layout&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> int getWidth() &#123;</span><br><span class="line">        <span class="keyword">return</span> mRight - mLeft;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@ViewDebug</span>.ExportedProperty(category = <span class="string">&quot;layout&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> int getHeight() &#123;</span><br><span class="line">        <span class="keyword">return</span> mBottom - mTop;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getMeasuredHeight/Width方法获得的是期望的值，可能会被父类修改未必准确，测量过程中能拿到</li>
<li>getHeight/Width方法获得的是布局实际应用的宽高，但是在测量过程中拿不到</li>
</ul>
<blockquote>
<p>有时用getHeight/Width 获得了宽高值，此时View却进行了刷新导致宽高变化，获得的值还是上一轮的</p>
<p>而每次刷新getMeasuredHeight/Width会重新计算，虽然不一定是最后应用的但更实时</p>
<p><strong>所以测量过程中我们有时只能使用getMeasuredHeight/Width ()，其他时候使用getHeight/Width</strong></p>
</blockquote>
<h4 id="自定义View方式二：完全自定义View的尺寸"><a href="#自定义View方式二：完全自定义View的尺寸" class="headerlink" title="自定义View方式二：完全自定义View的尺寸"></a>自定义View方式二：完全自定义View的尺寸</h4><ol>
<li><p>重写onMeasure()</p>
</li>
<li><p>计算出自己的尺寸</p>
</li>
<li><p>用resolveSize() / resolveSizeAndState() 修正结果</p>
</li>
<li><p>使用setMeasuredDimension(width,height) 保存结果</p>
</li>
</ol>
<p>不重写onMeasure()</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 半径</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> RADIUS = <span class="number">100.</span>dp</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> PADDING = <span class="number">100.</span>dp</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">  <span class="meta">@RequiresApi(Build.VERSION_CODES.M)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">    color = getContext().getColor(R.color.purple_200)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequiresApi(Build.VERSION_CODES.M)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line"></span><br><span class="line">    canvas.drawCircle(PADDING + RADIUS, PADDING + RADIUS, RADIUS, paint)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;com.hencoder.layoutsize.view.CircleView</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:src=&quot;@drawable/avatar_rengwuxian&quot;</span><br><span class="line">        android:background=&quot;@color/teal_200&quot;</span><br><span class="line">         /&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>View 默认会填充整个屏幕</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907101823266.png" alt="image-20210907101823266"></p>
<p>重写onMeasure方法指定定View的尺寸</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 重写View的宽高</span></span><br><span class="line">  <span class="keyword">val</span> size = ((PADDING + RADIUS) * <span class="number">2</span>).toInt()</span><br><span class="line">  <span class="comment">// 考虑父View的宽高建议 ： widthMeasureSpec: Int, heightMeasureSpec: Int</span></span><br><span class="line">  <span class="keyword">val</span> width = resolveSize(size, widthMeasureSpec)</span><br><span class="line">  <span class="keyword">val</span> height = resolveSize(size, heightMeasureSpec)</span><br><span class="line">  setMeasuredDimension(width, height)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xml ：View不会再填充整个屏幕：</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907102042312.png" alt="image-20210907102042312"></p>
<h4 id="父View的宽高建议"><a href="#父View的宽高建议" class="headerlink" title="父View的宽高建议"></a>父View的宽高建议</h4><p> onMeasure方法的两个参数 widthMeasureSpec，heightMeasureSpec是父View的宽高建议</p>
<p>有三种模式：</p>
<ol>
<li>不超过指定宽高 MeasureSpec.AT_MOST</li>
<li>精确指定宽高 MeasureSpec.EXACTLY</li>
<li>不限制 MeasureSpec.UNSPECIFIED</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> size = ((PADDING + RADIUS) * <span class="number">2</span>).toInt()</span><br><span class="line">  <span class="comment">// 获得限制宽/高的模式 ：MeasureSpec.getMode</span></span><br><span class="line">  <span class="keyword">val</span> specWidthMode = MeasureSpec.getMode(widthMeasureSpec)</span><br><span class="line">  <span class="comment">// 若模式是不限制，就可以无视了，若有限制，需要获得精确的值/限制的值，通过getSize拿到</span></span><br><span class="line">  <span class="keyword">val</span> specWidthSize = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">  <span class="keyword">var</span> width = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (MeasureSpec.EXACTLY == specWidthMode)&#123;</span><br><span class="line">    <span class="comment">// 精确模式</span></span><br><span class="line">    width = specWidthSize</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (MeasureSpec.AT_MOST == specWidthMode)&#123;</span><br><span class="line">    <span class="comment">// 最大值限制</span></span><br><span class="line">    width = <span class="keyword">if</span> (size &gt; widthMeasureSpec) widthMeasureSpec <span class="keyword">else</span> size</span><br><span class="line"></span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (MeasureSpec.UNSPECIFIED == specWidthMode) &#123;</span><br><span class="line">    <span class="comment">//无限制</span></span><br><span class="line">    width = size</span><br><span class="line">  &#125;</span><br><span class="line">  setMeasuredDimension(width, size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="resolveSize和resolveSizeAndState和"><a href="#resolveSize和resolveSizeAndState和" class="headerlink" title="resolveSize和resolveSizeAndState和"></a>resolveSize和resolveSizeAndState和</h4><p>父View的宽高限制/建议都是固定逻辑，系统已经有方法处理这套逻辑了</p>
<p>resolveSize：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> width = resolveSize(size, widthMeasureSpec)</span><br><span class="line"><span class="keyword">val</span> height = resolveSize(size, heightMeasureSpec)</span><br></pre></td></tr></table></figure>
<p>resolveSizeAndState和resolveSize的区别在于，当测量模式是AT_MOST进行最大值限制的时候，若测量的值超出了最大值限制，会上报给父view一个MEASURED_STATE_TOO_SMALL的值表达空间不足，然而在实际应用中一般不会去读这个值，所以一遍都用resovleSize()方法处理</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static int resolveSizeAndState(int size, int measureSpec, int childMeasuredState) &#123;</span><br><span class="line">    <span class="keyword">final</span> int specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> int specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> int result;</span><br><span class="line">    switch (specMode) &#123;</span><br><span class="line">        case MeasureSpec.AT_MOST:</span><br><span class="line">            <span class="keyword">if</span> (specSize &lt; size) &#123;</span><br><span class="line">                result = specSize | MEASURED_STATE_TOO_SMALL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case MeasureSpec.EXACTLY:</span><br><span class="line">            result = specSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case MeasureSpec.UNSPECIFIED:</span><br><span class="line">        default:</span><br><span class="line">            result = size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result | (childMeasuredState &amp; MEASURED_STATE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义Layout-ViewGroup"><a href="#自定义Layout-ViewGroup" class="headerlink" title="自定义Layout(ViewGroup)"></a>自定义Layout(ViewGroup)</h3><ul>
<li>重写 onMeasure()<ul>
<li>遍历每个子 View，测量子 View<ul>
<li>测量完成后，得出子 View 的实际位置和尺寸，并暂时保存</li>
<li>有些子 View 可能需要重新测量</li>
</ul>
</li>
<li> 测量出所有子 View 的位置和尺寸后，计算出自己的尺寸，并用 setMeasuredDimension(width, height) 保存</li>
</ul>
</li>
<li>重写 onLayout()<ul>
<li>遍历每个子 View，调用它们的 layout() 方法来将位置和尺寸传给它们</li>
</ul>
</li>
</ul>
<p>Eg：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagLayout</span></span>(context: Context?, attrs: AttributeSet?) : ViewGroup(context, attrs) &#123;</span><br><span class="line">  <span class="comment">// 存储每个子View的尺寸位置</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> childrenBounds = mutableListOf&lt;Rect&gt;()</span><br><span class="line">  <span class="comment">// 重写 onMeasure()</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 记录已用的宽度</span></span><br><span class="line">    <span class="keyword">var</span> widthUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 记录已用高度</span></span><br><span class="line">    <span class="keyword">var</span> heightUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 单行 已用 宽度</span></span><br><span class="line">    <span class="keyword">var</span> lineWidthUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 单行最大高度</span></span><br><span class="line">    <span class="keyword">var</span> lineMaxHeight = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 获得父类限制的宽度</span></span><br><span class="line">    <span class="keyword">val</span> specWidthSize = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">    <span class="comment">// 获得父类的尺寸限制模式 ，有三种 UNSPECIFIED无限制 ，EXACTLY精确，AT_MOST不能超过限制的最大值</span></span><br><span class="line">    <span class="keyword">val</span> specWidthMode = MeasureSpec.getMode(widthMeasureSpec)</span><br><span class="line">    <span class="comment">//1. 遍历每个子 View，测量子 View</span></span><br><span class="line">    <span class="keyword">for</span> ((index, child) <span class="keyword">in</span> children.withIndex()) &#123;</span><br><span class="line">      <span class="comment">// 调用 子View的 mseasure方法测量View的尺寸和位置</span></span><br><span class="line">      <span class="comment">// 需要传递宽高限制 widthMeasureSpec，heightMeasureSpec，已经用的宽度/高度</span></span><br><span class="line">      <span class="comment">// 这个通用方法，原则上只要不超过父类的宽高可以随意设置</span></span><br><span class="line">      measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, heightUsed)</span><br><span class="line">      <span class="comment">// 换行：父View的尺寸限制模式 不是无限制 且 已用宽度加上这个子View的测量宽度 超过父类限制的最大值</span></span><br><span class="line">      <span class="keyword">if</span> (specWidthMode != MeasureSpec.UNSPECIFIED &amp;&amp;</span><br><span class="line">        lineWidthUsed + child.measuredWidth &gt; specWidthSize) &#123;</span><br><span class="line">        <span class="comment">// 换行 行的最大高度/行的已有宽度都要归零</span></span><br><span class="line">        lineWidthUsed = <span class="number">0</span></span><br><span class="line">        <span class="comment">// 存储当前的行最大高度，得到已用高度</span></span><br><span class="line">        heightUsed += lineMaxHeight</span><br><span class="line">        lineMaxHeight = <span class="number">0</span></span><br><span class="line">        <span class="comment">// 给子View测量位置/尺寸</span></span><br><span class="line">        measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, heightUsed)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 2. 测量量完成后，得出子 View 的实际位置和尺寸，并暂时保存</span></span><br><span class="line">      <span class="keyword">if</span> (index &gt;= childrenBounds.size) &#123;</span><br><span class="line">        childrenBounds.add(Rect())</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 拿到用于存储的Rect 对象</span></span><br><span class="line">      <span class="keyword">val</span> childBounds = childrenBounds[index]</span><br><span class="line">      <span class="comment">// 对Rect 对象修改，暂时存储具体的位置，尺寸</span></span><br><span class="line">      childBounds.<span class="keyword">set</span>(lineWidthUsed, heightUsed, lineWidthUsed + child.measuredWidth, heightUsed + child.measuredHeight)</span><br><span class="line">      <span class="comment">// 记录子view已用宽度</span></span><br><span class="line">      lineWidthUsed += child.measuredWidth</span><br><span class="line">      <span class="comment">// 计算 当前行宽度是否超过已用宽度</span></span><br><span class="line">      widthUsed = max(widthUsed, lineWidthUsed)</span><br><span class="line">      <span class="comment">// 计算当前子View的高度是否超过 之前其他行的最大高度</span></span><br><span class="line">      lineMaxHeight = max(lineMaxHeight, child.measuredHeight)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 算出自己的尺寸 宽度，高度</span></span><br><span class="line">    <span class="comment">// 宽度就是已用宽度度</span></span><br><span class="line">    <span class="keyword">val</span> selfWidth = widthUsed</span><br><span class="line">    <span class="comment">// 高度使用已用高度+本行最大行高（只有换行时存储上一行的行高到 heightUsed，所以这里要+本行行高）</span></span><br><span class="line">    <span class="keyword">val</span> selfHeight = heightUsed + lineMaxHeight</span><br><span class="line">    <span class="comment">// 应用计算出来的自身尺寸</span></span><br><span class="line">    setMeasuredDimension(selfWidth, selfHeight)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 重写 onLayout()</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//3. 遍历每个子 View，调用它们的 layout() 方法来将位置和尺寸传给它们</span></span><br><span class="line">    <span class="keyword">for</span> ((index, child) <span class="keyword">in</span> children.withIndex()) &#123;</span><br><span class="line">      <span class="comment">// 取出存储的每个子View的尺寸，位置信息</span></span><br><span class="line">      <span class="keyword">val</span> childBounds = childrenBounds[index]</span><br><span class="line">      <span class="comment">// 调用子View的layout ()  传递存储的信息</span></span><br><span class="line">      child.layout(childBounds.left, childBounds.top, childBounds.right, childBounds.bottom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">generateLayoutParams</span><span class="params">(attrs: <span class="type">AttributeSet</span>?)</span></span>: LayoutParams &#123;</span><br><span class="line">    <span class="keyword">return</span> MarginLayoutParams(context, attrs)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907163741810.png" alt="image-20210907163741810" style="zoom:67%;">

<h4 id="measureChildWithMargins"><a href="#measureChildWithMargins" class="headerlink" title="measureChildWithMargins"></a>measureChildWithMargins</h4><p>ViewGroup设置子VIew的尺寸/位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//  child： 具体设置的子View对象</span></span><br><span class="line">  <span class="comment">//  parentWidthMeasureSpec ：父View的宽</span></span><br><span class="line">  <span class="comment">//  widthUsed： 已用宽度</span></span><br><span class="line">  <span class="comment">//  parentHeightMeasureSpec： 父View的高</span></span><br><span class="line">  <span class="comment">//  heightUsed： 已用高度</span></span><br><span class="line">       <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">               mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</span><br><span class="line">                       + widthUsed, lp.width);</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">               mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</span><br><span class="line">                       + heightUsed, lp.height);</span><br><span class="line"></span><br><span class="line">       child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="getChildMeasureSpec"><a href="#getChildMeasureSpec" class="headerlink" title="getChildMeasureSpec"></a>getChildMeasureSpec</h4><p>根据父View的尺寸/限制模式，padding等信息获得子View尺寸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size. So be it.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.</span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... let him have it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size... find out how big it should</span></span><br><span class="line">            <span class="comment">// be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size.... find out how</span></span><br><span class="line">            <span class="comment">// big it should be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/26/RxJava3%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/26/RxJava3%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">RxJava3原理解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-26 16:40:47" itemprop="dateCreated datePublished" datetime="2021-08-26T16:40:47+08:00">2021-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-06 01:57:15" itemprop="dateModified" datetime="2021-09-06T01:57:15+08:00">2021-09-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/RxJava3/" itemprop="url" rel="index"><span itemprop="name">RxJava3</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RxJava-3-的原理完全解析"><a href="#RxJava-3-的原理完全解析" class="headerlink" title="RxJava 3 的原理完全解析"></a>RxJava 3 的原理完全解析</h1><h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">				<span class="meta">@GET(<span class="meta-string">&quot;users/&#123;username&#125;/repos&quot;</span>)</span></span><br><span class="line">			  <span class="comment">// Observable和Flow都过重，网络请求 推荐single</span></span><br><span class="line">				<span class="function"><span class="keyword">fun</span> <span class="title">getRepos</span><span class="params">(<span class="meta">@Path(<span class="meta-string">&quot;username&quot;</span>)</span> username: <span class="type">String</span>)</span></span>: Single&lt;List&lt;Repo&gt;&gt;</span><br><span class="line">...</span><br><span class="line">        api.getRepos(<span class="string">&quot;rengwuxian&quot;</span>)</span><br><span class="line">            .subscribeOn(Schedulers.io())<span class="comment">//请求切换到io线程</span></span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 回调在主线程</span></span><br><span class="line">            .subscribe(<span class="keyword">object</span> : SingleObserver&lt;MutableList&lt;Repo&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(repos: <span class="type">MutableList</span>&lt;<span class="type">Repo</span>&gt;)</span></span> &#123;</span><br><span class="line">                    textView.text = <span class="string">&quot;Result :<span class="subst">$&#123;repos!![<span class="number">0</span>].name&#125;</span>&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSubscribe</span><span class="params">(d: <span class="type">Disposable</span>?)</span></span> &#123;</span><br><span class="line">                    <span class="comment">// 订阅产生之后就会回调（网络请求之前）所以适合初始化</span></span><br><span class="line">                    <span class="comment">// dispose 丢弃，一般使用时会通知上游停止生产</span></span><br><span class="line">                    textView.text = <span class="string">&quot;正在请求&quot;</span></span><br><span class="line">                    disposeable = d</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">                    textView.text = e.message ?: e.javaClass.name</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h2><p>RxJava 的整体结构是一条链，其中:</p>
<ol>
<li>链的最上游:生产者 Observable</li>
<li>链的最下游:观察者 Observer</li>
<li>链的中间:各个中介节点，既是下游的 Observable，又是上游的 Observer</li>
</ol>
<h2 id="创建："><a href="#创建：" class="headerlink" title="创建："></a>创建：</h2><p>Single 为例:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">val</span> single = Single.just(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"> single.subscribe(<span class="keyword">object</span> : SingleObserver&lt;String?&gt; &#123;</span><br><span class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(t: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">       textView.text = t</span><br><span class="line">  &#125;</span><br><span class="line">        ...</span><br><span class="line"> &#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Single</span>&lt;<span class="type">@NonNull T</span>&gt; <span class="title">implements</span> <span class="title">SingleSource</span>&lt;<span class="type">T</span>&gt; </span>&#123; </span><br><span class="line"> 	</span><br><span class="line">  <span class="keyword">public</span> static &lt;<span class="meta">@NonNull</span> T&gt; Single&lt;T&gt; just(T item) &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="comment">// 钩子函数，重点在于传入了SingleJust实例</span></span><br><span class="line">        <span class="keyword">return</span> RxJavaPlugins.onAssembly(new SingleJust&lt;&gt;(item));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> void subscribe(<span class="meta">@NonNull</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">       </span><br><span class="line">				<span class="comment">// 钩子函数，</span></span><br><span class="line">        observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重点方法</span></span><br><span class="line">            subscribeActual(observer);</span><br><span class="line">        &#125; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>SingleJust:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleJust</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleJust(T value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">      <span class="comment">// Disposable.disposed 表示已经被丢弃</span></span><br><span class="line">      <span class="comment">// singlejust是立刻执行后取消的任务，所以可以直接取消</span></span><br><span class="line">        observer.onSubscribe(Disposable.disposed());</span><br><span class="line">      <span class="comment">// 成功，将内部存储的对象传过去也就是Single.just(&quot;1&quot;)中传的1</span></span><br><span class="line">        observer.onSuccess(value);</span><br><span class="line">      <span class="comment">// 没有onError 因为它是不可能失败的，把一个准备好的对象传过去是不会失败的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174653269.png" alt="image-20210826174653269"></p>
<h2 id="操作符-Operator-map-等等"><a href="#操作符-Operator-map-等等" class="headerlink" title="操作符 Operator(map() 等等):"></a>操作符 Operator(map() 等等):</h2><ol>
<li>基于原 Observable 创建一个新的 Observable</li>
<li>Observable 内部创建一个 Observer</li>
<li>通过定制 Observable 的 subscribeActual() 方法和 Observer 的 onSuccess() 方法，来实现自己的中介⻆色(例如数据转换、线程切换)</li>
</ol>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174752970.png" alt="image-20210826174752970"></p>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">operatorRx</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> single:Single&lt;<span class="built_in">Int</span>&gt; = Single.just(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> singleString = single.map(<span class="keyword">object</span> :Function&lt;<span class="built_in">Int</span>,String&gt;&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(t: <span class="type">Int</span>?)</span></span>: String &#123;</span><br><span class="line">            <span class="keyword">return</span>  t.toString()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Single.map方法：基于原 Observable 创建一个新的 Observable</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.NONE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;<span class="meta">@NonNull</span> R&gt; Single&lt;R&gt; map(<span class="meta">@NonNull</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">    Objects.requireNonNull(mapper, <span class="string">&quot;mapper is null&quot;</span>);</span><br><span class="line">    <span class="comment">//基于原 Observable 创建一个新的 Observable：创建一个SingleMap，将自己身和需要转换的操作符(map)</span></span><br><span class="line">    <span class="comment">//传过去</span></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(new SingleMap&lt;&gt;(<span class="keyword">this</span>, mapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SingleMap：Observable 内部创建一个 Observer</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleMap</span>&lt;<span class="type">T, R</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleMap(SingleSource&lt;? extends T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t) &#123;</span><br><span class="line">      <span class="comment">// 真正执行的代码，将会创建一个MapSingleObserver</span></span><br><span class="line">        source.subscribe(new MapSingleObserver&lt;T, R&gt;(t, mapper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapSingleObserver</span>&lt;<span class="type">T, R</span>&gt; <span class="title">implements</span> <span class="title">SingleObserver</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> R&gt; t, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">this</span>.t = t;</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">            t.onSubscribe(d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">            R v;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 若需要转换则使用传来的操作符接口进行转换</span></span><br><span class="line">                v = Objects.requireNonNull(mapper.apply(value), <span class="string">&quot;The mapper function returned a null value.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwIfFatal(e);</span><br><span class="line">                onError(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">						<span class="comment">//转换成功后传递给下游（最表面的观察者，也是开发者真正调用的那个接口回调）</span></span><br><span class="line">            t.onSuccess(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若再增加操作符也是一样的，只不过会增加更多的被观察者，观察者</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210827153255139.png" alt="image-20210827153255139"></p>
<h2 id="Disposable"><a href="#Disposable" class="headerlink" title="Disposable:"></a>Disposable:</h2><p>上游停止生产，上下游切断联系</p>
<p> 可以通过 dispose() 方法来让上游或内部调度器(或两者都有)停止工作，达到「丢弃」的效果。</p>
<blockquote>
<p> SingleJust，没有延迟没有后续，可以直接取消</p>
</blockquote>
<blockquote>
<p>总结：Disposable是一个桥接器，dispose时，先看这个生产者（被观察者）有没有来自上游的后续任务，有没有自己生产的后续任务（延时任务）停止工作。</p>
</blockquote>
<h3 id="有延迟的任务如何取消"><a href="#有延迟的任务如何取消" class="headerlink" title="有延迟的任务如何取消"></a>有延迟的任务如何取消</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延迟调用， ，每间隔一秒调用一次</span></span><br><span class="line">Observable.interval(<span class="number">0</span>,<span class="number">1</span>,TimeUnit.SECONDS)</span><br><span class="line">    .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 延迟发生在子线程，所以回调到主线程主线程</span></span><br><span class="line">    .subscribe(<span class="keyword">object</span>: Observer&lt;<span class="built_in">Long</span>?&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onComplete</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSubscribe</span><span class="params">(d: <span class="type">Disposable</span>?)</span></span> &#123; &#125;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onNext</span><span class="params">(t: <span class="type">Long</span>?)</span></span> &#123;</span><br><span class="line">            textView.text = t.toString()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Throwable</span>?)</span></span> &#123;&#125;&#125; )</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableInterval</span> <span class="title">extends</span> <span class="title">Observable</span>&lt;<span class="type">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> long initialDelay;</span><br><span class="line">    <span class="keyword">final</span> long period;</span><br><span class="line">    <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> <span class="built_in">Long</span>&gt; observer) &#123;</span><br><span class="line">       <span class="comment">//核心方法 实例化 IntervalObserver(下游的observer)</span></span><br><span class="line">        IntervalObserver <span class="keyword">is</span> = new IntervalObserver(observer);</span><br><span class="line">        ...</span><br><span class="line">      	<span class="keyword">if</span> (sch instanceof TrampolineScheduler) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在后台处理轮训任务，每次执行完毕都会调用  IntervalObserver（is）的run方法</span></span><br><span class="line">            Disposable d = sch.schedulePeriodicallyDirect(<span class="keyword">is</span>, initialDelay, period, unit);</span><br><span class="line">            <span class="keyword">is</span>.setResource(d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 没有继承Observer ,继承了一个可取消的disposable</span></span><br><span class="line">  <span class="comment">// 调用dispose方法时，会调用真正的dispose实现</span></span><br><span class="line">  <span class="comment">// 之所以如此复杂，是因为它既要保持链性结构，又要轮训后执行的run方法和dispose指向同一对象统一管理</span></span><br><span class="line">      static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntervalObserver</span> </span></span><br><span class="line">      extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">      implements Disposable, Runnable &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 每次轮训回调都会调用一下run方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">get</span>() != DisposableHelper.DISPOSED) &#123;</span><br><span class="line">                downstream.onNext(count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置内部的dispose</span></span><br><span class="line">        <span class="keyword">public</span> void setResource(Disposable d) &#123;</span><br><span class="line">            DisposableHelper.setOnce(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> DisposableHelper</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 调用内部的disposeable的值</span></span><br><span class="line">  <span class="keyword">public</span> static boolean dispose(AtomicReference&lt;Disposable&gt; field) &#123;</span><br><span class="line">      Disposable current = field.<span class="keyword">get</span>();</span><br><span class="line">      Disposable d = DISPOSED;</span><br><span class="line">    <span class="comment">// 拿到内部的Disposable，若没有被取消，则执行Disposable的dispose方法</span></span><br><span class="line">      <span class="keyword">if</span> (current != d) &#123;</span><br><span class="line">          current = field.getAndSet(d);</span><br><span class="line">          <span class="keyword">if</span> (current != d) &#123;</span><br><span class="line">              <span class="keyword">if</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">                  current.dispose();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 只设置一次disposable对象</span></span><br><span class="line">  <span class="keyword">public</span> static boolean setOnce(AtomicReference&lt;Disposable&gt; field, Disposable d) &#123;</span><br><span class="line">      Objects.requireNonNull(d, <span class="string">&quot;d is null&quot;</span>);</span><br><span class="line">    <span class="comment">//dispose对象为空的时候才设置</span></span><br><span class="line">      <span class="keyword">if</span> (!field.compareAndSet(<span class="literal">null</span>, d)) &#123;</span><br><span class="line">          d.dispose();</span><br><span class="line">          <span class="keyword">if</span> (field.<span class="keyword">get</span>() != DISPOSED) &#123;</span><br><span class="line">              reportDisposableSet();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="有上游的任务该如何取消"><a href="#有上游的任务该如何取消" class="headerlink" title="有上游的任务该如何取消"></a>有上游的任务该如何取消</h3><p>若是没有延迟和后续的single.map：上游dispose对象会直接传递到下一级，取消任务和它无关</p>
<p>若事件是有延迟无后续Singledelay</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">         .delay(<span class="number">1</span>,TimeUnit.SECONDS)</span><br><span class="line">         .subscribe(<span class="keyword">object</span>: SingleObserver&lt;<span class="built_in">Int</span>?&gt;&#123;</span><br><span class="line">             <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(t: <span class="type">Int</span>?)</span></span> &#123;</span><br><span class="line">             &#125;...&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleDelay</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line">    <span class="keyword">final</span> long time;</span><br><span class="line">    <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> boolean delayError;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleDelay(SingleSource&lt;? extends T&gt; source, long time, TimeUnit unit, Scheduler scheduler, boolean delayError) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">        <span class="keyword">this</span>.unit = unit;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">				<span class="comment">//自己的disposeable 实例</span></span><br><span class="line">        <span class="keyword">final</span> SequentialDisposable sd = new SequentialDisposable();</span><br><span class="line">        observer.onSubscribe(sd);</span><br><span class="line">       <span class="comment">// 不能直接传递上游的disposable，若dipose消息发出时，消息还在上游，上游直接拿到disposable对象，本层终止程序没有问题</span></span><br><span class="line">      <span class="comment">// 若消息已经传到本层级，那么停止消息就应该自己处理（上游singlejust已经没有处理的必要，本层却有延迟功能，这层应该关闭自己的定时器）</span></span><br><span class="line">        source.subscribe(new Delay(sd, observer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Delay</span> <span class="title">implements</span> <span class="title">SingleObserver</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SequentialDisposable sd;</span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        Delay(SequentialDisposable sd, SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sd = sd;</span><br><span class="line">            <span class="keyword">this</span>.downstream = observer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">           <span class="comment">//收到上游消息之前，若收到取消任务的通知，直接替换上游的disposable</span></span><br><span class="line">           <span class="comment">//本地的disposable被赋值成上游的，即可通知上游终止任务</span></span><br><span class="line">            sd.replace(d);</span><br><span class="line">        &#125;</span><br><span class="line">  			<span class="comment">//若已经收到上游的消息，无论成功失败都需要自己处理</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(<span class="keyword">final</span> T value) &#123;</span><br><span class="line">         		<span class="comment">// disposable替换成线程调度器，若通知取消任务要自主调用线程调度器关闭延时</span></span><br><span class="line">            sd.replace(scheduler.scheduleDirect(new OnSuccess(value), time, unit));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(<span class="keyword">final</span> Throwable e) &#123;</span><br><span class="line">          <span class="comment">// disposable替换成线程调度器，若通知取消任务要自主调用线程调度器关闭延时</span></span><br><span class="line">            sd.replace(scheduler.scheduleDirect(new OnError(e), delayError ? time : <span class="number">0</span>, unit));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSuccess</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交给内部的Disposable解决</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SequentialDisposable</span></span></span><br><span class="line">extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">implements Disposable &#123; ...</span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable(Disposable initial) &#123;</span><br><span class="line">        lazySet(initial);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> boolean replace(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.replace(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">    &#125; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有后续无延迟的任务如何取消"><a href="#有后续无延迟的任务如何取消" class="headerlink" title="有后续无延迟的任务如何取消"></a>有后续无延迟的任务如何取消</h3><p>ObservableMap的任务取消</p>
<p>dispose也是拿到上游的disposable进行取消，几乎等同于直接拿到上游的对象进行取消<br>map只是通过包装在消息传达时多做一些操作符操作而已</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableMap</span>&lt;<span class="type">T, U</span>&gt; <span class="title">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="type">T, U</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ObservableMap(ObservableSource&lt;T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function) &#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.function = function;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> U&gt; t) &#123;</span><br><span class="line">        source.subscribe(new MapObserver&lt;T, U&gt;(t, function));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapObserver</span>&lt;<span class="type">T, U</span>&gt; <span class="title">extends</span> <span class="title">BasicFuseableObserver</span>&lt;<span class="type">T, U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapObserver(Observer&lt;? <span class="keyword">super</span> U&gt; <span class="keyword">actual</span>, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="keyword">actual</span>);</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onNext(T t) &#123;</span><br><span class="line">            <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">				...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicFuseableObserver</span>&lt;<span class="type">T, R</span>&gt; <span class="title">implements</span> <span class="title">Observer</span>&lt;<span class="type">T</span>&gt;, <span class="type">QueueDisposable</span>&lt;<span class="type">R</span>&gt; </span>&#123; </span><br><span class="line">  <span class="comment">// 设置下游</span></span><br><span class="line">  <span class="keyword">public</span> BasicFuseableObserver(Observer&lt;? <span class="keyword">super</span> R&gt; downstream) &#123;</span><br><span class="line">        <span class="keyword">this</span>.downstream = downstream;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">      <span class="comment">//验证过上游</span></span><br><span class="line">        <span class="keyword">if</span> (DisposableHelper.validate(<span class="keyword">this</span>.upstream, d)) &#123;</span><br><span class="line">						<span class="comment">// 设置上游</span></span><br><span class="line">            <span class="keyword">this</span>.upstream = d;</span><br><span class="line">            <span class="keyword">if</span> (d instanceof QueueDisposable) &#123;</span><br><span class="line">                <span class="keyword">this</span>.qd = (QueueDisposable&lt;T&gt;)d;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (beforeDownstream()) &#123;</span><br><span class="line"></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                afterDownstream();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// dispose也是拿到上游的disposed进行取消，几乎等同于直接拿到上游的对象进行取消</span></span><br><span class="line">  <span class="comment">// map只是通过包装在消息传达时多做一些操作符操作而已</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        upstream.dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有后续有延迟的任务如何取消"><a href="#有后续有延迟的任务如何取消" class="headerlink" title="有后续有延迟的任务如何取消"></a>有后续有延迟的任务如何取消</h3><p>Observable </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; delay(long time, <span class="meta">@NonNull</span> TimeUnit unit, <span class="meta">@NonNull</span> Scheduler scheduler, boolean delayError) &#123;</span><br><span class="line">    Objects.requireNonNull(unit, <span class="string">&quot;unit is null&quot;</span>);</span><br><span class="line">    Objects.requireNonNull(scheduler, <span class="string">&quot;scheduler is null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(new ObservableDelay&lt;&gt;(<span class="keyword">this</span>, time, unit, scheduler, delayError));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ObservableDelay</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableDelay</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="type">T, T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> T&gt; t) &#123;</span><br><span class="line">        Observer&lt;T&gt; observer;</span><br><span class="line">        <span class="keyword">if</span> (delayError) &#123;</span><br><span class="line">            observer = (Observer&lt;T&gt;)t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            observer = new SerializedObserver&lt;&gt;(t);</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 线程调度器，创建延迟任务</span></span><br><span class="line">        Scheduler.Worker w = scheduler.createWorker();</span><br><span class="line"></span><br><span class="line">        source.subscribe(new DelayObserver&lt;&gt;(observer, delay, unit, w, delayError));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">      static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayObserver</span>&lt;<span class="type">T</span>&gt; <span class="title">implements</span> <span class="title">Observer</span>&lt;<span class="type">T</span>&gt;, <span class="type">Disposable &#123;</span></span></span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line">        <span class="keyword">final</span> long delay;</span><br><span class="line">        <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">        <span class="keyword">final</span> Scheduler.Worker w;</span><br><span class="line">        <span class="keyword">final</span> boolean delayError;</span><br><span class="line"></span><br><span class="line">        Disposable upstream;</span><br><span class="line"></span><br><span class="line">        DelayObserver(Observer&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, long delay, TimeUnit unit, Worker w, boolean delayError) &#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.delay = delay;</span><br><span class="line">            <span class="keyword">this</span>.unit = unit;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">            <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 上游下游的连接</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">          <span class="comment">// 验证上游</span></span><br><span class="line">            <span class="keyword">if</span> (DisposableHelper.validate(<span class="keyword">this</span>.upstream, d)) &#123;</span><br><span class="line">              <span class="comment">//上游赋值</span></span><br><span class="line">                <span class="keyword">this</span>.upstream = d;</span><br><span class="line">              <span class="comment">//调用下游的onSubscribe 订阅流程，传递的对象是自身（继承了Disposeable对象）</span></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onNext(<span class="keyword">final</span> T t) &#123;</span><br><span class="line">           <span class="comment">// 延迟调度器进行调度</span></span><br><span class="line">            w.schedule(new OnNext(t), delay, unit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            <span class="comment">// 延迟调度器进行调度</span></span><br><span class="line">            w.schedule(new OnError(t), delayError ? delay : <span class="number">0</span>, unit);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            <span class="comment">// 上游取消，不要在发消息了</span></span><br><span class="line">            upstream.dispose();</span><br><span class="line">						<span class="comment">// 延迟调度器也取消，有下游的消息也不要再发了</span></span><br><span class="line">            w.dispose();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="线程调度器"><a href="#线程调度器" class="headerlink" title="线程调度器"></a>线程调度器</h2><h3 id="subscribeOn"><a href="#subscribeOn" class="headerlink" title="subscribeOn()"></a>subscribeOn()</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>在 Scheduler 指定的线程里启动 subscribe()</p>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><ul>
<li>切换起源 Observable 的线程（也就是下游订阅上游事件的时候切线程）;</li>
<li>当多次调用 subscribeOn() 的时候，只有最上面的会对起源 Observable 起作用。</li>
</ul>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155354768.png" alt="image-20210830155354768"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleSubscribeOn</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleSubscribeOn(SingleSource&lt;? extends T&gt; source, Scheduler scheduler) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent = new SubscribeOnObserver&lt;&gt;(observer, source);</span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line">				<span class="comment">// 核心方法 切换线程，parent是runnable接口</span></span><br><span class="line">        Disposable f = scheduler.scheduleDirect(parent);</span><br><span class="line">				<span class="comment">// 将上游的disposable对象替换为本地的disposable代理类</span></span><br><span class="line">        parent.task.replace(f);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeOnObserver</span>&lt;<span class="type">T</span>&gt;</span></span><br><span class="line">    extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">    implements SingleObserver&lt;T&gt;, Disposable, Runnable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = <span class="number">7000911171163930287L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SequentialDisposable task;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">        SubscribeOnObserver(SingleObserver&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, SingleSource&lt;? extends T&gt; source) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.source = source;</span><br><span class="line">          	<span class="comment">//task 被赋值，SequentialDisposable 也是个代理类，不执行实际逻辑</span></span><br><span class="line">            <span class="keyword">this</span>.task = new SequentialDisposable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">          <span class="comment">// disposable实际赋值，上游传递来的disposable</span></span><br><span class="line">            DisposableHelper.setOnce(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">            downstream.onSuccess(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(Throwable e) &#123;</span><br><span class="line">            downstream.onError(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">           <span class="comment">// 通知上游的disposeable取消任务</span></span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">           <span class="comment">// 通知内部取消任务</span></span><br><span class="line">            task.dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">            <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">          <span class="comment">// 切换线程后对上游进行订阅</span></span><br><span class="line">            source.subscribe(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SequentialDisposable</span></span></span><br><span class="line">extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">implements Disposable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = -<span class="number">754898800686245608L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable() &#123;</span><br><span class="line">        <span class="comment">// nothing to do</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable(Disposable initial) &#123;</span><br><span class="line">        lazySet(initial);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> boolean update(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.<span class="keyword">set</span>(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> boolean replace(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.replace(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若多次调用subscribeOn方法切换线程，只会有一个线程影响任务的执行，多次调用是没有用的</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155602490.png" alt="image-20210830155602490"></p>
<h3 id="observeOn"><a href="#observeOn" class="headerlink" title="observeOn()"></a>observeOn()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleObserveOn</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleObserveOn(SingleSource&lt;T&gt; source, Scheduler scheduler) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">       	<span class="comment">// 订阅过程不切线程</span></span><br><span class="line">        source.subscribe(new ObserveOnSingleObserver&lt;&gt;(observer, scheduler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserveOnSingleObserver</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">AtomicReference</span>&lt;<span class="type">Disposable</span>&gt;</span></span><br><span class="line">    implements SingleObserver&lt;T&gt;, Disposable, Runnable &#123;</span><br><span class="line">        <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = <span class="number">3528003840217436037L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">        T value;</span><br><span class="line">        Throwable error;</span><br><span class="line"></span><br><span class="line">        ObserveOnSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, Scheduler scheduler) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">           <span class="comment">// 订阅过程，不切换线程</span></span><br><span class="line">            <span class="keyword">if</span> (DisposableHelper.setOnce(<span class="keyword">this</span>, d)) &#123;</span><br><span class="line">               <span class="comment">//赋值dispose（来自上游的disposable），</span></span><br><span class="line">              <span class="comment">//实际上下游取消的时候就会取消掉上游的任务（因为没有切换线程）</span></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">          <span class="comment">// 上游事件到达后切线程</span></span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">          <span class="comment">// 收到线程后再取消，将内部的disposable替换成切线程的任务</span></span><br><span class="line">          <span class="comment">// 不需要通知上游，直接取消即可</span></span><br><span class="line">            Disposable d = scheduler.scheduleDirect(<span class="keyword">this</span>);</span><br><span class="line">            DisposableHelper.replace(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(Throwable e) &#123;</span><br><span class="line">          <span class="comment">// 事件到达后切线程</span></span><br><span class="line">            <span class="keyword">this</span>.error = e;</span><br><span class="line">          <span class="comment">// 事件到达后取消的是切线程</span></span><br><span class="line">            Disposable d = scheduler.scheduleDirect(<span class="keyword">this</span>);</span><br><span class="line">          <span class="comment">// 将disposable替换呢为b</span></span><br><span class="line">            DisposableHelper.replace(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">            Throwable ex = error;</span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="literal">null</span>) &#123;</span><br><span class="line">                downstream.onError(ex);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                downstream.onSuccess(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">            <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>在内部创建的 Observer 的 onNext() onError() onSuccess() 等回调方法里，通过 Scheduler 指定的线程来调用下级 Observer 的对应回调方法</p>
<p>在任务下发到下游的时候才切线程，订阅上游事件的时候不切线程</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155936495.png" alt="image-20210830155936495"></p>
<h4 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h4><p>切换 observeOn() 下面的 Observer 的回调所在的线程<br> 当多次调用 observeOn() 的时候，每个都会进行一次线程切换，影响范围是它 下面的每个 Observer (除非又遇到新的 observeOn())</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174959565.png" alt="image-20210826174959565"></p>
<h3 id="Scheduler-的原理"><a href="#Scheduler-的原理" class="headerlink" title="Scheduler 的原理"></a>Scheduler 的原理</h3><ol>
<li><p>Schedulers.newThread() 和 Schedulers.io():</p>
<ul>
<li>当 scheduleDirect() 被调用的时候，会创建一个 Worker，Worker 的内部 会有一个 Executor，由 Executor 来完成实际的线程切换; </li>
<li>scheduleDirect() 还会创建出一个 Disposable 对象，交给外层的 Observer，让它能执行 dispose() 操作，取消订阅链;</li>
<li>newThread() 和 io() 的区别在于，io() 可能会对 Executor 进行重用。</li>
</ul>
</li>
<li><p>androidSchedulers.mainThread():</p>
<p>通过内部的 Handler 把任务放到主线程去做。</p>
</li>
</ol>
<p>Scheduler</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"> <span class="keyword">public</span> Disposable scheduleDirect(<span class="meta">@NonNull</span> Runnable run, long delay, <span class="meta">@NonNull</span> TimeUnit unit) &#123;</span><br><span class="line">     <span class="keyword">final</span> Worker w = createWorker();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line"></span><br><span class="line">     DisposeTask task = new DisposeTask(decoratedRun, w);</span><br><span class="line"></span><br><span class="line">     w.schedule(task, delay, unit);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> task;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Schedulers-newThread-和iSchedulers-io"><a href="#Schedulers-newThread-和iSchedulers-io" class="headerlink" title="Schedulers.newThread()和iSchedulers.io()"></a>Schedulers.newThread()和iSchedulers.io()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">    .subscribeOn(Schedulers.newThread())<span class="comment">//newThread()是io的基础</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line">		<span class="comment">//包含一个executor进行线程调度，每次都会用全新的executor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerPoolFactory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">create</span><span class="params">(ThreadFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ScheduledExecutorService exec = Executors.newScheduledThreadPool(<span class="number">1</span>, factory);</span><br><span class="line">        tryPutIntoPool(PURGE_ENABLED, exec);</span><br><span class="line">        <span class="keyword">return</span> exec;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IoScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">  	...</span><br><span class="line">		<span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EventLoopWorker(pool.get());</span><br><span class="line">    &#125;  </span><br><span class="line">   ...</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EventLoopWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CompositeDisposable tasks;</span><br><span class="line">      <span class="comment">// Executor 重用池，newThread是没有重用池的，这就是io和newThread的区别</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CachedWorkerPool pool;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ThreadWorker threadWorker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AtomicBoolean once = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">        EventLoopWorker(CachedWorkerPool pool) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pool = pool;</span><br><span class="line">            <span class="keyword">this</span>.tasks = <span class="keyword">new</span> CompositeDisposable();</span><br><span class="line">            <span class="keyword">this</span>.threadWorker = pool.get();</span><br><span class="line">        &#125;</span><br><span class="line">    ....</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span> <span class="keyword">extends</span> <span class="title">NewThreadWorker</span> </span>&#123;</span><br><span class="line">			<span class="comment">// 继承了NewThreadWork</span></span><br><span class="line">        <span class="keyword">long</span> expirationTime;</span><br><span class="line"></span><br><span class="line">        ThreadWorker(ThreadFactory threadFactory) &#123;</span><br><span class="line">            <span class="keyword">super</span>(threadFactory);</span><br><span class="line">            <span class="keyword">this</span>.expirationTime = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getExpirationTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpirationTime</span><span class="params">(<span class="keyword">long</span> expirationTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.expirationTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<h3 id="切到主线程"><a href="#切到主线程" class="headerlink" title="切到主线程"></a>切到主线程</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">    .observeOn(AndroidSchedulers.mainThread())</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidSchedulers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Scheduler DEFAULT</span><br><span class="line">            = <span class="keyword">new</span> HandlerScheduler(<span class="keyword">new</span> Handler(Looper.getMainLooper()), <span class="keyword">true</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span> <span class="comment">// Async will only be true when the API is available to call.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(Runnable run, <span class="keyword">long</span> delay, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (run == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;run == null&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (unit == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;unit == null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        run = RxJavaPlugins.onSchedule(run);</span><br><span class="line">        ScheduledRunnable scheduled = <span class="keyword">new</span> ScheduledRunnable(handler, run);</span><br><span class="line">        Message message = Message.obtain(handler, scheduled);</span><br><span class="line">        <span class="keyword">if</span> (async) &#123;</span><br><span class="line">            message.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用handler切回到主线程</span></span><br><span class="line">        handler.sendMessageDelayed(message, unit.toMillis(delay));</span><br><span class="line">        <span class="keyword">return</span> scheduled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/25/Android%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/25/Android%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Android的多线程机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-25 12:10:57" itemprop="dateCreated datePublished" datetime="2021-08-25T12:10:57+08:00">2021-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-07 14:41:37" itemprop="dateModified" datetime="2021-09-07T14:41:37+08:00">2021-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">线程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Android的多线程机制"><a href="#Android的多线程机制" class="headerlink" title="Android的多线程机制"></a>Android的多线程机制</h1><h2 id="Android-Handler-机制模型"><a href="#Android-Handler-机制模型" class="headerlink" title="Android Handler 机制模型"></a>Android Handler 机制模型</h2><p>本质: 在某个指定的运行中的线程上执行代码</p>
<p>思路: 在接受任务的线程上执行循环判断</p>
<h3 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现:"></a>基本实现:</h3><ul>
<li>Thread 里 while 循环检查</li>
<li>加上 Looper(优势在于自定义 Thread 的代码可以少写很多，,把要处理的任务放入消息队列Messages（一个链表）中)</li>
<li>再加上 Handler进行任务的处理(优势在于功能分拆，而且可以有多个 Handler，hander收到的Message包含int型，runnable【callback】，object)</li>
</ul>
<p>模型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    Looper looper = <span class="keyword">new</span> Looper();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        looper.loop();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line">        <span class="keyword">private</span> AtomicBoolean quit = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setTask</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            quit.set(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 无限循环的线程</span></span><br><span class="line">            <span class="keyword">while</span> (!quit.get()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        task.run();</span><br><span class="line">                        task = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h2 id="Android-Handler-机制"><a href="#Android-Handler-机制" class="headerlink" title="Android Handler 机制:"></a>Android Handler 机制:</h2><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal:"></a>ThreadLocal:</h3><p>每个线程不共享的内存</p>
<p>Eg:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ThreadLocal&lt;Integer&gt; threadNumber = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    threadNumber.set(<span class="number">1</span>);</span><br><span class="line">    threadNumber.get();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.start();</span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    threadNumber.set(<span class="number">2</span>);</span><br><span class="line">    threadNumber.get();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>
<p>Android中调用Looper.myLooper() 获取线程持有的Looper对象，会发现它是存储在ThreadLocal中的</p>
<p>Looper:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread:"></a>HandlerThread:</h3><p>具体的线程 </p>
<p>HandlerThread</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">// 启动Looper</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mTid = Process.myTid();</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mLooper = Looper.myLooper();</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Process.setThreadPriority(mPriority);</span><br><span class="line">       <span class="comment">//初始化Looper</span></span><br><span class="line">        onLooperPrepared();</span><br><span class="line">       <span class="comment">// Looper 开启循环</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">        mTid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Looper"><a href="#Looper" class="headerlink" title="Looper:"></a>Looper:</h3><p>负责循环、条件判断和任务执行 </p>
<p>Looper:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;</span><br><span class="line">    static <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> static void prepare() &#123;</span><br><span class="line">        prepare(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 初始化，存储当前创建的Looper到ThreadLocal</span></span><br><span class="line">    <span class="keyword">private</span> static void prepare(boolean quitAllowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sThreadLocal.<span class="keyword">get</span>() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new RuntimeException(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sThreadLocal.<span class="keyword">set</span>(new Looper(quitAllowed));</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 开启Loop循环</span></span><br><span class="line"> 		<span class="keyword">public</span> static void loop() &#123;</span><br><span class="line">       </span><br><span class="line">        ...</span><br><span class="line">				<span class="comment">// 死循环</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          <span class="comment">// 一直拿下一个Message</span></span><br><span class="line">            Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">            ... </span><br><span class="line">          <span class="comment">//处理Message</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// target是一个Handler ，每个message需要一个Handler来处理</span></span><br><span class="line">                msg.target.dispatchMessage(msg);</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                    observer.messageDispatched(token, msg);</span><br><span class="line">                &#125;</span><br><span class="line">                dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                    observer.dispatchingThrewException(token, msg, exception);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> exception;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ThreadLocalWorkSource.restore(origWorkSource);</span><br><span class="line">                <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                    Trace.traceEnd(traceTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDelivery) &#123;</span><br><span class="line">                <span class="keyword">if</span> (slowDeliveryDetected) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((dispatchStart - msg.<span class="keyword">when</span>) &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">&quot;Drained&quot;</span>);</span><br><span class="line">                        slowDeliveryDetected = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (showSlowLog(slowDeliveryThresholdMs, msg.<span class="keyword">when</span>, dispatchStart, <span class="string">&quot;delivery&quot;</span>,</span><br><span class="line">                            msg)) &#123;</span><br><span class="line">                        <span class="comment">// Once we write a slow delivery log, suppress until the queue drains.</span></span><br><span class="line">                        slowDeliveryDetected = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logSlowDispatch) &#123;</span><br><span class="line">                showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, <span class="string">&quot;dispatch&quot;</span>, msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logging != <span class="literal">null</span>) &#123;</span><br><span class="line">                logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">            <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">            <span class="keyword">final</span> long newIdent = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                        + <span class="built_in">Long</span>.toHexString(ident) + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                        + <span class="built_in">Long</span>.toHexString(newIdent) + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                        + msg.target.getClass().getName() + <span class="string">&quot; &quot;</span></span><br><span class="line">                        + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            msg.recycleUnchecked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler:"></a>Handler:</h3><p>负责任务的定制和线程间传递消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 下发msg</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// callback = runnable</span></span><br><span class="line">        <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 执行runnable</span></span><br><span class="line">            handleCallback(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// 如果没有callback（runnable）要自己处理message</span></span><br><span class="line">          <span class="comment">// 外界调用它就要自己重写handleMessage 自己定义处理规则</span></span><br><span class="line">            handleMessage(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>创建制定线程/多个Handler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HandlerThread hanlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;second&quot;</span>);</span><br><span class="line">Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line">Handler handlerSecond = <span class="keyword">new</span> Handler(hanlerThread.getLooper());</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本质是在某个运行中的线程执行指定的代码，Java只能在没有运行的线程中执行代码。</p>
<p>Java的目标是将任务放入后台，Android的线程机制可以指定线程。</p>
<p>Java要是想做到像Android一样循环过程中执行任务，也需要像Android一样不停的循环，再插入任务，不然无法在已运行的线程添加代码。因为线程间的通信只是协同通信，内存/资源共享，线程直接是无法真正对话的。</p>
<h2 id="AsyncTask-的内存泄露"><a href="#AsyncTask-的内存泄露" class="headerlink" title="AsyncTask: 的内存泄露"></a>AsyncTask: 的内存泄露</h2><p>众所周知的原因:AsyncTask 持有外部 Activity 的引用 (官方提示asynctask若不是静态的会持有外部的activity引用导致内存泄漏)</p>
<p>没提到的原因:执行中的线程不会被系统回收</p>
<p>Java 回收策略:没有被 GC Root 直接或间接持有引用的对象，会被回收</p>
<p>所以:</p>
<p>AsyncTask 的内存泄露，其他类型的线程方案(Thread、 Executor、HandlerThread)一样都有，所以不要忽略它们，或者认为 AsyncTask 比别的方案更危险。并没有。</p>
<p>就算是使用 AsyncTask，只要任务的时间不⻓(例如 10 秒之 内)，那就完全没必要做防止内存泄露的处理。</p>
<p>被废弃的原因是因为不好用</p>
<h3 id="什么是内存泄漏"><a href="#什么是内存泄漏" class="headerlink" title="什么是内存泄漏"></a>什么是内存泄漏</h3><p>内存中的某个对象已经没用处了但是依然无法被回收。</p>
<h3 id="GC-Root"><a href="#GC-Root" class="headerlink" title="GC Root:"></a>GC Root:</h3><p>什么是GC Root：</p>
<ol>
<li>运行中的线程</li>
<li>静态对象</li>
<li>来自 native code 中的引用</li>
</ol>
<h2 id="Service-和-IntentService"><a href="#Service-和-IntentService" class="headerlink" title="Service 和 IntentService"></a>Service 和 IntentService</h2><p>Service:后台任务的活动空间（并不会自动切到后台，并不是后台线程）。适用场景:音乐播放器等。</p>
<p>IntentService: 执行单个任务后自动关闭的 Service，既是后台线程工具，又是service工具·</p>
<h2 id="Executor、AsyncTask、HandlerThead、IntentService-的选择"><a href="#Executor、AsyncTask、HandlerThead、IntentService-的选择" class="headerlink" title="Executor、AsyncTask、HandlerThead、IntentService 的选择"></a><strong>Executor</strong>、AsyncTask<strong>、</strong>HandlerThead、<strong>IntentService</strong> 的选择</h2><p>原则:哪个简单用哪个</p>
<ul>
<li>能用 Executor 就用 Executor</li>
<li>需要用到「后台线程推送任务到 UI 线程」时，再考虑 AsyncTask 或者 Handler </li>
<li>HandlerThread 的使用场景:原本它设计的使用场景是「在已经运行的指定线 程上执行代码」，但现实开发中，除了主线程之外，几乎没有这种需求，因为 HandlerThread 和 Executor 相比在实际应用中并没什么优势，反而用起来会麻 烦一点。不过，这二者喜欢用谁就用谁吧。<br> IntentService:首先，它是一个 Service;另外，它在处理线程本身，没有比 Executor 有任何优势</li>
</ul>
<h2 id="关于-Executor-和-HandlerThread-的关闭"><a href="#关于-Executor-和-HandlerThread-的关闭" class="headerlink" title="关于 Executor 和 HandlerThread 的关闭"></a>关于 Executor 和 HandlerThread 的关闭</h2><p>如果在界面组件里创建 Executor 或者 HandlerThread，记得要在关闭的时候(例如 <code>Activity.onDestroy() </code>)关闭 Executor 和 HandlerThread。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123; </span><br><span class="line">	<span class="keyword">super</span>.onDestroy(); </span><br><span class="line">	executor.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onDestroy();</span><br><span class="line">	handlerThread.quit(); <span class="comment">// 这个其实就是停止 Looper 的循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/24/%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/24/%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" class="post-title-link" itemprop="url">线程间通信</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-24 16:43:06" itemprop="dateCreated datePublished" datetime="2021-08-24T16:43:06+08:00">2021-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-07 10:20:03" itemprop="dateModified" datetime="2021-09-07T10:20:03+08:00">2021-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">线程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h2><p>线程间本来无法通信，有的知识互相之间的调度/配合</p>
<h2 id="一个线程启动其他线程"><a href="#一个线程启动其他线程" class="headerlink" title="一个线程启动其他线程"></a>一个线程启动其他线程</h2><p>一个线程启动别的线程:new Thread().start()、Executor.execute() 等</p>
<h2 id="一个线程终结其他线程"><a href="#一个线程终结其他线程" class="headerlink" title="一个线程终结其他线程"></a>一个线程终结其他线程</h2><ul>
<li><p>Thread.stop()：强制终结，已启用，无论任务完成与否都会立刻终结会导致程序的不可控。</p>
</li>
<li><p>Thread.interrupt():温和式终结:不立即、不强制。</p>
<p> interrupt()只是将中断状态标记为true，并不是马上终结</p>
<ul>
<li><p>interrupted() 和 isInterrupted():检查(和重置)中断状态</p>
<p>isInterrupted(): 检查中断状态，可以重复使用这个方法判断中断状态</p>
<p>Thread.interrupted(): 检查并重置中断状态，下次再调用它时会返回false</p>
<blockquote>
<p>线程中的内容需要十分配合才会在调用interrupt()之后停止工作，一般会在耗时工作开始之前进行isInterrupted()判断，若线程已被打断则终止。若在耗时工作完成之后再判断只会造成浪费</p>
</blockquote>
</li>
<li><p>InterruptedException:如果在线程「等待」时中断，或者在中断状态 「等待」，直接结束等待过程(因为等待过程什么也不会做，而 interrupt() 的目的是让线程做完收尾工作后尽快终结，所以要跳过等待过程)</p>
<p>也就是线程内部sleep时，线程外部调用了interupted，内部会立刻抛出InterruptedException异常，因为自线程此时没有任何资源操作，系统希望立刻打断线程。</p>
<p>所以在抛出InterruptedException异常时应该做结束线程的收尾工作。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadInteractionDemo</span> <span class="keyword">implements</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1_000_000</span>; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isInterrupted()) &#123;</span><br><span class="line">                        <span class="comment">// 擦屁股</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="comment">// 擦屁股</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">&quot;number: &quot;</span> + i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一个线程和其他线程配合（wait和notify）"><a href="#一个线程和其他线程配合（wait和notify）" class="headerlink" title="一个线程和其他线程配合（wait和notify）"></a>一个线程和其他线程配合（wait和notify）</h2><p>Object.wait() 和 Object.notify() / notifyAll()</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210825113730312.png" alt="image-20210825113730312" style="zoom:33%;">

<ul>
<li><p>在未达到目标时 wait() </p>
<p>获取锁（monitor）对象的线程，若发现代码块执行的条件不足，可以调用wait方法进入<code>等待区</code>，将锁交还给其他线程使用，注意，等待区可以有不止一个线程等待。</p>
</li>
<li><p>用 while 循环检查 </p>
<p>直到其他线程调用notify()/notifyAll()唤醒线程时,线程才会从<code>等待区</code>出来（若<code>等待区</code>有多个线程，使用notifyAll会进行公平竞争）</p>
<ul>
<li><p>notify：通知一个线程从<code>等待区</code>出来（若<code>等待区</code>有多个线程，这样做是危险的）</p>
</li>
<li><p>notifyAll：通知所有<code>等待区</code>线程出来，从<code>等待区</code>出来后，线程也需要和其他线程公平竞争锁，不一定立刻执行</p>
</li>
</ul>
<p>以下例子中，线程会继续while检查条件是否满足，若不满足会继续进入<code>等待区</code>等待</p>
</li>
<li><p>设置完成后 notifyAll()</p>
<p>其他线程若完成对资源的修改可以notifyAll() 或者notify唤醒<code>等待区</code>的线程，wait和notify/notifyAll必须成对出现，否则调用了wait的线程将会一直等待</p>
</li>
<li><p>wait() 和 notify() / notifyAll() 都需要放在synchronized同步代码块里</p>
<p>因为等待的过程正是要通知monitor去缓存区获取等待中的线程，若monitor不存在等待也无意义</p>
</li>
<li><p>wait()，notify()，notifyAll()都是Object的方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitDemo</span> <span class="keyword">implements</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String sharedString;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sharedString = <span class="string">&quot;rengwuxian&quot;</span>;</span><br><span class="line">    notifyAll();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (sharedString == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        wait();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;String: &quot;</span> + sharedString);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread thread1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        printString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread1.start();</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        initString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread2.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="join和yeid"><a href="#join和yeid" class="headerlink" title="join和yeid"></a>join和yeid</h2><ul>
<li><p>Thread.join():让另一个线程插在自己前面，</p>
<p>像一个更简化的不需要notify的wait方法，把两个并行的线程变成线性的先后关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitDemo</span> <span class="keyword">implements</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String sharedString;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">initString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sharedString = <span class="string">&quot;rengwuxian&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">printString</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;String: &quot;</span> + sharedString);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        initString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread2.start();</span><br><span class="line">    <span class="keyword">final</span> Thread thread1 = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若不让thread2 初始化字符串线程join到前面，print结果为null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          thread2.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        printString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread1.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>Thread.yield():</p>
<p>暂时(时间非常短)让出自己的时间片给同优先级的线程</p>
<p>它像是一个时间更短更简化的wait，出让时间后也不会等待其他线程执行完，会马上继续执行</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/24/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B604-%E8%8C%83%E5%9B%B4%E8%A3%81%E5%88%87%E5%92%8C%E5%87%A0%E4%BD%95%E5%8F%98%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/24/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B604-%E8%8C%83%E5%9B%B4%E8%A3%81%E5%88%87%E5%92%8C%E5%87%A0%E4%BD%95%E5%8F%98%E6%8D%A2/" class="post-title-link" itemprop="url">自定义view绘制04:范围裁切和几何变换</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-24 11:11:05 / 修改时间：16:42:10" itemprop="dateCreated datePublished" datetime="2021-08-24T11:11:05+08:00">2021-08-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89View/" itemprop="url" rel="index"><span itemprop="name">自定义View</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="范围裁切和几何变换"><a href="#范围裁切和几何变换" class="headerlink" title="范围裁切和几何变换"></a>范围裁切和几何变换</h1><h2 id="Canvas-的范围裁切"><a href="#Canvas-的范围裁切" class="headerlink" title="Canvas 的范围裁切"></a>Canvas 的范围裁切</h2><ul>
<li><p>clipRect： 切成矩形</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//裁切 左上角</span></span><br><span class="line">   canvas.clipRect(BITMAP_PADDING, BITMAP_PADDING,</span><br><span class="line">       BITMAP_PADDING+ BITMAP_SIZE/<span class="number">2</span></span><br><span class="line">       ,BITMAP_PADDING+ BITMAP_SIZE/<span class="number">2</span>)</span><br><span class="line">   canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING,paint)</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824113648691.png" alt="image-20210824113648691"></p>
</li>
<li><p>clipPath() ：切封闭图形</p>
<p> clipPath() 切出来的圆为什么没有抗锯⻮效果?因为「强行切边」，而xfermode会对边缘进行一些模糊处理</p>
</li>
<li><p>clipOutRect() / clipOutPath() 反向版本，切的位置是不要的，其余位置留下</p>
</li>
</ul>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> BITMAP_SIZE = <span class="number">200.</span>dp</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> BITMAP_PADDING = <span class="number">100.</span>dp</span><br><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bitmap = getAvatar(BITMAP_SIZE.toInt())</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cliped = Path().apply &#123;</span><br><span class="line">        addOval(BITMAP_PADDING, BITMAP_PADDING,</span><br><span class="line">            BITMAP_PADDING+ BITMAP_SIZE</span><br><span class="line">            ,BITMAP_PADDING+ BITMAP_SIZE,Path.Direction.CCW)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        <span class="comment">//范围裁切</span></span><br><span class="line">        <span class="comment">// clipRect：裁切 左上角</span></span><br><span class="line"><span class="comment">//        canvas.clipRect(BITMAP_PADDING, BITMAP_PADDING,</span></span><br><span class="line"><span class="comment">//            BITMAP_PADDING+ BITMAP_SIZE/2</span></span><br><span class="line"><span class="comment">//            ,BITMAP_PADDING+ BITMAP_SIZE/2)</span></span><br><span class="line"><span class="comment">//        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING,paint)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// clipPath：裁切 Path 圆形</span></span><br><span class="line">        canvas.clipPath(cliped)</span><br><span class="line">        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING,paint)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getAvatar</span><span class="params">(width: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        <span class="keyword">val</span> options = BitmapFactory.Options()</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">true</span></span><br><span class="line">        BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">false</span></span><br><span class="line">        options.inDensity = options.outWidth</span><br><span class="line">        options.inTargetDensity = width</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Canvas-的几何变换"><a href="#Canvas-的几何变换" class="headerlink" title="Canvas 的几何变换"></a>Canvas 的几何变换</h2><ul>
<li><p>translate(x, y)平移</p>
</li>
<li><p>rotate(degree) 旋转</p>
</li>
<li><p>scale(x, y) 缩放</p>
</li>
<li><p>skew(x, y) 错切（斜切）方形切棱形等操作</p>
</li>
</ul>
<p><strong>重点:</strong></p>
<p>Canvas 的几何变换方法参照的是 View 的坐标系，而绘制方法 (drawXxx())参照的是 Canvas 自己的坐标系。</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824152046675.png" alt="image-20210824152046675" style="zoom:50%;">

<h3 id="关于多重变换"><a href="#关于多重变换" class="headerlink" title="关于多重变换"></a>关于多重变换</h3><p>Canvas 的变换方法多次调用的时候，由于 Canvas 的坐标系会整体被变换，因此当 平移、旋转、放缩、错切等变换多重存在的时候，Canvas 的变换参数会非常难以计 算，因此可以改用倒序的理解方式:</p>
<blockquote>
<p>将 Canvas 的变换理解为 Canvas 的坐标系不变，每次变换是只对内部的绘制内 容进行变换，同时把 Canvas 的变换顺序看作是倒序的(即写在下面的变换先 执行)，可以更加方便进行多重变换的参数计算。</p>
</blockquote>
<h2 id="Matrix的几何变换"><a href="#Matrix的几何变换" class="headerlink" title="Matrix的几何变换"></a>Matrix的几何变换</h2><ul>
<li>reTranslate(x, y) / postTranslate(x, y)</li>
<li>preRotate(degree) / postRotate(degree) </li>
<li>preScale(x, y) / postScale(x, y)</li>
<li>preSkew(x, y) / postSkew(x, y)</li>
</ul>
<p>其中 preXxx() 效果和 Canvas 的准同名方法相同， postXxx() 效果和 Canvas 的准同名方法顺序相反。</p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>如果多次绘制时重复使用 Matrix，在使用之前需要用 Matrix.reset() 来把 Matrix 重置。</p>
<h2 id="使用Camera做三维旋转"><a href="#使用Camera做三维旋转" class="headerlink" title="使用Camera做三维旋转"></a>使用Camera做三维旋转</h2><ul>
<li>rotate() / rotateX() / rotateY() / rotateZ() </li>
<li>translate()</li>
<li>setLocation()</li>
</ul>
<p>其中，一般只用 rotateX() 和 rorateY() 来做沿 x 轴或 y 轴的旋转，以及使 用 setLocation() 来调整放缩的视觉幅度。</p>
<p>对 Camera 变换之后，要用 Camera.applyToCanvas(Canvas) 来应用到 Canvas。</p>
<p>三维坐标轴</p>
<p>x： 右为正向 ，y：上为正向，z：向屏幕里面为正向</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824152852451.png" alt="image-20210824152852451" style="zoom:33%;">

<p>camera存在于空间中，面对沿x轴旋转的图片会呈现出T形</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824153154902.png" alt="image-20210824153154902" style="zoom:33%;">

<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824153223669.png" alt="image-20210824153223669" style="zoom:33%;">

<p>camera的轴心无法移动，我们可以移动画布，旋转后再移动回原位置</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824153516440.png" alt="image-20210824153516440" style="zoom:33%;">



<p>Eg：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// camera</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">val</span> camera = Camera()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">init</span> &#123;</span><br><span class="line">       <span class="comment">// 没指定轴心，默认为0，0</span></span><br><span class="line">       camera.rotateX(<span class="number">30f</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">       <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">       <span class="comment">// Camera</span></span><br><span class="line">       <span class="comment">//对 Camera 变换之后，要用 Camera.applyToCanvas(Canvas) 来应用到 Canvas。</span></span><br><span class="line">       <span class="comment">//camera的轴心无法移动，我们可以移动画布，旋转后再移动回原位置（书写顺序要倒过来）</span></span><br><span class="line">       canvas . translate (BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>,</span><br><span class="line">           BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">       camera.applyToCanvas(canvas)</span><br><span class="line"></span><br><span class="line">       canvas.translate(</span><br><span class="line">           -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>),</span><br><span class="line">           -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">       canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING, paint)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824154045317.png" alt="image-20210824154045317" style="zoom:50%;">

<h3 id="setLocation"><a href="#setLocation" class="headerlink" title="setLocation"></a>setLocation</h3><p>这个方法一般前两个参数都填（x,y） 0，第三个参数为负值(z)。由于这个值的单位是硬编码写 死的，因此像素密度越高的手机，相当于 Camera 距离 View 越近，所以最好把这个 值写成与机器的 density  成正比的一个负值，例如 -6 * density。</p>
<p>Camera距离太近投影看起来就很大：</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824154554418.png" alt="image-20210824154554418" style="zoom:50%;">





<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上半部分</span></span><br><span class="line">canvas.save()</span><br><span class="line">canvas.translate (BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>,</span><br><span class="line">    BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">canvas.clipRect(- BITMAP_SIZE, - BITMAP_SIZE/<span class="number">2</span>, BITMAP_SIZE/<span class="number">2</span>, <span class="number">0f</span>)</span><br><span class="line">canvas.translate(</span><br><span class="line">    -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>),</span><br><span class="line">    -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>))</span><br><span class="line">canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING, paint)</span><br><span class="line">canvas.restore()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下半部分</span></span><br><span class="line">canvas.translate (BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>,</span><br><span class="line">    BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">camera.applyToCanvas(canvas)</span><br><span class="line">canvas.clipRect(- BITMAP_SIZE, <span class="number">0f</span>, BITMAP_SIZE/<span class="number">2</span>, BITMAP_SIZE/<span class="number">2</span>)</span><br><span class="line">canvas.translate(</span><br><span class="line">    -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>),</span><br><span class="line">    -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>))</span><br><span class="line">canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING, paint)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824161105237.png" alt="image-20210824161105237"></p>
<p>斜切：转动canvas在裁切即可</p>
<p>旋转后需要扩大裁切范围，否则会裁切到原本的图片，裁切范围扩大两倍</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824161604856.png" alt="image-20210824161604856" style="zoom:50%;">

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hencoder.customviewdrawing.clipandcamera</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.*</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> androidx.<span class="keyword">annotation</span>.RequiresApi</span><br><span class="line"><span class="keyword">import</span> com.hencoder.customviewdrawing.R</span><br><span class="line"><span class="keyword">import</span> com.hencoder.customviewdrawing.view.dp</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by amazingZZ on 8/24/21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> BITMAP_SIZE = <span class="number">200.</span>dp</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> BITMAP_PADDING = <span class="number">100.</span>dp</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CameraView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bitmap = getAvatar(BITMAP_SIZE.toInt())</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> cliped = Path().apply &#123;</span><br><span class="line">        addOval(</span><br><span class="line">            BITMAP_PADDING, BITMAP_PADDING,</span><br><span class="line">            BITMAP_PADDING + BITMAP_SIZE</span><br><span class="line">            , BITMAP_PADDING + BITMAP_SIZE, Path.Direction.CCW</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// camera</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> camera = Camera()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// 没指定轴心，默认为0，0</span></span><br><span class="line">        camera.rotateX(<span class="number">30f</span>)</span><br><span class="line">        <span class="comment">// 移动摄像机，单位不是像素是英寸（因为这个方法不是谷歌提供的，1英寸大概72像素）</span></span><br><span class="line">        camera.setLocation(<span class="number">0f</span>, <span class="number">0f</span>, -<span class="number">6</span> * resources.displayMetrics.density)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        <span class="comment">//范围裁切</span></span><br><span class="line">        <span class="comment">// clipRect：裁切 左上角</span></span><br><span class="line"><span class="comment">//        canvas.clipRect(BITMAP_PADDING, BITMAP_PADDING,</span></span><br><span class="line"><span class="comment">//            BITMAP_PADDING+ BITMAP_SIZE/2</span></span><br><span class="line"><span class="comment">//            ,BITMAP_PADDING+ BITMAP_SIZE/2)</span></span><br><span class="line"><span class="comment">//        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING,paint)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// clipPath：裁切 Path 圆形</span></span><br><span class="line"><span class="comment">//        canvas.clipPath(cliped)</span></span><br><span class="line"><span class="comment">//        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING,paint)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Camera</span></span><br><span class="line">        <span class="comment">//对 Camera 变换之后，要用 Camera.applyToCanvas(Canvas) 来应用到 Canvas。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//camera的轴心无法移动，我们可以移动画布，旋转后再移动回原位置（书写顺序要倒过来）</span></span><br><span class="line">        <span class="comment">// 上半部分</span></span><br><span class="line">        canvas.save()</span><br><span class="line">        canvas.translate (BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>,</span><br><span class="line">            BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>)</span><br><span class="line">        canvas.rotate(-<span class="number">30f</span>)</span><br><span class="line"></span><br><span class="line">        canvas.clipRect(- BITMAP_SIZE, - BITMAP_SIZE, BITMAP_SIZE, <span class="number">0f</span>)</span><br><span class="line">        canvas.rotate(<span class="number">30f</span>)</span><br><span class="line"></span><br><span class="line">        canvas.translate(</span><br><span class="line">            -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>),</span><br><span class="line">            -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>))</span><br><span class="line">        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING, paint)</span><br><span class="line">        canvas.restore()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下半部分</span></span><br><span class="line">        canvas.translate (BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>,</span><br><span class="line">            BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>)</span><br><span class="line">        canvas.rotate(-<span class="number">30f</span>)</span><br><span class="line"></span><br><span class="line">        camera.applyToCanvas(canvas)</span><br><span class="line">        canvas.clipRect(- BITMAP_SIZE, <span class="number">0f</span>, BITMAP_SIZE, BITMAP_SIZE)</span><br><span class="line">        canvas.rotate(<span class="number">30f</span>)</span><br><span class="line"></span><br><span class="line">        canvas.translate(</span><br><span class="line">            -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>),</span><br><span class="line">            -(BITMAP_PADDING + BITMAP_SIZE / <span class="number">2</span>))</span><br><span class="line">        canvas.drawBitmap(bitmap, BITMAP_PADDING, BITMAP_PADDING, paint)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getAvatar</span><span class="params">(width: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        <span class="keyword">val</span> options = BitmapFactory.Options()</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">true</span></span><br><span class="line">        BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">false</span></span><br><span class="line">        options.inDensity = options.outWidth</span><br><span class="line">        options.inTargetDensity = width</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210824162040886.png" alt="image-20210824162040886"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/20/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B603-%E6%96%87%E5%AD%97%E7%9A%84%E6%B5%8B%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/20/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B603-%E6%96%87%E5%AD%97%E7%9A%84%E6%B5%8B%E9%87%8F/" class="post-title-link" itemprop="url">自定义view绘制03:文字的测量</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-20 15:14:12" itemprop="dateCreated datePublished" datetime="2021-08-20T15:14:12+08:00">2021-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-24 11:05:51" itemprop="dateModified" datetime="2021-08-24T11:05:51+08:00">2021-08-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="文字测量"><a href="#文字测量" class="headerlink" title="文字测量"></a>文字测量</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/08/20/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B603-%E6%96%87%E5%AD%97%E7%9A%84%E6%B5%8B%E9%87%8F/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/17/Jvm%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/17/Jvm%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Jvm原理解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-17 17:31:59" itemprop="dateCreated datePublished" datetime="2021-08-17T17:31:59+08:00">2021-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-20 10:23:05" itemprop="dateModified" datetime="2021-08-20T10:23:05+08:00">2021-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Jvm原理解析"><a href="#Jvm原理解析" class="headerlink" title="Jvm原理解析"></a>Jvm原理解析</h1><h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p> Java程序经过一次编译之后，将java代码编译为字节码也就是class文件，然后在不同的操作系统上依靠不同的Java虚拟机进行解释，最后再转换为不同平台的机器码。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/08/17/Jvm%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/17/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B602-Xfermode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/17/%E8%87%AA%E5%AE%9A%E4%B9%89view%E7%BB%98%E5%88%B602-Xfermode/" class="post-title-link" itemprop="url">自定义view绘制02-Xfermode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-17 12:10:56 / 修改时间：14:54:14" itemprop="dateCreated datePublished" datetime="2021-08-17T12:10:56+08:00">2021-08-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Xfermode完全使用解析"><a href="#Xfermode完全使用解析" class="headerlink" title="Xfermode完全使用解析"></a>Xfermode完全使用解析</h1><p>为什么要 Xfermode?为了把多次绘制进行「合成」，例如蒙版效果:用 A 的形状和 B 的图案</p>
<p>怎么做?</p>
<ol>
<li>Canvas.saveLayer() 把绘制区域拉到单独的离屏缓冲里</li>
<li>绘制 A 图形</li>
<li>用 Paint.setXfermode() 设置 Xfermode</li>
<li>绘制 B 图形</li>
<li>用 Paint.setXfermode(null) 恢复 Xfermode</li>
<li>用 Canvas.restoreToCount() 把离屏缓冲中的合成后的图形放回绘制区域</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> IMAGE_WIDTH = <span class="number">200f</span>.px</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> IMAGE_PADDING = <span class="number">20f</span>.px</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> XFERMODE = PorterDuffXfermode(PorterDuff.Mode.SRC_IN)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">var</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">    <span class="keyword">var</span> bounds = RectF()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSizeChanged</span><span class="params">(w: <span class="type">Int</span>, h: <span class="type">Int</span>, oldw: <span class="type">Int</span>, oldh: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh)</span><br><span class="line">        bounds.left = IMAGE_PADDING</span><br><span class="line">        bounds.top = IMAGE_PADDING</span><br><span class="line">        bounds.right = IMAGE_PADDING + IMAGE_WIDTH</span><br><span class="line">        bounds.bottom = IMAGE_PADDING + IMAGE_WIDTH</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line">        <span class="comment">//  把绘制区域拉到单独的离屏缓冲里</span></span><br><span class="line">        <span class="keyword">var</span> count = canvas.saveLayer(bounds,<span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// 绘制图形a</span></span><br><span class="line">        canvas.drawOval(</span><br><span class="line">            bounds,</span><br><span class="line">            paint</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// 设置 Xfermode，PorterDuff是创作者的名字，其他模式已经过时</span></span><br><span class="line">        paint.xfermode = XFERMODE</span><br><span class="line">        <span class="comment">//绘制图形b</span></span><br><span class="line">        canvas.drawBitmap(</span><br><span class="line">            getAvatar(IMAGE_WIDTH.toInt()),</span><br><span class="line">            IMAGE_PADDING, IMAGE_PADDING,</span><br><span class="line">            paint</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复 Xfermode</span></span><br><span class="line">        paint.xfermode = <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 把离屏缓冲中的合成后的图形放回绘制区域 count 记录了绘制状态</span></span><br><span class="line">        canvas.restoreToCount(count)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getAvatar</span><span class="params">(width: <span class="type">Int</span>)</span></span>: Bitmap &#123;</span><br><span class="line">        <span class="comment">// 利用option 可以提高读取bitmap的速度（只读取指定的大小）</span></span><br><span class="line">        <span class="keyword">val</span> options = BitmapFactory.Options()</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">true</span></span><br><span class="line">        BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">        options.inJustDecodeBounds = <span class="literal">false</span></span><br><span class="line">        options.inDensity = options.outWidth</span><br><span class="line">        options.inTargetDensity = width</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeResource(resources, R.drawable.avatar_rengwuxian, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么要用 saveLayer() 才能正确绘制 ?</p>
<p>为了把需要互相作用的图形放在单独的位置来绘制，不会受 View 本身的影响。 如果不使用 saveLayer()，绘制的目标区域将总是整个 View 的范围，两个图形 的交叉区域就错误了。</p>
<p>Ps</p>
<p>如果想做到像官网示例一样的效果，除了构建图形，还需要画出透明的bitmap底图</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> XFERMODE = PorterDuffXfermode(PorterDuff.Mode.SRC_IN)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.LOLLIPOP)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XfermodeView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> bounds = RectF(<span class="number">150f</span>.px, <span class="number">50f</span>.px, <span class="number">300f</span>.px, <span class="number">200f</span>.px)</span><br><span class="line">    <span class="comment">// 本来是100dp 为了符合官方文档，增加50dp作为底部画布，</span></span><br><span class="line">    <span class="comment">// 合成并不仅仅是所画的图形，透明的部分也会参与合成</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> circleBitmap = Bitmap.createBitmap(<span class="number">150f</span>.px.toInt(), <span class="number">150f</span>.px.toInt(), Bitmap.Config.ARGB_8888)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> squareBitmap = Bitmap.createBitmap(<span class="number">150f</span>.px.toInt(), <span class="number">150f</span>.px.toInt(), Bitmap.Config.ARGB_8888)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> canvas = Canvas(circleBitmap)</span><br><span class="line">        paint.color = Color.parseColor(<span class="string">&quot;#D81B60&quot;</span>)</span><br><span class="line">        canvas.drawOval(<span class="number">50f</span>.px, <span class="number">0f</span>.px, <span class="number">150f</span>.px, <span class="number">100f</span>.px, paint)</span><br><span class="line">        paint.color = Color.parseColor(<span class="string">&quot;#2196F3&quot;</span>)</span><br><span class="line">        canvas.setBitmap(squareBitmap)</span><br><span class="line">        canvas.drawRect(<span class="number">0f</span>.px, <span class="number">50f</span>.px, <span class="number">100f</span>.px, <span class="number">150f</span>.px, paint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> count = canvas.saveLayer(bounds, <span class="literal">null</span>)</span><br><span class="line">        canvas.drawBitmap(circleBitmap, <span class="number">150f</span>.px, <span class="number">50f</span>.px, paint)</span><br><span class="line">        paint.xfermode = XFERMODE</span><br><span class="line">        canvas.drawBitmap(squareBitmap, <span class="number">150f</span>.px, <span class="number">50f</span>.px, paint)</span><br><span class="line">        paint.xfermode = <span class="literal">null</span></span><br><span class="line">        canvas.restoreToCount(count)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oldnineping"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">oldnineping</p>
  <div class="site-description" itemprop="description">技术日记和杂七杂八的dx</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oldnineping</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
