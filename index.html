<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="技术日记和杂七杂八的dx">
<meta property="og:type" content="website">
<meta property="og:title" content="地球上的小东西">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="地球上的小东西">
<meta property="og:description" content="技术日记和杂七杂八的dx">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="oldnineping">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>地球上的小东西</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球上的小东西</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">hiahiahiahia</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/05/Gradle%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/05/Gradle%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Gradle详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-05 11:02:55 / 修改时间：14:10:04" itemprop="dateCreated datePublished" datetime="2022-01-05T11:02:55+08:00">2022-01-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Gradle配置文件拆解"><a href="#Gradle配置文件拆解" class="headerlink" title="Gradle配置文件拆解"></a>Gradle配置文件拆解</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/01/05/Gradle%E8%AF%A6%E8%A7%A3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/03/Lifecycle%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/03/Lifecycle%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Lifecycle原理解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-03 09:12:00" itemprop="dateCreated datePublished" datetime="2021-12-03T09:12:00+08:00">2021-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-22 15:32:58" itemprop="dateModified" datetime="2021-12-22T15:32:58+08:00">2021-12-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/JetPack/" itemprop="url" rel="index"><span itemprop="name">JetPack</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <a id="more"></a>
<h1 id="Lifecycle原理解析"><a href="#Lifecycle原理解析" class="headerlink" title="Lifecycle原理解析"></a>Lifecycle原理解析</h1><h2 id="什么是Lifecycle"><a href="#什么是Lifecycle" class="headerlink" title="什么是Lifecycle"></a>什么是Lifecycle</h2><p><strong>具备宿主声明后期感知能力的组件。</strong></p>
<ul>
<li><p>特性：它持有组件（如 Activity 或 Fragment）生命周期状态的信息，并且允许其他对象观察此状态。</p>
</li>
<li><p>添加依赖</p>
</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">api <span class="string">&#x27;androidx.appcompat:appcompat:1.1.0&#x27;</span></span><br><span class="line">api <span class="string">&#x27;androidx.lifecycler:lifecycle-common:2.1.0&#x27;</span></span><br></pre></td></tr></table></figure>
<!--more-->



<h2 id="如何使用Lifecycle观察宿主状态"><a href="#如何使用Lifecycle观察宿主状态" class="headerlink" title="如何使用Lifecycle观察宿主状态"></a>如何使用Lifecycle观察宿主状态</h2><p>有三种方法，继承LifecycleObserver，FullLifecyclerObserver或LifecycleEventObserver，三种方法无论哪种方式都需要在宿主中注册一下观察者。</p>
<ul>
<li>经典用法，实现LifecycleObserver</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">xxx</span>, <span class="title">LifecycleOwner</span> </span>&#123;</span><br><span class="line">LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPresenter</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span></span>&#123;</span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@NotNull</span> LifecycleOwner owner)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(<span class="meta">@NotNull</span> LifecycleOwner owner)</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getLifecycle().addObserver(mPresenter);<span class="comment">//注册观察者,观察宿主生命周期状态变化</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>继承LifecycleObserver，用注解的方式标记在每个方法上面，来观察宿主的生命周期变化的事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 自定义的LifecycleObserver观察者，用注解声明每个方法观察的宿主的状态</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocationObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span></span>&#123;</span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(<span class="meta">@NotNull</span> LifecycleOwner owner)</span></span>&#123;</span><br><span class="line">      <span class="comment">//开启定位</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_STOP)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">(<span class="meta">@NotNull</span> LifecycleOwner owner)</span></span>&#123;</span><br><span class="line">       <span class="comment">//停止定位</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 注册观察者,观察宿主生命周期状态变化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    MyLifecycleObserver observer =<span class="keyword">new</span> MyLifecycleObserver()</span><br><span class="line">    getLifecycle().addObserver(observer);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>FullLifecyclerObserver</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">FullLifecycleObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onResume</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPause</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(LifecycleOwner owner)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocationObserver</span> <span class="keyword">extends</span> <span class="title">FullLifecycleObserver</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(LifecycleOwner owner)</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStop</span><span class="params">(LifecycleOwner owner)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>LifecycleEventObserver</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleEventObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 所有生命周期发生变化的事件都会发送到这里</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocationObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleEventObserver</span></span>&#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span></span>&#123;</span><br><span class="line">      <span class="comment">//需要自行判断life-event是onstart, 还是onstop等事件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>推荐使用2，3种方法，不需要注解</p>
<h2 id="Fragment如何实现Lifecycle"><a href="#Fragment如何实现Lifecycle" class="headerlink" title="Fragment如何实现Lifecycle"></a>Fragment如何实现Lifecycle</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现 LifecycleOwner 表示它是一个宿主</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</span><br><span class="line">LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// 必须复写getLifecycle()，</span></span><br><span class="line">  <span class="comment">// Lifecycle是 LifecycleRegistry的父类，这里是一种面向接口的思想</span></span><br><span class="line">  <span class="comment">// 实际上我们注册Lifecycle的时候，都注册在LifecycleRegistry这个类中去了</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">      <span class="comment">//复写自LifecycleOwner,所以必须new LifecycleRegistry对象返回</span></span><br><span class="line">      <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// Fragment的每个生命周期的方法中，会让mLifecycleRegistry分发自己的状态到每一个观察者。</span></span><br><span class="line"><span class="comment">// 从而实现观察生命周期变化的能力</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performCreate</span><span class="params">()</span></span>&#123;</span><br><span class="line">     mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span></span>&#123;</span><br><span class="line">     mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">  &#125;</span><br><span class="line">  .....</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">performResume</span><span class="params">()</span></span>&#123;</span><br><span class="line">     mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LifecycleOwner、Lifecycle、LifecycleRegistry的关系"><a href="#LifecycleOwner、Lifecycle、LifecycleRegistry的关系" class="headerlink" title="LifecycleOwner、Lifecycle、LifecycleRegistry的关系"></a>LifecycleOwner、Lifecycle、LifecycleRegistry的关系</h2><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20211203102141678.png" alt="image-20211203102141678"></p>
<ul>
<li><p><strong>LifecycleOwner</strong>代表宿主，一般指Activity和Framgent，因为它们都实现了<strong>LifecycleOwner</strong>接口，当然我们也可以自己实现一个类实现接口让它成为生命周期的宿主，让其他观察者观察它的生命周期。</p>
</li>
<li><p><strong>LifecycleRegistry</strong>宿主复写了<strong>LifecycleOwner</strong>接口，必然要实现<strong>getLifecycle</strong>方法并且返回一个<strong>Lifecycle</strong>对象，它实际上是<strong>LifecycleRegistry</strong>，只不过采用了面向接口的编程方式。</p>
</li>
<li><p>我们向LifecycleRegistry注册观察着的时候它可以是</p>
<ul>
<li>LifecycleObserver</li>
<li>FullLifecycleObserver</li>
<li>LifecycleEventObserver</li>
</ul>
<p>它会在每个生命周期方法中让<strong>LifecycleRegistry</strong>发送事件给每个观察者</p>
</li>
</ul>
<h2 id="Activity如何实现Lifecycle"><a href="#Activity如何实现Lifecycle" class="headerlink" title="Activity如何实现Lifecycle"></a>Activity如何实现Lifecycle</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//我们通常使用的AppCompenentActivity是 ComponentActivity的子类</span></span><br><span class="line"><span class="comment">//和Fragment的一样，Activity同样实现了LifecycleOwner接口，来声明它是一个宿主</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// 复写getLifecycle() 返回一个Lifecycle对象（实际是LifecycleRegistry对象）</span></span><br><span class="line">   <span class="meta">@NonNull</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mLifecycleRegistry;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    	<span class="comment">//并没有像Fragment一样，在生命周期中用实际是LifecycleRegistry向观察者分发状态</span></span><br><span class="line">      <span class="comment">//往Activity上添加一个fragment,用以报告生命周期的变化</span></span><br><span class="line">      <span class="comment">//目的是为了兼顾不是继承自AppCompactActivity的场景.</span></span><br><span class="line">      ReportFragment.injectIfNeededIn(<span class="keyword">this</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ReportFragment</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span></span>&#123;</span><br><span class="line">  <span class="comment">// 将不可见的Fragment注入activity中</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">        <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">            manager.executePendingTransactions();</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">//生命周期中调用dispatch方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 拿到activity的LifecycleRegistry类，并分发状态</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">         Lifecycle lifecycle = activity.getLifecycle();</span><br><span class="line">         <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">             ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Lifecycle是如何分发宿主状态的"><a href="#Lifecycle是如何分发宿主状态的" class="headerlink" title="Lifecycle是如何分发宿主状态的"></a>Lifecycle是如何分发宿主状态的</h2><p>LifecycleRegistry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleRegistry</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">		<span class="comment">// 添加观察者时，生命周期事件 分发的流程</span></span><br><span class="line"> 		<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 得到一个 initialState对象</span></span><br><span class="line">      <span class="comment">// State指的是当前宿主的状态</span></span><br><span class="line">      <span class="comment">// 只要不是在DESTROYED下注册，初始状态都是INITIALIZED</span></span><br><span class="line">        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">      <span class="comment">// 将observer封装成一个ObserverWithState（拥有宿主状态的观察者）</span></span><br><span class="line">      <span class="comment">// 这里仅仅是简单的包装了一下并且把当前的状态传递了进去</span></span><br><span class="line">        ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">      <span class="comment">// statefulObserver添加到map集合当中</span></span><br><span class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 让观察者当前的状态琮INITIALIZED前进到宿主当前的状态</span></span><br><span class="line">      <span class="comment">// 在onResume中注册观察者，onCreate，onStart状态都会接收</span></span><br><span class="line">      <span class="comment">// 无论在哪里注册，你都能收到生命周期内完整的状态变化  </span></span><br><span class="line">        <span class="keyword">boolean</span> isReentrance = mAddingObserverCounter != <span class="number">0</span> || mHandlingEvent;</span><br><span class="line">      <span class="comment">// 通过calculateTargetState() 去计算出observer应该到达的状态（当前状态）</span></span><br><span class="line">        State targetState = calculateTargetState(observer);</span><br><span class="line">        mAddingObserverCounter++;</span><br><span class="line">      <span class="comment">// 观察者的状态和target比较</span></span><br><span class="line">      <span class="comment">// statefulObserver.mState.compareTo(targetState)&lt;0 </span></span><br><span class="line">      <span class="comment">// 代表观察者的状态 没有到达target的状态</span></span><br><span class="line">        <span class="keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; <span class="number">0</span></span><br><span class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">            pushParentState(statefulObserver.mState);</span><br><span class="line">         <span class="comment">// 实现生命周期前进</span></span><br><span class="line">         <span class="comment">// 调用封装的 observer 分发事件</span></span><br><span class="line">         <span class="comment">// 根据状态分发事件</span></span><br><span class="line">         <span class="comment">//1. upEvent  方法会让观察者根据状态决定应该接收哪个事件</span></span><br><span class="line">         <span class="comment">//2. dispatchEvent ,根据当前接收的事件，反推出一个新状态（状态前进了一步）</span></span><br><span class="line">         <span class="comment">//3. 调用dispatchEvent/LifecycleObserver.onStateChanged(owner, event);</span></span><br><span class="line">         <span class="comment">// 再次分发新的状态 直到观察者和 分发者状态一致</span></span><br><span class="line">            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">            popParentState();</span><br><span class="line">            <span class="comment">// mState / subling may have been changed recalculate</span></span><br><span class="line">            targetState = calculateTargetState(observer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">            <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">            sync();</span><br><span class="line">        &#125;</span><br><span class="line">        mAddingObserverCounter--;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 通过当前观察者的状态去判断应该接收哪个事件</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Event <span class="title">upEvent</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="comment">// 创建之初是 INITIALIZED ，应该接收 ON_CREATE 事件</span></span><br><span class="line">            <span class="keyword">case</span> INITIALIZED:</span><br><span class="line">            <span class="keyword">case</span> DESTROYED:</span><br><span class="line">                <span class="keyword">return</span> ON_CREATE;</span><br><span class="line">            <span class="keyword">case</span> CREATED:</span><br><span class="line">                <span class="keyword">return</span> ON_START;</span><br><span class="line">            <span class="keyword">case</span> STARTED:</span><br><span class="line">                <span class="keyword">return</span> ON_RESUME;</span><br><span class="line">            <span class="keyword">case</span> RESUMED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected state value &quot;</span> + state);</span><br><span class="line">    &#125; </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">     		State mState;</span><br><span class="line">        LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">          <span class="comment">// Lifecycling是区分observer是LifecycleObserver，FullLifecyclerObserver或LifecycleEventObserver的核心</span></span><br><span class="line">          <span class="comment">// Lifecycling是一个工具类，使用适配器模式将observer转换成 LifecycleEventObserver</span></span><br><span class="line">            mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">            mState = initialState;</span><br><span class="line">        &#125;</span><br><span class="line">			</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// 根据当前的Event事件，反推出一个新的state</span></span><br><span class="line">            State newState = getStateAfter(event);</span><br><span class="line">            mState = min(mState, newState);</span><br><span class="line">          <span class="comment">// 分发当前的状态</span></span><br><span class="line">            mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">            mState = newState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">static</span> State <span class="title">getStateAfter</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 当前接收事件 ON_CREATE ,现在状态应该是CREATED</span></span><br><span class="line">        <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">            <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">            <span class="keyword">case</span> ON_STOP:</span><br><span class="line">                <span class="keyword">return</span> CREATED;</span><br><span class="line">            <span class="keyword">case</span> ON_START:</span><br><span class="line">            <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">                <span class="keyword">return</span> STARTED;</span><br><span class="line">            <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">                <span class="keyword">return</span> RESUMED;</span><br><span class="line">            <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">                <span class="keyword">return</span> DESTROYED;</span><br><span class="line">            <span class="keyword">case</span> ON_ANY:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected event value &quot;</span> + event);</span><br><span class="line">    &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 宿主生命周期变化之后分发给观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 根据事件，推导出每个观察者应该到达的下一个生命周期状态</span></span><br><span class="line">        State next = getStateAfter(event);</span><br><span class="line">        moveToState(next);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</span><br><span class="line">       ... </span><br><span class="line">      <span class="comment">// 其他逻辑都是一些状态的判断，分发逻辑在sync</span></span><br><span class="line">        sync();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">				<span class="comment">//!isSynced() 方法：在mObserverMap集合中注册的observer，是不是所有的观察者的状态都分发完了，同步到和宿主一致的状态，若没有，则继续执行</span></span><br><span class="line">        <span class="keyword">while</span> (!isSynced()) &#123;</span><br><span class="line">            mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">				<span class="comment">// 比较每个观察者和宿主之间的状态， &lt; 0 代表宿主生命周期状态小于观察者的状态，此时处于生命周期倒退的阶段</span></span><br><span class="line">        <span class="comment">// 比如宿主从前台切换到了后台，执行onPause 方法，宿主进入STARTED状态，观察者此时还是RESUMED状态</span></span><br><span class="line">            <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// 集合中所有的观察者都倒退到和宿主一样的状态</span></span><br><span class="line">                backwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</span><br><span class="line">        <span class="comment">// 比较每个观察者和宿主之间的状态 ,&gt;0 代表宿主生命周期状态大于观察者的状态，此时处于生命周期前进的阶段</span></span><br><span class="line">            <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// 集合中所有的观察者都前进到和宿主一样的状态              </span></span><br><span class="line">                forwardPass(lifecycleOwner);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mNewEventOccurred = <span class="keyword">false</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// 生命周期后退</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next();</span><br><span class="line">            ObserverWithState observer = entry.getValue();</span><br><span class="line">            <span class="keyword">while</span> ((observer.mState.compareTo(mState) &gt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">              <span class="comment">// 根据 观察者当前的状态计算出应该分发的事件</span></span><br><span class="line">              <span class="comment">// 因为是生命周期的倒退，这里用的是downEvent</span></span><br><span class="line">                Event event = downEvent(observer.mState);</span><br><span class="line">                pushParentState(getStateAfter(event));</span><br><span class="line">              <span class="comment">// 将事件分发给 observer，并且根据当前事件推导出新的状态，</span></span><br><span class="line">              <span class="comment">// 直到所有观察者的状态和宿主一致，退出循环              </span></span><br><span class="line">                observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">                popParentState();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Event <span class="title">downEvent</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> INITIALIZED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">            <span class="keyword">case</span> CREATED:</span><br><span class="line">                <span class="keyword">return</span> ON_DESTROY;</span><br><span class="line">            <span class="keyword">case</span> STARTED:</span><br><span class="line">                <span class="keyword">return</span> ON_STOP;</span><br><span class="line">            <span class="keyword">case</span> RESUMED:</span><br><span class="line">                <span class="keyword">return</span> ON_PAUSE;</span><br><span class="line">            <span class="keyword">case</span> DESTROYED:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unexpected state value &quot;</span> + state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生命周期前进  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</span><br><span class="line">                mObserverMap.iteratorWithAdditions();</span><br><span class="line">        <span class="keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</span><br><span class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</span><br><span class="line">            ObserverWithState observer = entry.getValue();</span><br><span class="line">            <span class="keyword">while</span> ((observer.mState.compareTo(mState) &lt; <span class="number">0</span> &amp;&amp; !mNewEventOccurred</span><br><span class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</span><br><span class="line">                pushParentState(observer.mState);</span><br><span class="line">              <span class="comment">// 根据 观察者当前的状态计算出应该分发的事件</span></span><br><span class="line">              <span class="comment">// 因为是生命周期的前进，这里用的是upEvent</span></span><br><span class="line">              <span class="comment">// 最后将事件分发给 observer，并且根据当前事件推导出新的状态</span></span><br><span class="line">              <span class="comment">// 直到所有观察者的状态和宿主一致，退出循环</span></span><br><span class="line">                observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));</span><br><span class="line">                popParentState();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>State</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line">   <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">  <span class="comment">// event 和生命周期相同，state状态和生命周期并不是相同的</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">        ON_CREATE,</span><br><span class="line">        </span><br><span class="line">        ON_START,</span><br><span class="line">      </span><br><span class="line">        ON_RESUME,</span><br><span class="line">       </span><br><span class="line">        ON_PAUSE,</span><br><span class="line">      </span><br><span class="line">        ON_STOP,</span><br><span class="line">       </span><br><span class="line">        ON_DESTROY,</span><br><span class="line">  </span><br><span class="line">        ON_ANY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态（枚举）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    DESTROYED,</span><br><span class="line">  </span><br><span class="line">    INITIALIZED,</span><br><span class="line"></span><br><span class="line">    CREATED,</span><br><span class="line"></span><br><span class="line">    STARTED,</span><br><span class="line"></span><br><span class="line">    RESUMED;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lifecycling</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycling</span> </span>&#123;	</span><br><span class="line"> 		<span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> LifecycleEventObserver <span class="title">lifecycleEventObserver</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// 判断observer是否实现了LifecycleEventObserver接口</span></span><br><span class="line">        <span class="keyword">boolean</span> isLifecycleEventObserver = object <span class="keyword">instanceof</span> LifecycleEventObserver;</span><br><span class="line">      	<span class="comment">// 判断observer是否实现了FullLifecycleObserver接口</span></span><br><span class="line">        <span class="keyword">boolean</span> isFullLifecycleObserver = object <span class="keyword">instanceof</span> FullLifecycleObserver;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 通过FullLifecycleObserverAdapter 对生命周期的各种Event回调</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 若observer 同时实现了LifecycleEventObserver 和 FullLifecycleObserver</span></span><br><span class="line">        <span class="keyword">if</span> (isLifecycleEventObserver &amp;&amp; isFullLifecycleObserver) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FullLifecycleObserverAdapter((FullLifecycleObserver) object,</span><br><span class="line">                    (LifecycleEventObserver) object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 只实现了FullLifecycleObserver的observer</span></span><br><span class="line">        <span class="keyword">if</span> (isFullLifecycleObserver) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FullLifecycleObserverAdapter((FullLifecycleObserver) object, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 只实现了isLifecycleEventObserver的observer</span></span><br><span class="line">        <span class="keyword">if</span> (isLifecycleEventObserver) &#123;</span><br><span class="line">            <span class="keyword">return</span> (LifecycleEventObserver) object;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 若observer仅仅实现了 LifecycleObserver，就要通过反射或者依赖包来实现</span></span><br><span class="line">        <span class="comment">// 因为LifecycleObserver是空实现，仅仅是作为一种规范和约束，</span></span><br><span class="line">        <span class="comment">// 所以对于只实现了 LifecycleObserver的观察者，有两种方法来实现事件的通知</span></span><br><span class="line">        <span class="comment">// 1. </span></span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; klass = object.getClass();</span><br><span class="line">        <span class="keyword">int</span> type = getObserverConstructorType(klass);</span><br><span class="line">        <span class="keyword">if</span> (type == GENERATED_CALLBACK) &#123;</span><br><span class="line">            List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; constructors =</span><br><span class="line">                    sClassToAdapters.get(klass);</span><br><span class="line">            <span class="keyword">if</span> (constructors.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                GeneratedAdapter generatedAdapter = createGeneratedAdapter(</span><br><span class="line">                        constructors.get(<span class="number">0</span>), object);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SingleGeneratedAdapterObserver(generatedAdapter);</span><br><span class="line">            &#125;</span><br><span class="line">            GeneratedAdapter[] adapters = <span class="keyword">new</span> GeneratedAdapter[constructors.size()];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; constructors.size(); i++) &#123;</span><br><span class="line">                adapters[i] = createGeneratedAdapter(constructors.get(i), object);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// 如果使用了 lifecycle-compiler 依赖 ，compiler是编译的意思，里面包含一个注解处理器啊，它会在编译阶段生成适配的类	</span></span><br><span class="line">          <span class="comment">// 如果使用了这个依赖，就不需要利用反射实现这些方法了</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CompositeGeneratedAdaptersObserver(adapters);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 用nvokeMethod 方法，反射的方式调用自定义的观察者当中的相关方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveGenericLifecycleObserver(object);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> GeneratedAdapter <span class="title">createGeneratedAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Constructor&lt;? extends GeneratedAdapter&gt; constructor, Object object)</span> </span>&#123;</span><br><span class="line">       ....</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// 若没有 lifecycle-compiler依赖，</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends GeneratedAdapter&gt; generatedConstructor(Class&lt;?&gt; klass) &#123;</span><br><span class="line">       <span class="comment">// klass 对象就是observer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//得到包名</span></span><br><span class="line">            Package aPackage = klass.getPackage();</span><br><span class="line">           <span class="comment">// 得到类名</span></span><br><span class="line">            String name = klass.getCanonicalName();</span><br><span class="line">            <span class="keyword">final</span> String fullPackage = aPackage != <span class="keyword">null</span> ? aPackage.getName() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">           <span class="comment">//adaptername 就是全类名+&quot;_LifecycleAdapter&quot;</span></span><br><span class="line">            <span class="keyword">final</span> String adapterName = getAdapterName(fullPackage.isEmpty() ? name :</span><br><span class="line">                    name.substring(fullPackage.length() + <span class="number">1</span>));</span><br><span class="line">						</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="keyword">final</span> Class&lt;? extends GeneratedAdapter&gt; aClass =</span><br><span class="line">                    (Class&lt;? extends GeneratedAdapter&gt;) Class.forName(</span><br><span class="line">                            fullPackage.isEmpty() ? adapterName : fullPackage + <span class="string">&quot;.&quot;</span> + adapterName);</span><br><span class="line">            <span class="comment">//反射加载这个类getDeclaredConstructor </span></span><br><span class="line">            <span class="comment">//若这个阶段没有异常说明这个类是存在的，也就说明依赖了这个compiler编译器</span></span><br><span class="line">            <span class="comment">//若抛出异常证明没有引用</span></span><br><span class="line">            Constructor&lt;? extends GeneratedAdapter&gt; constructor =</span><br><span class="line">                    aClass.getDeclaredConstructor(klass);</span><br><span class="line">            <span class="keyword">if</span> (!constructor.isAccessible()) &#123;</span><br><span class="line">                constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> constructor;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="comment">// this should not happen</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAdapterName</span><span class="params">(String className)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> className.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;_&quot;</span>) + <span class="string">&quot;_LifecycleAdapter&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FullLifecycleObserverAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FullLifecycleObserverAdapter</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FullLifecycleObserver mFullLifecycleObserver;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LifecycleEventObserver mLifecycleEventObserver;</span><br><span class="line"></span><br><span class="line">    FullLifecycleObserverAdapter(FullLifecycleObserver fullLifecycleObserver,</span><br><span class="line">            LifecycleEventObserver lifecycleEventObserver) &#123;</span><br><span class="line">        mFullLifecycleObserver = fullLifecycleObserver;</span><br><span class="line">        mLifecycleEventObserver = lifecycleEventObserver;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">/// 给 FullLifecycleObserver 传 Event</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">            <span class="keyword">case</span> ON_CREATE:</span><br><span class="line">                mFullLifecycleObserver.onCreate(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_START:</span><br><span class="line">                mFullLifecycleObserver.onStart(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_RESUME:</span><br><span class="line">                mFullLifecycleObserver.onResume(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_PAUSE:</span><br><span class="line">                mFullLifecycleObserver.onPause(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_STOP:</span><br><span class="line">                mFullLifecycleObserver.onStop(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_DESTROY:</span><br><span class="line">                mFullLifecycleObserver.onDestroy(source);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ON_ANY:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;ON_ANY must not been send by anybody&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 给mLifecycleEventObserver 传Event</span></span><br><span class="line">        <span class="keyword">if</span> (mLifecycleEventObserver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLifecycleEventObserver.onStateChanged(source, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ReflectiveGenericLifecycleObserver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReflectiveGenericLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleEventObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mWrapped;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CallbackInfo mInfo;</span><br><span class="line"></span><br><span class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;</span><br><span class="line">        mWrapped = wrapped;</span><br><span class="line">        mInfo = ClassesInfoCache.sInstance.getInfo(mWrapped.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Event event)</span> </span>&#123;</span><br><span class="line">        mInfo.invokeCallbacks(source, event, mWrapped);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="宿主生命周期和状态模型图"><a href="#宿主生命周期和状态模型图" class="headerlink" title="宿主生命周期和状态模型图"></a>宿主生命周期和状态模型图</h3><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20211203112115366.png" alt="image-20211203112115366"></p>
<ul>
<li>添加observer时,完整的生命周期事件分发</li>
</ul>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20211203162451814.png" alt="image-20211203162451814"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/02/UniApp%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/02/UniApp%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">UniApp学习总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-02 13:58:23" itemprop="dateCreated datePublished" datetime="2021-12-02T13:58:23+08:00">2021-12-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/15/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90RecyclerView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/15/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90RecyclerView/" class="post-title-link" itemprop="url">从源码到原理剖析RecyclerView</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-15 10:55:45" itemprop="dateCreated datePublished" datetime="2021-11-15T10:55:45+08:00">2021-11-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-02 13:54:21" itemprop="dateModified" datetime="2021-12-02T13:54:21+08:00">2021-12-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/RecyclerView/" itemprop="url" rel="index"><span itemprop="name">RecyclerView</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="从源码到原理剖析RecyclerView"><a href="#从源码到原理剖析RecyclerView" class="headerlink" title="从源码到原理剖析RecyclerView"></a>从源码到原理剖析RecyclerView</h1><ul>
<li>RecyclerView家族图谱</li>
<li>LinearLayoutManager布局流程分析</li>
<li>Recyler 复用回收管理</li>
<li>自定义LayoutManager支持吸顶悬浮</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/11/15/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90RecyclerView/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/18/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/18/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-18 23:39:59" itemprop="dateCreated datePublished" datetime="2021-10-18T23:39:59+08:00">2021-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-22 18:05:54" itemprop="dateModified" datetime="2021-10-22T18:05:54+08:00">2021-10-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="应用启动流程"><a href="#应用启动流程" class="headerlink" title="应用启动流程"></a>应用启动流程</h1><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20211018223551829.png" alt="image-20211018223551829"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/18/%E6%B3%9B%E5%9E%8B%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/18/%E6%B3%9B%E5%9E%8B%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">泛型详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-18 15:05:48" itemprop="dateCreated datePublished" datetime="2021-10-18T15:05:48+08:00">2021-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-07 11:18:51" itemprop="dateModified" datetime="2022-01-07T11:18:51+08:00">2022-01-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B3%9B%E5%9E%8B/" itemprop="url" rel="index"><span itemprop="name">泛型</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="泛型详解"><a href="#泛型详解" class="headerlink" title="泛型详解"></a>泛型详解</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/10/18/%E6%B3%9B%E5%9E%8B%E8%AF%A6%E8%A7%A3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/17/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E4%B8%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A0%B8%E5%BF%83%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/17/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E4%B8%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A0%B8%E5%BF%83%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-17 22:00:34" itemprop="dateCreated datePublished" datetime="2021-10-17T22:00:34+08:00">2021-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-02 13:54:16" itemprop="dateModified" datetime="2021-12-02T13:54:16+08:00">2021-12-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uniapp/" itemprop="url" rel="index"><span itemprop="name">uniapp</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uniapp/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" itemprop="url" rel="index"><span itemprop="name">微信小程序</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="小程序前置知识与小程序核心语法"><a href="#小程序前置知识与小程序核心语法" class="headerlink" title="小程序前置知识与小程序核心语法"></a>小程序前置知识与小程序核心语法</h1><h2 id="认识小程序"><a href="#认识小程序" class="headerlink" title="认识小程序"></a>认识小程序</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>根据官网文档进行微信公众平台小程序账号申请：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p>
<p>下载<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wxamp/thirdtools/extend?token=792253097&lang=zh_CN">开发工具</a>并新建项目</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/10/17/%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E4%B8%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%A0%B8%E5%BF%83%E8%AF%AD%E6%B3%95/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/08/View%E7%9A%84%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/08/View%E7%9A%84%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">View的触摸反馈原理全解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-08 14:49:26" itemprop="dateCreated datePublished" datetime="2021-10-08T14:49:26+08:00">2021-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-30 14:07:09" itemprop="dateModified" datetime="2021-12-30T14:07:09+08:00">2021-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/view%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88/" itemprop="url" rel="index"><span itemprop="name">view触摸反馈</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="View的触摸反馈原理全解析"><a href="#View的触摸反馈原理全解析" class="headerlink" title="View的触摸反馈原理全解析"></a>View的触摸反馈原理全解析</h1><h2 id="自定义单-View-的触摸反馈"><a href="#自定义单-View-的触摸反馈" class="headerlink" title="自定义单 View 的触摸反馈"></a>自定义单 View 的触摸反馈</h2><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20211010105327764.png" alt="image-20211010105327764" style="zoom:50%;">

<ol>
<li><p>重写 onTouchEvent()，在方法内部定制触摸反馈算法</p>
<ol>
<li><p>是否消费事件取决于 ACTION_DOWN 事件是否返回 true</p>
</li>
<li><p>MotionEvent</p>
<ul>
<li><p>getActionMasked() 和 getAction() 怎么选?</p>
<p>选 getActionMasked()。因为到了多点触控时代，getAction() 已经不够准确</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 在Android增加多点触控的机制后</span></span><br><span class="line"><span class="comment">// MotionEvent除了包含触摸状态也包含了多点触控信息</span></span><br><span class="line">    <span class="comment">// 所以判断时事件时actionMasked最合适</span></span><br><span class="line">    <span class="comment">// 触摸事件</span></span><br><span class="line">    MotionEvent.ACTION_UP</span><br><span class="line">    MotionEvent.ACTION_DOWN</span><br><span class="line">    MotionEvent.ACTION_CANCEL</span><br><span class="line">    MotionEvent.ACTION_MOVE</span><br><span class="line">    <span class="comment">// 多点触控， +1 ，+2 表示第几根手指触碰</span></span><br><span class="line">    MotionEvent.ACTION_POINTER_DOWN</span><br><span class="line">    MotionEvent.ACTION_POINTER_UP</span><br></pre></td></tr></table></figure>


</li>
<li><p>那为什么有些地方(包括 Android 源码里)依然在用 getAction()? </p>
<p>因为它们的场景不考虑多点触控</p>
</li>
</ul>
</li>
<li><p>POINTER_DOWN / POINTER_UP:多点触控时的事件</p>
<ul>
<li>getActionIndex():多点触控时用到的方法</li>
</ul>
</li>
</ol>
</li>
</ol>
<h2 id="View-onTouchEvent-的源码逻辑"><a href="#View-onTouchEvent-的源码逻辑" class="headerlink" title="View.onTouchEvent() 的源码逻辑"></a>View.onTouchEvent() 的源码逻辑</h2><ol>
<li><p>当用户按下(ACTION_DOWN):</p>
<ul>
<li>如果不在滑动控件中，切换至按下状态，并注册⻓按计时器</li>
<li>如果在滑动控件中，切换至预按下状态，并注册按下计时器</li>
</ul>
</li>
<li><p>当进入按下状态并移动(ACTION_MOVE):</p>
<ul>
<li><p>重绘 Ripple Effect</p>
</li>
<li><p>如果移动出自己的范围，自我标记本次事件失效，忽略后续事件</p>
</li>
</ul>
</li>
<li><p>当用户抬起(ACTION_UP):</p>
<ul>
<li>如果是按下状态并且未触发⻓按，切换至抬起状态并触发点击事件，并清除一切状态</li>
<li>如果已经触发⻓按，切换至抬起状态并清除一切状态</li>
</ul>
</li>
<li><p>当事件意外结束(ACTION_CANCEL):</p>
<ul>
<li>切换至抬起状态，并清除一切状态</li>
</ul>
</li>
</ol>
<blockquote>
<p>Tool Tip:新版 Android 加入的「⻓按提示」功能。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> x = event.getX();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">float</span> y = event.getY();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = event.getAction();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE</span><br><span class="line">            || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</span><br><span class="line">            || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">            setPressed(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">        <span class="comment">// A disabled view that is clickable still consumes the touch</span></span><br><span class="line">        <span class="comment">// events, it just doesn&#x27;t respond to them.</span></span><br><span class="line">        <span class="keyword">return</span> clickable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">                mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                <span class="keyword">if</span> ((viewFlags &amp; TOOLTIP) == TOOLTIP) &#123;</span><br><span class="line">                    handleTooltipUp();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!clickable) &#123;</span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    mInContextButtonPress = <span class="keyword">false</span>;</span><br><span class="line">                    mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line">                    mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span> || prepressed) &#123;</span><br><span class="line">                    <span class="comment">// take focus if we don&#x27;t have it already and we should in</span></span><br><span class="line">                    <span class="comment">// touch mode.</span></span><br><span class="line">                    <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</span><br><span class="line">                        focusTaken = requestFocus();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                        <span class="comment">// The button is being released before we actually</span></span><br><span class="line">                        <span class="comment">// showed it as pressed.  Make it show the pressed</span></span><br><span class="line">                        <span class="comment">// state now (before scheduling the click) to ensure</span></span><br><span class="line">                        <span class="comment">// the user sees it.</span></span><br><span class="line">                        setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</span><br><span class="line">                        <span class="comment">// This is a tap, so remove the longpress check</span></span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// Only perform take click actions if we were in the pressed state</span></span><br><span class="line">                        <span class="keyword">if</span> (!focusTaken) &#123;</span><br><span class="line">                            <span class="comment">// Use a Runnable and post this rather than calling</span></span><br><span class="line">                            <span class="comment">// performClick directly. This lets other visual state</span></span><br><span class="line">                            <span class="comment">// of the view update before click actions start.</span></span><br><span class="line">                            <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                mPerformClick = <span class="keyword">new</span> PerformClick();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (!post(mPerformClick)) &#123;</span><br><span class="line">                                performClickInternal();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (prepressed) &#123;</span><br><span class="line">                        postDelayed(mUnsetPressedState,</span><br><span class="line">                                ViewConfiguration.getPressedStateDuration());</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) &#123;</span><br><span class="line">                        <span class="comment">// If the post failed, unpress right now</span></span><br><span class="line">                        mUnsetPressedState.run();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                &#125;</span><br><span class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                <span class="keyword">if</span> (event.getSource() == InputDevice.SOURCE_TOUCHSCREEN) &#123;</span><br><span class="line">                    mPrivateFlags3 |= PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!clickable) &#123;</span><br><span class="line">                    checkForLongClick(</span><br><span class="line">                            ViewConfiguration.getLongPressTimeout(),</span><br><span class="line">                            x,</span><br><span class="line">                            y,</span><br><span class="line">                            TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__LONG_PRESS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (performButtonActionOnTouchDown(event)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Walk up the hierarchy to determine if we&#x27;re inside a scrolling container.</span></span><br><span class="line">                <span class="keyword">boolean</span> isInScrollingContainer = isInScrollingContainer();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For views inside a scrolling container, delay the pressed feedback for</span></span><br><span class="line">                <span class="comment">// a short period in case this is a scroll.</span></span><br><span class="line">                <span class="keyword">if</span> (isInScrollingContainer) &#123;</span><br><span class="line">                    mPrivateFlags |= PFLAG_PREPRESSED;</span><br><span class="line">                    <span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPendingCheckForTap.x = event.getX();</span><br><span class="line">                    mPendingCheckForTap.y = event.getY();</span><br><span class="line">                    postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Not inside a scrolling container, so show the feedback right away</span></span><br><span class="line">                    setPressed(<span class="keyword">true</span>, x, y);</span><br><span class="line">                    checkForLongClick(</span><br><span class="line">                            ViewConfiguration.getLongPressTimeout(),</span><br><span class="line">                            x,</span><br><span class="line">                            y,</span><br><span class="line">                            TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__LONG_PRESS);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                <span class="keyword">if</span> (clickable) &#123;</span><br><span class="line">                    setPressed(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                removeTapCallback();</span><br><span class="line">                removeLongPressCallback();</span><br><span class="line">                mInContextButtonPress = <span class="keyword">false</span>;</span><br><span class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</span><br><span class="line">                mIgnoreNextUpEvent = <span class="keyword">false</span>;</span><br><span class="line">                mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="keyword">if</span> (clickable) &#123;</span><br><span class="line">                    drawableHotspotChanged(x, y);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionClassification = event.getClassification();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> ambiguousGesture =</span><br><span class="line">                        motionClassification == MotionEvent.CLASSIFICATION_AMBIGUOUS_GESTURE;</span><br><span class="line">                <span class="keyword">int</span> touchSlop = mTouchSlop;</span><br><span class="line">                <span class="keyword">if</span> (ambiguousGesture &amp;&amp; hasPendingLongPressCallback()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!pointInView(x, y, touchSlop)) &#123;</span><br><span class="line">                        <span class="comment">// The default action here is to cancel long press. But instead, we</span></span><br><span class="line">                        <span class="comment">// just extend the timeout here, in case the classification</span></span><br><span class="line">                        <span class="comment">// stays ambiguous.</span></span><br><span class="line">                        removeLongPressCallback();</span><br><span class="line">                        <span class="keyword">long</span> delay = (<span class="keyword">long</span>) (ViewConfiguration.getLongPressTimeout()</span><br><span class="line">                                * mAmbiguousGestureMultiplier);</span><br><span class="line">                        <span class="comment">// Subtract the time already spent</span></span><br><span class="line">                        delay -= event.getEventTime() - event.getDownTime();</span><br><span class="line">                        checkForLongClick(</span><br><span class="line">                                delay,</span><br><span class="line">                                x,</span><br><span class="line">                                y,</span><br><span class="line">                                TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__LONG_PRESS);</span><br><span class="line">                    &#125;</span><br><span class="line">                    touchSlop *= mAmbiguousGestureMultiplier;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Be lenient about moving outside of buttons</span></span><br><span class="line">                <span class="keyword">if</span> (!pointInView(x, y, touchSlop)) &#123;</span><br><span class="line">                    <span class="comment">// Outside button</span></span><br><span class="line">                    <span class="comment">// Remove any future long press/tap checks</span></span><br><span class="line">                    removeTapCallback();</span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</span><br><span class="line">                        setPressed(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mPrivateFlags3 &amp;= ~PFLAG3_FINGER_DOWN;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> deepPress =</span><br><span class="line">                        motionClassification == MotionEvent.CLASSIFICATION_DEEP_PRESS;</span><br><span class="line">                <span class="keyword">if</span> (deepPress &amp;&amp; hasPendingLongPressCallback()) &#123;</span><br><span class="line">                    <span class="comment">// process the long click action immediately</span></span><br><span class="line">                    removeLongPressCallback();</span><br><span class="line">                    checkForLongClick(</span><br><span class="line">                            <span class="number">0</span> <span class="comment">/* send immediately */</span>,</span><br><span class="line">                            x,</span><br><span class="line">                            y,</span><br><span class="line">                            TOUCH_GESTURE_CLASSIFIED__CLASSIFICATION__DEEP_PRESS);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="自定义-ViewGroup-的触摸反馈"><a href="#自定义-ViewGroup-的触摸反馈" class="headerlink" title="自定义 ViewGroup 的触摸反馈"></a>自定义 ViewGroup 的触摸反馈</h2><p>除了重写 onTouchEvent() ，还需要重写 onInterceptTouchEvent(), onInterceptTouchEvent() 不用在第一时间返回 true，而是在任意一个事件里， 需要拦截的时候返回 true 就行<br> 在 onInterceptTouchEvent() 中除了判断拦截，还要做好拦截之后的工作的准备工作(主要和 onTouchEvent() 的代码逻辑一致)</p>
<h2 id="触摸反馈的流程"><a href="#触摸反馈的流程" class="headerlink" title="触摸反馈的流程"></a>触摸反馈的流程</h2><ul>
<li>Activity.dispatchTouchEvent()<ul>
<li>递归: ViewGroup(View).dispatchTouchEvent()</li>
<li>ViewGroup.onInterceptTouchEvent()</li>
<li>child.dispatchTouchEvent()</li>
<li>super.dispatchTouchEvent()<ul>
<li>View.onTouchEvent()</li>
</ul>
</li>
<li>Activity.onTouchEvent()</li>
</ul>
</li>
</ul>
<h2 id="View-dispatchTouchEvent"><a href="#View-dispatchTouchEvent" class="headerlink" title="View.dispatchTouchEvent()"></a>View.dispatchTouchEvent()</h2><ul>
<li>如果设置了 OnTouchListener，调用 OnTouchListener.onTouch()<ul>
<li>如果 OnTouchListener 消费了事件，返回 true</li>
<li>如果 OnTouchListener 没有消费事件，继续调用自己的 onTouchEvent()， 并返回和 onTouchEvent() 相同的结果</li>
</ul>
</li>
<li>如果没有设置 OnTouchListener，同上</li>
</ul>
<h2 id="ViewGroup-dispatchTouchEvent"><a href="#ViewGroup-dispatchTouchEvent" class="headerlink" title="ViewGroup.dispatchTouchEvent()"></a>ViewGroup.dispatchTouchEvent()</h2><ul>
<li>如果是用户初次按下(ACTION_DOWN)，清空 TouchTargets 和 DISALLOW_INTERCEPT 标记</li>
<li>拦截处理</li>
<li>如果不      拦截并且不是 CANCEL 事件，并且是 DOWN 者 POINTER_DOWN，尝 试把 pointer(手指)通过 TouchTarget 分配给子 View;并且如果分配给了新 的子 View，调用 child.dispatchTouchEvent() 把事件传给子 View</li>
<li>看有没有 TouchTarget<ul>
<li>如果没有，调用自己的 super.dispatchTouchEvent()</li>
<li>如果有，调用 child.dispatchTouchEvent() 把事件传给对应的子 View(如果有的话)</li>
</ul>
</li>
<li>如果是 POINTER_UP，从 TouchTargets 中清除 POINTER 信息;如果是 UP 或 CANCEL，重置状态</li>
</ul>
<h2 id="TouchTarget"><a href="#TouchTarget" class="headerlink" title="TouchTarget"></a>TouchTarget</h2><ul>
<li>作用:记录每个子 View 是被哪些 pointer(手指)按下的</li>
<li>结构:单向链表</li>
</ul>
<p>​                          -                                                                       </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">自定义view布局02:View绘制流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-07 17:58:44" itemprop="dateCreated datePublished" datetime="2021-09-07T17:58:44+08:00">2021-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-01 18:20:10" itemprop="dateModified" datetime="2021-11-01T18:20:10+08:00">2021-11-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="View-绘制流程"><a href="#View-绘制流程" class="headerlink" title="View 绘制流程"></a>View 绘制流程</h1><h2 id="View-绘制流程主要对象图示"><a href="#View-绘制流程主要对象图示" class="headerlink" title="View 绘制流程主要对象图示"></a>View 绘制流程主要对象图示</h2><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180408351.png" alt=" "></p>
<h2 id="View绘制流程函数调用"><a href="#View绘制流程函数调用" class="headerlink" title="View绘制流程函数调用"></a>View绘制流程函数调用</h2><p>虚线表示至少一次消息处理(API29  之后)</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180743677.png" alt="image-20210907180743677"></p>
<p>1.</p>
<h2 id="Activity与View"><a href="#Activity与View" class="headerlink" title="Activity与View"></a>Activity与View</h2><p>Activity与View是通过PhoneWindow(Window) 对象关联的</p>
<p>Activity 与通过attach()方法Window（实际是PhoneWIndow）关联，</p>
<p>Window通过setContentView()与View关联</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165219071.png" alt="image-20210908165219071"></p>
<h3 id="Activity的实例化和生命周期"><a href="#Activity的实例化和生命周期" class="headerlink" title="Activity的实例化和生命周期"></a>Activity的实例化和生命周期</h3><p>ActivityThread类负责实例化Acitivty类并调用Activity的生命周期方法</p>
<p>所谓的</p>
<p>ActivityThread类中的</p>
<ul>
<li><code>handleLaunchActivity()</code>-&gt;<code>performLaunchActivity()</code>方法会实例化Activity对象并调用Activity对象的onCreate()</li>
<li><code>handleStartActivity()</code>方法调用Activity的onStart()</li>
<li><code>handleResumeActivity()</code>-&gt;<code> performResumeActivity()</code>方法调用Activity的<code>onResume()</code></li>
</ul>
<h4 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a>ActivityThread</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用onCreate</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">          PendingTransactionActions pendingActions, Intent customIntent) &#123;</span><br><span class="line">...                                         </span><br><span class="line">       <span class="comment">// 实例化Activity对象</span></span><br><span class="line">      <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);                                  		...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">     ...</span><br><span class="line">        Activity activity = <span class="literal">null</span>;</span><br><span class="line">    		java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">    			<span class="comment">//调用Instrumentation.newActivity() 方法创建一个Activity对象并返回</span></span><br><span class="line">          activity = mInstrumentation.newActivity(</span><br><span class="line">                  cl, component.getClassName(), r.intent);</span><br><span class="line">     ...</span><br><span class="line">    <span class="comment">// 调用activity  attach方法</span></span><br><span class="line">    activity.attach(appContext,...);</span><br><span class="line">   		 ...</span><br><span class="line">    <span class="comment">// 最终会调用 activity onCreate方法</span></span><br><span class="line">    <span class="comment">// 通过 Instrumentation.callActivityOnCreate() 调用</span></span><br><span class="line">    <span class="comment">// 所以可以看出Activity onCreate() 调用发生在 attach() 方法之后</span></span><br><span class="line">    <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">              &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用resume </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> void  (IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 调用Activity onResume方法</span></span><br><span class="line">      <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">		...</span><br><span class="line">      <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">          <span class="comment">// 也就是PhoneWindow</span></span><br><span class="line">          r.window = r.activity.getWindow();</span><br><span class="line">          View decor = r.window.getDecorView();</span><br><span class="line">					<span class="comment">// 获得的是  WindowManagerImpl </span></span><br><span class="line">          ViewManager wm = a.getWindowManager();</span><br><span class="line">          <span class="comment">// 获得窗口属性</span></span><br><span class="line">          WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">          a.mDecor = decor;</span><br><span class="line">         </span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                  a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 将decorView窗口属性放进去</span></span><br><span class="line">                <span class="comment">// 使用的是 WindowManagerImpl 的addView 方法</span></span><br><span class="line">                  wm.addView(decor, l);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// The activity will get a callback for this &#123;@link LayoutParams&#125; change</span></span><br><span class="line">                  <span class="comment">// earlier. However, at that time the decor will not be set (this is set</span></span><br><span class="line">                  <span class="comment">// in this method), so no action will be taken. This call ensures the</span></span><br><span class="line">                  <span class="comment">// callback occurs with the decor set.</span></span><br><span class="line">                  a.onWindowAttributesChanged(l);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@VisibleForTesting</span><span class="comment">// 会调用 activity的onResume方法</span></span><br><span class="line">  <span class="keyword">public</span> ActivityClientRecord performResumeActivity(IBinder token, boolean finalStateRequest,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">   r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="实例化Activity"><a href="#实例化Activity" class="headerlink" title="实例化Activity"></a>实例化Activity</h4><p>利用反射实例化Activity</p>
<h5 id="Instrumentation-newActivity"><a href="#Instrumentation-newActivity" class="headerlink" title="Instrumentation.newActivity()"></a>Instrumentation.newActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    String pkg = intent != <span class="keyword">null</span> &amp;&amp; intent.getComponent() != <span class="keyword">null</span></span><br><span class="line">            ? intent.getComponent().getPackageName() : <span class="keyword">null</span>;</span><br><span class="line">          <span class="comment">// instantiateActivity方法 利用反射实例化Activity对象 </span></span><br><span class="line">    <span class="keyword">return</span> getFactory(pkg).instantiateActivity(cl, className, intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">Activity <span class="title">instantiateActivity</span><span class="params">(<span class="meta">@NonNull</span> ClassLoader cl, <span class="meta">@NonNull</span> String className, <span class="meta">@Nullable</span> Intent intent)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">       <span class="comment">// 反射实例化Activity对象  </span></span><br><span class="line">        <span class="keyword">return</span> (Activity) cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Activity生命周期方法"><a href="#Activity生命周期方法" class="headerlink" title="Activity生命周期方法"></a>Activity生命周期方法</h3><h4 id="attach"><a href="#attach" class="headerlink" title="attach()"></a>attach()</h4><p>它是Activity内部的初始化方法(activity对象创建出来后就马上调用)</p>
<p><code>attach() </code>的调用发生在<code>onCreate()</code>之前</p>
<p>被<code>ActivityThread</code>调用，在<code> handleLaunchActivity()</code>-&gt; <code> -</code>&gt; <code>activity.attach(appContext,...);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// Window 对象被赋值</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">		...</span><br><span class="line">      <span class="comment">// 对Window设置WindowManager</span></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);   </span><br><span class="line">	  <span class="comment">// 对Activity的 WindowManager赋值， get出来的是 WindowManagerImpl </span></span><br><span class="line">   mWindowManager = mWindow.getWindowManager();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h4 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate()"></a>onCreate()</h4><p>和attach()一样被ActivityThread调用，在</p>
<p><code>ActivityThread.handleLaunchActivity()</code>-&gt; <code>ActivityThread.performLaunchActivity()</code>-&gt;</p>
<p><code>Instrumentation.callActivityOnCreate()</code>-&gt;<code>Activity.performCreate()</code>-&gt;<code>Activity.onCreate()</code></p>
<h5 id="Instrumentation-callActivityOnCreate"><a href="#Instrumentation-callActivityOnCreate" class="headerlink" title="Instrumentation.callActivityOnCreate()"></a>Instrumentation.callActivityOnCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">        PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//调用Acitivity 对象的 performCreate() </span></span><br><span class="line">    <span class="comment">// performCreate() 会调用内部的onCreate方法</span></span><br><span class="line">    activity.performCreate(icicle, persistentState);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Activity-performCreate"><a href="#Activity-performCreate" class="headerlink" title="Activity.performCreate()"></a>Activity.performCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">  			<span class="comment">// 调用onCreate方法</span></span><br><span class="line">        <span class="keyword">if</span> (persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">            onCreate(icicle, persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onCreate(icicle);</span><br><span class="line">        &#125;</span><br><span class="line">        ..</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="onResume"><a href="#onResume" class="headerlink" title="onResume()"></a>onResume()</h4><p><code>ActivityThread.handleResumeActivity()</code>-&gt;<code>ActivityThread.performResumeActivity()</code>-&gt;</p>
<p><code>Activity.performResume()</code>-&gt;<code>Instrumentation.callActivityOnResume()</code>-&gt;<code>Activity.OnResume()</code></p>
<h5 id="Activity-performResume"><a href="#Activity-performResume" class="headerlink" title="Activity.performResume()"></a>Activity.performResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">(<span class="keyword">boolean</span> followedByPause, String reason)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">  ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Instrumentation-callActivityOnResume"><a href="#Instrumentation-callActivityOnResume" class="headerlink" title="Instrumentation.callActivityOnResume()"></a>Instrumentation.callActivityOnResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">    activity.onResume();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                am.match(activity, activity, activity.getIntent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Activity-setContentView"><a href="#Activity-setContentView" class="headerlink" title="Activity.setContentView()"></a>Activity.setContentView()</h3><p>Activity 设置布局是通过window（确切的说是PhoneWindow）对象连接的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Activity 内部window是 PhoneWindow对象</span></span><br><span class="line">      getWindow().setContentView(layoutResID);</span><br><span class="line">      initWindowDecorActionBar();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h2 id="Window-amp-PhoneWindow"><a href="#Window-amp-PhoneWindow" class="headerlink" title="Window&amp;PhoneWindow"></a>Window&amp;PhoneWindow</h2><p>Window与View通过DecorVIew产生联系</p>
<p>Activity内部持有 mWindow对象，mWindow 依赖PhoneWindow对象</p>
<p>PhoneWindow持有mDecor对象，mDecor其实是DecorView对象（继承自FrameLayout）</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165416162.png" alt="image-20210908165416162"></p>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><h4 id="Window-getLocalFeatures"><a href="#Window-getLocalFeatures" class="headerlink" title="Window.getLocalFeatures()"></a>Window.getLocalFeatures()</h4><p>Windows的特征，Activity中调用的<code>requestWindowFeature(Window.FEATURE_NO_TITLE)</code>就是修改的这个值</p>
<p><strong>为什么requestWindowFeature() 方法要写在setContentView前面？</strong></p>
<p>因为setContentView() 要用到getLocalFeatures()的返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getLocalFeatures</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mLocalFeatures;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h4><p>实际调用的是DecorView的findviewby，id，就是找到系统布局模版中id是@android:id/content的布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">findViewById</span><span class="params">(<span class="meta">@IdRes</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getDecorView().findViewById(id);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getAttributes"><a href="#getAttributes" class="headerlink" title="getAttributes"></a>getAttributes</h4><p>窗口属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WindowManager.LayoutParams mWindowAttributes =</span><br><span class="line">      <span class="keyword">new</span> WindowManager.LayoutParams();</span><br><span class="line">     </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">      type = TYPE_APPLICATION;</span><br><span class="line">      format = PixelFormat.OPAQUE;</span><br><span class="line">  &#125;    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> WindowManager.<span class="function">LayoutParams <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mWindowAttributes;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="setWindowManager"><a href="#setWindowManager" class="headerlink" title="setWindowManager"></a>setWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 创建一个 WindowManagerImpl 对象</span></span><br><span class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h3><p>Activity 调用 <code>setContentView(int layoutResID)</code>时实际调用的是<code>window.setContentView(int resId)</code></p>
<p>而Activity 内部持有的是PhoneWindow对象的实例，所以其实调用的是PhonewIndow对象的方法</p>
<h4 id="调用installDecor-初始化的过程："><a href="#调用installDecor-初始化的过程：" class="headerlink" title="调用installDecor()初始化的过程："></a>调用installDecor()初始化的过程：</h4><ul>
<li><p>与DecorVIew建立联系</p>
<p>实例化一个DecorView对象，交给PhoneWIndow</p>
<p><code>setContentView(int layoutResID)</code> -&gt;<code>installDecor()</code>-&gt;<code> generateDecor(-1);</code></p>
</li>
<li><p>帮助 DecorView 添加一个根布局（root）</p>
<p>根据Window.getLocalFeatures()获得开发者配置的WIndow特性，选择不同的布局模板，交给DecorVIew创建根布局</p>
<p> <code>setContentView(int layoutResID)</code> -&gt; <code>installDecor();</code>-&gt;<code>generateLayout(mDecor)</code></p>
<p>-&gt; <code> mDecor.onResourcesLoaded(mLayoutInflater, layoutResource)</code></p>
</li>
</ul>
<p>![image-20210909142715857](../../../Library/Application Support/typora-user-images/image-20210909142715857.png)</p>
<ul>
<li><p>将Activity 自定义的布局加入Decor的根布局中id为<code>@android:id/content</code>的FrameLayout中</p>
<p>![image-20210909150251632](../../../Library/Application Support/typora-user-images/image-20210909150251632.png)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">MenuBuilder</span>.<span class="title">Callback</span> </span>&#123;  </span><br><span class="line">  	<span class="comment">// DecorView是 Window里面的顶层View</span></span><br><span class="line">		<span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">  			 <span class="comment">// 初始化时 mContentParent 是 null</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 初始化Decor</span></span><br><span class="line">            installDecor();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 将Activity的布局 layoutResID ，传入DecorView的根布局中</span></span><br><span class="line">            </span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line"> 		&#125;</span><br><span class="line">   <span class="comment">// 初始化 DecorView 并为它添加根布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mForceDecorInstall = <span class="keyword">false</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建 DecorView 对象 赋值给mDecor</span></span><br><span class="line">            mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">            mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 初始化时mContentParent是 null的</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 给mContentParent 赋值</span></span><br><span class="line">          <span class="comment">//generateLayout() 返回的是ID为 android.R.id.content的FrameLayout（系统模版布局中）</span></span><br><span class="line">            mContentParent = generateLayout(mDecor); </span><br><span class="line">        &#125;      </span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 根据一些常用的配置进行设置</span></span><br><span class="line">			<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowNoTitle, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_NO_TITLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBar, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t allow an action bar if there is no title.</span></span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBarOverlay, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR_OVERLAY);</span><br><span class="line">        &#125;  </span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// Inflate the window decor.</span></span><br><span class="line">       <span class="keyword">int</span> layoutResource;</span><br><span class="line">       <span class="comment">// features调用Window.getLocalFeatures()</span></span><br><span class="line">       <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="comment">// features 表示window的特性 ，比如有无title ，actionbar等</span></span><br><span class="line">      <span class="comment">// 根据 features 的不同对 layoutResource 赋值成不同的布局，就可以体现不同特性</span></span><br><span class="line">      <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            layoutResource = R.layout.screen_progress;</span><br><span class="line">           </span><br><span class="line">        &#125; </span><br><span class="line">         ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// 赋值 给  layoutResource 指定布局</span></span><br><span class="line">            layoutResource = R.layout.screen_simple;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDecor.startChanging();</span><br><span class="line">  			<span class="comment">// 通过传入的打气筒和 layoutResource，创建一个View命名为root</span></span><br><span class="line">        <span class="comment">//  mDecor通过addView(root) 将view对象添加到内部 </span></span><br><span class="line">        mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">				<span class="comment">// 调用的是window.findViewById()-&gt;DecorView.findViewById()</span></span><br><span class="line">  			<span class="comment">// 最终要找到的是系统模版中id是@android:id/content的ViewGroup</span></span><br><span class="line">        ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">        </span><br><span class="line">  			<span class="comment">// 根据配置做出一些设置</span></span><br><span class="line">  				...</span><br><span class="line">        <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) </span><br><span class="line">            mDecor.setWindowBackground(mBackgroundDrawable);</span><br><span class="line">            ...</span><br><span class="line">            mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回的是系统模板中id为android.R.id.content的FrameLayout  </span></span><br><span class="line">        <span class="keyword">return</span> contentParent;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="screen-simple-xml"><a href="#screen-simple-xml" class="headerlink" title="screen_simple.xml"></a>screen_simple.xml</h4><p>android-sdk-macosx/platforms/android-30/data/res/layout/screen_simple.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Actionbar 的布局，ViewStub可以节约内存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_mode_bar_stub&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">&quot;@+id/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">&quot;@layout/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">&quot;?attr/actionBarTheme&quot;</span> /&gt;</span></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">         android:id=&quot;@android:id/content&quot;</span><br><span class="line">         android:layout_width=&quot;match_parent&quot;</span><br><span class="line">         android:layout_height=&quot;match_parent&quot;</span><br><span class="line">         android:foregroundInsidePadding=&quot;false&quot;</span><br><span class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="DecorView"><a href="#DecorView" class="headerlink" title="DecorView"></a>DecorView</h2><ul>
<li><p>根据PhoneWindow 传递的根布局信息创建根布局</p>
<p><code>onResourcesLoaded()</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 创建DecorView实例</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">        <span class="comment">// new 一个DecorView 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// 将PhoneWindow根据window内部feature属性设置的根布局加入到DecorView内部 </span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onResourcesLoaded</span><span class="params">(LayoutInflater inflater, <span class="keyword">int</span> layoutResource)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="comment">// 创建一个View对象，</span></span><br><span class="line">        <span class="keyword">final</span> View root = inflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (mDecorCaptionView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDecorCaptionView.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addView(mDecorCaptionView,</span><br><span class="line">                        <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">            &#125;</span><br><span class="line">            mDecorCaptionView.addView(root,</span><br><span class="line">                    <span class="keyword">new</span> ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//通过add View 将这系统模板布局View加入到DecorView里面</span></span><br><span class="line">         </span><br><span class="line">            addView(root, <span class="number">0</span>, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        mContentRoot = (ViewGroup) root;</span><br><span class="line">        initializeElevation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h2><p>DecorView的父View（其实不是一个View）</p>
<p>打印<code>println(window.decorView.parent.toString())</code>得到parent为ViewRootImpl</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210909160559140.png" alt="image-20210909160559140"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">ThreadedRenderer</span>.<span class="title">DrawCallbacks</span> </span>&#123; </span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> Thread mThread;</span><br><span class="line">    <span class="keyword">final</span> View.AttachInfo mAttachInfo;</span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123; </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMessageName</span><span class="params">(Message message)</span> </span>&#123;...&#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123; ...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">// 构造时赋值mThread对象</span></span><br><span class="line">    <span class="comment">// ViewRootImpl构造方法仅在WindowManagerGlobal中调用过</span></span><br><span class="line">    <span class="comment">// 调用它的方法是ActivityThread.performResumeActivity() ，所以mThread必然是主线程</span></span><br><span class="line">    <span class="comment">// checkThread()中将使用mThread  </span></span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">    <span class="comment">// 创建对象，传入handler</span></span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler,    	<span class="keyword">this</span>, context);  </span><br><span class="line">    ...</span><br><span class="line">    &#125;        </span><br><span class="line">    <span class="comment">//检查线程    </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 判断   Thread.currentThread()是否和 mThread对象 相同</span></span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 防止重复绘制的</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">            <span class="comment">// 检查线程</span></span><br><span class="line">            checkThread();</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> 	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// view 即为DecorView</span></span><br><span class="line">     mView = view;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 第一次调用 requestLayout，是自主调用，不是成为其他View的Parent后被迫调用</span></span><br><span class="line">     requestLayout();</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 将ViewRootImpl 设置为DecorView的 Parent</span></span><br><span class="line">     <span class="comment">// 这样才能串联自定义布局-&gt;系统模板布局-&gt;DocerView-ViewRootImpl</span></span><br><span class="line">     view.assignParent(<span class="keyword">this</span>);</span><br><span class="line"> 	&#125;  </span><br><span class="line">          </span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">          <span class="comment">// 向主线程post 一个 Runnable 对象： mTraversalRunnable, </span></span><br><span class="line">          <span class="comment">// postCallback类似handler post，是一个异步操作</span></span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">     ..</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// runnable 调用了doTraversal()方法</span></span><br><span class="line">          <span class="comment">// 因为被异步post ，所以doTraversal会在下次循环时调用</span></span><br><span class="line">            doTraversal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 下次循环调用的  performTraversals()</span></span><br><span class="line">            performTraversals();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 核心方法 Traversals: 遍历</span></span><br><span class="line">    <span class="comment">// 生命周期就是拿着一个对象，调用对象上面的方法，</span></span><br><span class="line">    <span class="comment">// 这个方法也是依托顶层DecorView来出发（如同ActivityThread对应Activity生命周期方法的调用）</span></span><br><span class="line">    <span class="comment">// 它们是： performMeasure()， performLayout(), performDraw(),         </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 状态设置</span></span><br><span class="line">			... </span><br><span class="line">        mIsInTraversal = <span class="keyword">true</span>;</span><br><span class="line">        mWillDrawSoon = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;  </span><br><span class="line">       <span class="comment">// 1. 测量过程  调用decoerview.perform Measur() 先测量Window，再测量View树</span></span><br><span class="line">                </span><br><span class="line">      <span class="comment">// 尺寸相关，窗口属性， 预定义宽高，</span></span><br><span class="line">      <span class="comment">// 如果是Activity它的值和 ActivityThread，WindowManager.addView() 的窗口属性是一样的</span></span><br><span class="line">      WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line">        <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 第一次必然进入，  mLayoutRequested = true，布局必然重新布置</span></span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">           <span class="comment">// 判断一下Window的级别         </span></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Activity lp type参数是Application，而非系统窗口/键盘</span></span><br><span class="line">              <span class="comment">// 所以赋值为屏幕的宽高</span></span><br><span class="line">                desiredWindowWidth = frame.width();</span><br><span class="line">                desiredWindowHeight = frame.height();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将DecorView依附到Window上</span></span><br><span class="line">            <span class="comment">//host 是DecorView</span></span><br><span class="line">            host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; ...&#125; </span><br><span class="line">         <span class="comment">//传如DecorView，完成系统状态栏/导航栏的添加</span></span><br><span class="line">					dispatchApplyInsets(host); </span><br><span class="line">            ...</span><br><span class="line">       <span class="comment">// View执行post操作时，若发生崩溃 AttachInfo == null，</span></span><br><span class="line">       <span class="comment">// 也就拿不到handler对象，可执行的runnable会暂时存在一个队列中</span></span><br><span class="line">       <span class="comment">// 此时就是执行队列中runnable的时机  </span></span><br><span class="line">       getRunQueue().executeActions(mAttachInfo.mHandler);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//  第一次绘执行performTravelsal  mLayoutRequested = true    </span></span><br><span class="line">      <span class="comment">//  mStopped只有Acitivity Stop的时候才为true  </span></span><br><span class="line">      <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">      <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="comment">// 第一次测量：对整个视图树的测量，是确定window的大小</span></span><br><span class="line">            windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                    desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 第一次执行必然进入</span></span><br><span class="line">      <span class="keyword">if</span> (mFirst || windowShouldResize || viewVisibilityChanged || cutoutChanged || params != <span class="keyword">null</span>|| mForceNextWindowRelayout) &#123;</span><br><span class="line">          ...</span><br><span class="line">           <span class="comment">// 屏幕的宽高已经确定，但Window大小并不是应用层决定的，所有的服务都是系统服务WMS完成的，</span></span><br><span class="line">           <span class="comment">// 所以尺寸调整在relayoutWindow方法通知WMS，同时执行时我们的Window尺寸会从初识值变成固定值</span></span><br><span class="line">           relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);  </span><br><span class="line">          ... </span><br><span class="line">             updatedConfiguration = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// mStopped只有Acitivity Stop的时候才为true，所以activity启动状态下一定为true</span></span><br><span class="line">      <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                        (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);             <span class="comment">// updatedConfiguration 第一次进入时设置为true，可以进入</span></span><br><span class="line">                <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                        || mHeight != host.getMeasuredHeight() || dispatchApplyInsets ||</span><br><span class="line">                        updatedConfiguration) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                     <span class="comment">//第二次测量尺寸，这次是真正的测量， mDecorView 测量所有子View</span></span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                   ....</span><br><span class="line">                    layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ... </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//2. 视图树的布局过程 调用 DecorView的 performLayout 对View树进行布局，</span></span><br><span class="line">        <span class="comment">//这一步可以得到View真正的位置和大小</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment">// didLayout= true ，所以 triggerGlobalLayoutListener = true</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);          </span><br><span class="line">        <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">                || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">        <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">           <span class="comment">//调用子View的layout方法进行布局，布局完成后就能确定尺寸和位置了</span></span><br><span class="line">            performLayout(lp, mWidth, mHeight);</span><br><span class="line">					...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">if</span> (triggerGlobalLayoutListener) &#123;</span><br><span class="line">            mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">// 整个布局树已经完成，触发回调，这也是为什么这个回调会被推荐用来获取控件的大小</span></span><br><span class="line">          <span class="comment">// 因为用post的方法，在onResume中取，会在下一个消息序列获取宽和高</span></span><br><span class="line">          <span class="comment">// 而使用回调可以在同一个消息队列中获得宽和高</span></span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnGlobalLayout();</span><br><span class="line">        &#125;</span><br><span class="line">			 ...</span><br><span class="line">         <span class="comment">//3. 绘制过程 调用DecorView的performDraw()方法对View进行绘制</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">// isViewVisible若 = false 则不绘制</span></span><br><span class="line">        <span class="keyword">boolean</span> cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cancelDraw) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">					<span class="comment">// 大多数情况下都会走入 performDraw，API 29之前</span></span><br><span class="line">          <span class="comment">// 要判断SurfaceView是否是新创建的，</span></span><br><span class="line">          <span class="comment">// 若是新创建的，则在第二次调用performTraversals时才能调用performDraw</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 绘制过程不是直接调用DecorView的方法，重点是根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            performDraw();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 若因为某些原因没能成功执行 performDraw() </span></span><br><span class="line">          <span class="comment">// 测量，布局流程也不会重新执行一遍，只重新执行绘制 performMeasrue() ，performLayout()</span></span><br><span class="line">          <span class="comment">// 因为若是测量过 mLayoutRequested = true ，不会重新走测量/逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">                <span class="comment">// Try again</span></span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mContentCaptureEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">            notifyContentCatpureEvents();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = <span class="keyword">false</span>;          </span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">measureHierarchy</span><span class="params">(<span class="keyword">final</span> View host, <span class="keyword">final</span> WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Resources res, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowWidth, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 是否是一次成功的测量，默认false</span></span><br><span class="line">        <span class="keyword">boolean</span> goodMeasure = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">if</span> (!goodMeasure) &#123;</span><br><span class="line">          <span class="comment">// 传入布局，也就是window的宽高和布局参数传进去，也就是View中 onMeasure方法需要的</span></span><br><span class="line">            childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">          <span class="comment">// 第一次：测量大小，其实是测量window的大小，开始测量</span></span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">            ..</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开始测量  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// mView 也就是DecorView，执行measure方法，接下来一层一层的子View也会进行遍历，完成测量</span></span><br><span class="line">            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 获得测量参数  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> measureSpec;</span><br><span class="line">        <span class="keyword">switch</span> (rootDimension) &#123;</span><br><span class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</span><br><span class="line">            <span class="comment">// Window can&#x27;t resize. Force root view to be windowSize.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</span><br><span class="line">          ...</span><br><span class="line">        <span class="keyword">return</span> measureSpec;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 布局过程</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="keyword">final</span> View host = mView;</span><br><span class="line">        ... <span class="comment">// 调用 decorView和所有子View的 layout 进行布局</span></span><br><span class="line">            host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">           ...</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 绘制过程</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">          <span class="comment">// 根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;</span><br><span class="line">              ...</span><br><span class="line">                <span class="comment">// 硬件绘制 draw() 方法</span></span><br><span class="line">                mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ...</span><br><span class="line">								<span class="comment">// 软件绘制 draw() 方法</span></span><br><span class="line">                <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset,</span><br><span class="line">                        scalingRequired, dirty, surfaceInsets)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> scalingRequired, Rect dirty, Rect surfaceInsets)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">						<span class="comment">// 软件绘制</span></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line">           ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;      </span><br><span class="line">      </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h2 id="View-class"><a href="#View-class" class="headerlink" title="View.class"></a>View.class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@UiThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">Drawable</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span></span><br><span class="line"><span class="class">        <span class="title">AccessibilityEventSource</span> </span>&#123;	</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    AttachInfo mAttachInfo;  </span><br><span class="line">    <span class="keyword">final</span> Handler mHandler;          </span><br><span class="line">    <span class="comment">// 设置View的Parent      </span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">assignParent</span><span class="params">(ViewParent parent)</span> </span>&#123;</span><br><span class="line">		  </span><br><span class="line">    		<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">   		     mParent = parent;</span><br><span class="line">    		&#125; ..</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">	</span><br><span class="line">		<span class="comment">// 建立View和Window之间的依赖</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchAttachedToWindow</span><span class="params">(AttachInfo info, <span class="keyword">int</span> visibility)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// AttachInfo是ViewRootImpl传入的，我们可以用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">        mAttachInfo = info;</span><br><span class="line">				...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 系统自带方法也是用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAttachedToWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAttachInfo != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切换线程需要借助handler，handler是随着AttachInfo传来的</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">        <span class="comment">// 有时发生崩溃了，但是View仍然被创建出来了，Handler就是空的，此时post不会立刻发送Runnable</span></span><br><span class="line">        <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> attachInfo.mHandler.post(action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若发生崩溃，attachInfo = null ，先把Runnable存到一个队列当中</span></span><br><span class="line">        getRunQueue().post(action);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mHandler是创建AttachInfo对象时构造函数传来的，而AttachInfo对象是ViewRootImpl构造函数中创建的</span></span><br><span class="line">          </span><br><span class="line">    AttachInfo(IWindowSession session, IWindow window, Display display,</span><br><span class="line">                ViewRootImpl viewRootImpl, Handler handler, Callbacks effectPlayer,</span><br><span class="line">                Context context) &#123;</span><br><span class="line">            ...</span><br><span class="line">            mViewRootImpl = viewRootImpl;</span><br><span class="line">            mHandler = handler;</span><br><span class="line">            ...</span><br><span class="line">        &#125;  </span><br><span class="line">    <span class="comment">// 表示正在布局中，防止重复布局的措施      </span></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">         <span class="comment">// 表示正在布局的flag，在layout中才会消除掉</span></span><br><span class="line">        mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据flag确定View是否处于布局过程中      </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLayoutRequested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line">    &#125;          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">     ....</span><br><span class="line">			<span class="comment">// 重置标志位</span></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">      <span class="comment">// 判断是否已经在布局中，若正在布局中，则不会往上层调用 requestLayout()</span></span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">            mParent.requestLayout();</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WindowManagerImpl，WindowManager，WIndowManagerGlobal"><a href="#WindowManagerImpl，WindowManager，WIndowManagerGlobal" class="headerlink" title="WindowManagerImpl，WindowManager，WIndowManagerGlobal"></a>WindowManagerImpl，WindowManager，WIndowManagerGlobal</h2><p>每个Acitivty 都有一个WIndowManager对象，一个程序可能有很多歌WIndowManagerImpl，不同Manager都会把操作转交给WindowManagerGlobal，这样以后想做统一操作在Global中操作非常简单</p>
<h3 id="WindowManagerGlobal"><a href="#WindowManagerGlobal" class="headerlink" title="WindowManagerGlobal"></a>WindowManagerGlobal</h3><p>记录所有的View和ViewRootImpl 这个类是隐藏的，可以得到</p>
<p>Activity在生命周期中能拿到Global，而Dialog没有生命周期，只能用反射拿到所有底层View和所有属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerGlobal</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 记录所有的View和ViewRootImpl，布局参数</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;ViewRootImpl&gt;();    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;WindowManager.LayoutParams&gt;();		</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">      ViewRootImpl root;</span><br><span class="line">       <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);	</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 每次创建后都会存储View，ViewRootImpl和各种参数</span></span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">      <span class="comment">// 和Windows的布局参数是统一的</span></span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 关键 调用 ViewRootImpl的setView方法</span></span><br><span class="line">      root.setView(view, wparams, panelParentView, userId);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WindowManagerImpl"><a href="#WindowManagerImpl" class="headerlink" title="WindowManagerImpl"></a>WindowManagerImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h4 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h4><p>Activity 的成员变量，是一个接口继承了ViewManager，实际上使用的实例是WindowManagerImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemService(Context.WINDOW_SERVICE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowManager</span> <span class="keyword">extends</span> <span class="title">ViewManager</span> </span>&#123;</span><br><span class="line">  	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ViewManager"><a href="#ViewManager" class="headerlink" title="ViewManager"></a>ViewManager</h4><p>只是一个接口 ActivityThread 中 有使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title">WindowManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">// global是个单例对象</span></span><br><span class="line">	 <span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br><span class="line">  </span><br><span class="line"> 		 <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">       <span class="comment">//add View 丢该global去做</span></span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="在子线程中更新-UI-不报错的几种方式"><a href="#在子线程中更新-UI-不报错的几种方式" class="headerlink" title="在子线程中更新 UI 不报错的几种方式"></a>在子线程中更新 UI 不报错的几种方式</h2><p>子线程更新UI不一定会报错</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">requestWindowFeature(Window.FEATURE_NO_TITLE)</span><br><span class="line">setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">text = findViewById(R.id.text)</span><br><span class="line"><span class="comment">// 直接在子线程更新ui 不会崩溃</span></span><br><span class="line">thread &#123;</span><br><span class="line">    text.text = <span class="string">&quot;ok!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text.setOnClickListener(<span class="keyword">object</span>: View.OnClickListener &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        println(window.decorView.parent.toString())</span><br><span class="line">        <span class="comment">// 子线程更新 ui 会崩溃</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            text.text = <span class="string">&quot;onCreate!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>报错信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Process: com.hencoder.customviewdrawing, PID: 23675</span><br><span class="line">  android.view.ViewRootImpl<span class="variable">$CalledFromWrongThreadException</span>: Only the original thread that created a view hierarchy can touch its views.</span><br><span class="line">      at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:8825)</span><br><span class="line">      at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1535)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.widget.TextView.checkForRelayout(TextView.java:9762)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6326)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6154)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6106)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:31)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:26)</span><br><span class="line">      at kotlin.concurrent.ThreadsKt$thread$thread<span class="variable">$1</span>.run(Thread.kt:30)</span><br></pre></td></tr></table></figure>
<p>对应报错的位置则是View.requestLayout() 中一致调用到ViewRootImpl.requestLayout()</p>
<p>而ViewRootImpl是decorView的parentView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mMeasureCache != <span class="keyword">null</span>) mMeasureCache.clear();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// Only trigger request-during-layout logic if this is the view requesting it,</span></span><br><span class="line">           <span class="comment">// not the views in its parent hierarchy</span></span><br><span class="line">           ViewRootImpl viewRoot = getViewRootImpl();</span><br><span class="line">           <span class="keyword">if</span> (viewRoot != <span class="keyword">null</span> &amp;&amp; viewRoot.isInLayout()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">this</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">       mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line">			<span class="comment">// 若parent == null 根本不会调用  ViewRootImp.requestLayout()</span></span><br><span class="line">       <span class="comment">//  更不会调用  ViewRootImpl.checkThread();</span></span><br><span class="line">       <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">           mParent.requestLayout();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">this</span>) &#123;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="为什么子线程更新UI会报错？"><a href="#为什么子线程更新UI会报错？" class="headerlink" title="为什么子线程更新UI会报错？"></a>为什么子线程更新UI会报错？</h3><p>ViewRootImpl成为控件树最顶层DecorView的Parent时，这样才有可能更新UI的时候触发他的requestLayout(),</p>
<p>只有触发了requestLayout()才会调用它的检查线程方法checkThread()</p>
<h3 id="1-主线程申请成功后子线程申请"><a href="#1-主线程申请成功后子线程申请" class="headerlink" title="1.主线程申请成功后子线程申请"></a>1.主线程申请成功后子线程申请</h3><p>利用View 防止重复绘制的优化，先进行一次requestLayout()，第二次就会被忽略</p>
<p>若调用View 触发requestLayout()，会让整条View链的所有View 设置一个Flag：<code> mPrivateFlags |= PFLAG_FORCE_LAYOUT;</code>,表示正在布局，在layout的时候才会把它消除掉，</p>
<p>再次调用View的requestLayout()时，View会根据标志位判断，若标志位表示正在布局，则代表已经申请过requestLayout(），View不会再调用上层父布局的requestLayout()，这样就不会触发ViewRootImpl的线程检查</p>
<p>类似的，TextView里面</p>
<p>现在主线程调用setText，会触发 reqeustLayout()</p>
<p>子线程调用setText时，相当于连续触发reqeustLayout()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">     setTextInternal(text);<span class="comment">// 已经设置好文字了</span></span><br><span class="line">    <span class="keyword">if</span> (mLayout != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// mLayout 不为空，会触发requestLayout()</span></span><br><span class="line">        checkForRelayout();</span><br><span class="line">    &#125;   ....         </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ....  requestLayout(); ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> textview = findViewById&lt;TextView&gt;(R.id.textview)</span><br><span class="line"></span><br><span class="line">textview.setOnClickLitener &#123;</span><br><span class="line">  textView.text = <span class="string">&quot;Main&quot;</span> <span class="comment">// 或者    it.requestLayout()</span></span><br><span class="line">  tread &#123;</span><br><span class="line">    textview.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                             </p>
<h3 id="2-在子线程中创建-ViewRootImpl"><a href="#2-在子线程中创建-ViewRootImpl" class="headerlink" title="2. 在子线程中创建 ViewRootImpl"></a><strong>2.</strong> 在子线程中创建 ViewRootImpl</h3><p>ViewRootImpl检查线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line"> ... mThread = Thread.currentThread(); ...</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查线程使用的mThread 对象</span></span><br><span class="line">      <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>mThread对象是初始化时构建的，创建ViewRootImpl时所在的线程就是mThread所在的线程<br>ViewRootImpl是WindowManagerGlobal 调用addView()时创建的<br>由于WindowMangaerGlobal是隐藏类，我们可以通过WindowManager来做这件事 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">thread &#123;</span><br><span class="line">  <span class="comment">// ViewRootImpl 需要一个Handler（ ViewRootHandler），而Handler需要Looper，子线程没有Looper</span></span><br><span class="line">  Looper.prepare()</span><br><span class="line">  <span class="comment">// 在子线程中创建一个View</span></span><br><span class="line">  <span class="keyword">val</span> button = Button(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// 让它在子线程中创建一个ViewRootImpl，它最终会调用WindowManagerGlobal.addView()</span></span><br><span class="line">  windowManager.addView(button,WinowManager.LayoutParams())</span><br><span class="line">  button.setOnClickLitener &#123;</span><br><span class="line">    buttun.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span> : <span class="subst">$&#123;SystemClock.uptimeMillis()&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 只有Handler和Looper ，handler无法正常处理任务，还需要让Looper轮训起来</span></span><br><span class="line">  Looper.loop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="子线程弹Toast"><a href="#子线程弹Toast" class="headerlink" title="子线程弹Toast"></a>子线程弹Toast</h4><p>报错不同，但是同样可以通过代码前后增加<code>   Looper.prepare()</code>,<code>    Looper.loop()</code>解决</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210916223001494.png" alt="image-20210916223001494"></p>
<h3 id="3-利用硬件加速机制绕开-requestLayout"><a href="#3-利用硬件加速机制绕开-requestLayout" class="headerlink" title="3. 利用硬件加速机制绕开 requestLayout()"></a>3. 利用硬件加速机制绕开 requestLayout()</h3><p>在硬件加速的支持下，如果控件只是经常了 invalidate() ，而没有触发requestLayout() 是不会触发。ViewRootImpl的checkThread() 的。</p>
<p>子View会依赖父ViewGroup的invalidate()实现，而作为最顶层的ViewRootImpl，它的invalidate()方法会直接调用scheduleTraversals();绘制图形，而不像requestLayout() 在调用scheduleTraversals()之前要chekThread</p>
<p>TextView.setView()会调用  checkForRelayout() 方法，宽度不变或者宽高都不变则只会调用invalidate();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">      checkForRelayout() </span><br><span class="line">   &#125;    </span><br><span class="line"></span><br><span class="line">	<span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 判断宽度是不是固定/不变的</span></span><br><span class="line">       <span class="keyword">if</span> ((mLayoutParams.width != LayoutParams.WRAP_CONTENT</span><br><span class="line">               || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))</span><br><span class="line">               &amp;&amp; (mHint == <span class="keyword">null</span> || mHintLayout != <span class="keyword">null</span>)</span><br><span class="line">               &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">           makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,</span><br><span class="line">                         mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(), <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mEllipsize != TextUtils.TruncateAt.MARQUEE) &#123;</span><br><span class="line">               <span class="comment">// In a fixed-height view, so use our new text layout.</span></span><br><span class="line">               <span class="keyword">if</span> (mLayoutParams.height != LayoutParams.WRAP_CONTENT</span><br><span class="line">                       &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 高度是不是和以前一样/固定的</span></span><br><span class="line">               <span class="keyword">if</span> (mLayout.getHeight() == oldht</span><br><span class="line">                       &amp;&amp; (mHintLayout == <span class="keyword">null</span> || mHintLayout.getHeight() == oldht)) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                 <span class="comment">// 只调用invalidate()</span></span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 同时调用  invalidate 和 requestLayout</span></span><br><span class="line">           requestLayout();</span><br><span class="line">           invalidate();</span><br><span class="line">       &#125; 。。。</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       invalidate(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">       invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 的最终调用</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">         </span></span></span><br><span class="line"><span class="function"><span class="params">     ...</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">final</span> ViewParent p = mParent;</span></span></span><br><span class="line"><span class="function"><span class="params">          ...</span></span></span><br><span class="line"><span class="function"><span class="params">               // 父ViewGroup的  invalidateChild ，传入自身          </span></span></span><br><span class="line"><span class="function"><span class="params">               p.invalidateChild(<span class="keyword">this</span>, damage)</span></span>;</span><br><span class="line">          ...</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ViewGroup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span> &amp;&amp; attachInfo.mHardwareAccelerated) &#123;</span><br><span class="line">        <span class="comment">// 如果是硬件加速，则进入硬件加速捷径</span></span><br><span class="line">        onDescendantInvalidated(child, child);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View target)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//一致调用它的parent的方法，最顶层为ViewRootImpl</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParent.onDescendantInvalidated(<span class="keyword">this</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewRootImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View descendant)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 直接调用了 invalidate</span></span><br><span class="line">      invalidate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      mDirty.set(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</span><br><span class="line">      <span class="keyword">if</span> (!mWillDrawSoon) &#123;</span><br><span class="line">        <span class="comment">// 直接绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">      <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">          <span class="comment">// 检查线程</span></span><br><span class="line">          checkThread();</span><br><span class="line">          mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">          <span class="comment">// 绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-SurfaceView"><a href="#4-SurfaceView" class="headerlink" title="4.SurfaceView"></a>4.SurfaceView</h3><p>Android 中有一个控件 SurfaceView ，它可以通过 holder 获得 Canvas 对象， 可以直接在子线程中更新 UI。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">自定义view布局01:布局流程完全解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-06 17:53:02" itemprop="dateCreated datePublished" datetime="2021-09-06T17:53:02+08:00">2021-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-07 17:50:59" itemprop="dateModified" datetime="2021-09-07T17:50:59+08:00">2021-09-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="布局流程完全解析"><a href="#布局流程完全解析" class="headerlink" title="布局流程完全解析"></a>布局流程完全解析</h1><h2 id="布局过程"><a href="#布局过程" class="headerlink" title="布局过程"></a>布局过程</h2><p>确定每个 View 的位置和尺寸 </p>
<p>作用: 为<strong>绘制</strong>和<strong>触摸范围</strong>做支持</p>
<ul>
<li><strong>绘制</strong>: 知道往哪里绘制</li>
<li><strong>触摸反馈</strong>: 知道用户点的是哪里</li>
</ul>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h3 id="从整体看"><a href="#从整体看" class="headerlink" title="从整体看"></a>从整体看</h3><ul>
<li>测量流程:从根 View 递归调用每一级子 View 的 measure() 方法，对它们进行测量</li>
<li>布局流程:从根 View 递归调用每一级子 View 的 layout() 方法，把测量过程得 出的子 View 的位置和尺寸传给子 View，子 View 保存</li>
</ul>
<p>View onLayout是空方法</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907111935951.png" alt="image-20210907111935951" style="zoom: 67%;">

<p>View Group需要处理子View的布局</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907112056602.png" alt="image-20210907112056602"></p>
<h4 id="为什么要分两个流程"><a href="#为什么要分两个流程" class="headerlink" title="为什么要分两个流程?"></a>为什么要分两个流程?</h4><p>因为可能会重复测量</p>
<p>测量是一个动态的过程我们要测量多个子View ，有些子View可能要测量多次</p>
<p>比如下面的例子第一个子View是 match_parent ，第一次测量是没有结果的，需要两次测量，把测量/布局分成两个流程，可以让布局只使用最后保存的生效的数值，提高效率</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210906175625735.png" alt="image-20210906175625735"></p>
<h3 id="从个体看对于每个View"><a href="#从个体看对于每个View" class="headerlink" title="从个体看对于每个View"></a>从个体看对于每个View</h3><ol>
<li><p>运行前，开发者在 xml 文件里写入对 View 的布局要求 layout_xxx</p>
</li>
<li><p>父 View 在自己的 onMeasure() 中，根据开发者在 xml 中写的对子 View 的要 求，和自己的可用空间，得出对子 View 的具体尺寸要求（结合上一步开发者写入的 layout_xxx和父View的可用空间计算）</p>
<p> <img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907110500303.png" alt="image-20210907110500303"></p>
</li>
<li><p>子 View 在自己的 onMeasure() 中，根据父 View 的要求和自己的特性算出自己 的期望尺寸</p>
<ul>
<li>如果是 ViewGroup，还会在这里调用每个子 View 的 measure() 进行测量</li>
</ul>
</li>
<li><p>父 View 在子 View 计算出期望尺寸后，得出子 View 的实际尺寸和位置</p>
</li>
<li><p>子 View 在自己的 layout() 方法中，将父 View 传进来的自己的实际尺寸和位置 保存</p>
<ul>
<li>如果是 ViewGroup，还会在 onLayout() 里调用每个子 View 的 layout() 把 它们的尺寸位置传给它们</li>
</ul>
</li>
</ol>
<h2 id="自定义布局"><a href="#自定义布局" class="headerlink" title="自定义布局"></a>自定义布局</h2><p>具体实现方式：</p>
<ul>
<li>继承已有View，简单修改它们的尺寸：重写 onMeasure()<ul>
<li>SquareImageView 方形view</li>
</ul>
</li>
<li>对自定义View完全进行自定义运算：重写onMeasure()<ul>
<li>CircleView 圆形view，外部根据内部图形设定宽高</li>
</ul>
</li>
<li>自定义Layout：重写omMeasure()和onLayout()<ul>
<li>TagLayout 标签布局（Android的flex-box 类似）</li>
</ul>
</li>
</ul>
<h3 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h3><h4 id="自定义View方式一：简单改写已有View的尺寸"><a href="#自定义View方式一：简单改写已有View的尺寸" class="headerlink" title="自定义View方式一：简单改写已有View的尺寸"></a>自定义View方式一：简单改写已有View的尺寸</h4><ol>
<li><p>重写onMeasure()</p>
</li>
<li><p>用getMeasuredWidth()和getMeasuredHeight()获取到测量出的尺寸</p>
</li>
<li><p>计算出最终要的尺寸</p>
</li>
<li><p>用setOnMeasuredDimension(width, height)把结果保存</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareImageView</span></span>(context: Context?, attrs: AttributeSet?) : AppCompatImageView(context, attrs) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">		<span class="comment">// 使用系统计算过的宽&amp;高，计算比较小的那个</span></span><br><span class="line">    <span class="keyword">val</span> size = min(measuredWidth, measuredHeight)</span><br><span class="line">    <span class="comment">// 存储宽高，并非作为返回值给父类，而是使用时自己或父类去拿</span></span><br><span class="line">    setMeasuredDimension(size, size)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="重写layout也能改写尺寸，为什么要重写onMeaSure"><a href="#重写layout也能改写尺寸，为什么要重写onMeaSure" class="headerlink" title="重写layout也能改写尺寸，为什么要重写onMeaSure"></a>重写layout也能改写尺寸，为什么要重写onMeaSure</h4><p>若直接重写layout的确能改写尺寸，但是父View是不知道你的改动的，会造成位置错误</p>
<p>Eg</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;com.hencoder.layoutsize.view.SquareImageView</span><br><span class="line">        android:layout_width=&quot;300dp&quot;</span><br><span class="line">        android:layout_height=&quot;200dp&quot;</span><br><span class="line">        android:src=&quot;@drawable/avatar_rengwuxian&quot;</span><br><span class="line">         /&gt;</span><br><span class="line">    &lt;View</span><br><span class="line">        android:layout_width=&quot;200dp&quot;</span><br><span class="line">        android:layout_height=&quot;200dp&quot;</span><br><span class="line">        android:background=&quot;@color/purple_200&quot;/&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于Android系统你的布局应该是这样的</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907085754293.png" alt="image-20210907085754293"></p>
<p>若在layout中修改了尺寸，但系统不知道你的修改，结果就是：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareImageView</span></span>(context: Context?, attrs: AttributeSet?) : AppCompatImageView(context, attrs) &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">layout</span><span class="params">(l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> width = r - l</span><br><span class="line">    <span class="keyword">val</span> height = b - t</span><br><span class="line">    <span class="keyword">val</span> size = min(width,height)</span><br><span class="line">    <span class="keyword">super</span>.layout(l, t, l+size, t+size)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907085940819.png" alt="image-20210907085940819"></p>
<h4 id="测量尺寸的方法"><a href="#测量尺寸的方法" class="headerlink" title="测量尺寸的方法"></a>测量尺寸的方法</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">getMeasuredHeight() <span class="comment">// 测量期望尺寸 高</span></span><br><span class="line">getMeasuredWidth()  <span class="comment">// 测量期望尺寸 宽</span></span><br><span class="line">getHeight() <span class="comment">// 测量实际尺寸 高</span></span><br><span class="line">getWidth() <span class="comment">// 测量实际尺寸 宽</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//  View.class 中  getWidth() ，getHeight() 能获得View实际应用的值</span></span><br><span class="line"> </span><br><span class="line">  <span class="meta">@ViewDebug</span>.ExportedProperty(category = <span class="string">&quot;layout&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> int getWidth() &#123;</span><br><span class="line">        <span class="keyword">return</span> mRight - mLeft;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@ViewDebug</span>.ExportedProperty(category = <span class="string">&quot;layout&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> int getHeight() &#123;</span><br><span class="line">        <span class="keyword">return</span> mBottom - mTop;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getMeasuredHeight/Width方法获得的是期望的值，可能会被父类修改未必准确，测量过程中能拿到</li>
<li>getHeight/Width方法获得的是布局实际应用的宽高，但是在测量过程中拿不到</li>
</ul>
<blockquote>
<p>有时用getHeight/Width 获得了宽高值，此时View却进行了刷新导致宽高变化，获得的值还是上一轮的</p>
<p>而每次刷新getMeasuredHeight/Width会重新计算，虽然不一定是最后应用的但更实时</p>
<p><strong>所以测量过程中我们有时只能使用getMeasuredHeight/Width ()，其他时候使用getHeight/Width</strong></p>
</blockquote>
<h4 id="自定义View方式二：完全自定义View的尺寸"><a href="#自定义View方式二：完全自定义View的尺寸" class="headerlink" title="自定义View方式二：完全自定义View的尺寸"></a>自定义View方式二：完全自定义View的尺寸</h4><ol>
<li><p>重写onMeasure()</p>
</li>
<li><p>计算出自己的尺寸</p>
</li>
<li><p>用resolveSize() / resolveSizeAndState() 修正结果</p>
</li>
<li><p>使用setMeasuredDimension(width,height) 保存结果</p>
</li>
</ol>
<p>不重写onMeasure()</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 半径</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> RADIUS = <span class="number">100.</span>dp</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> PADDING = <span class="number">100.</span>dp</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CircleView</span></span>(context: Context?, attrs: AttributeSet?) : View(context, attrs) &#123;</span><br><span class="line">  <span class="meta">@RequiresApi(Build.VERSION_CODES.M)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">    color = getContext().getColor(R.color.purple_200)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequiresApi(Build.VERSION_CODES.M)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas)</span><br><span class="line"></span><br><span class="line">    canvas.drawCircle(PADDING + RADIUS, PADDING + RADIUS, RADIUS, paint)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;com.hencoder.layoutsize.view.CircleView</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:src=&quot;@drawable/avatar_rengwuxian&quot;</span><br><span class="line">        android:background=&quot;@color/teal_200&quot;</span><br><span class="line">         /&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>View 默认会填充整个屏幕</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907101823266.png" alt="image-20210907101823266"></p>
<p>重写onMeasure方法指定定View的尺寸</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// 重写View的宽高</span></span><br><span class="line">  <span class="keyword">val</span> size = ((PADDING + RADIUS) * <span class="number">2</span>).toInt()</span><br><span class="line">  <span class="comment">// 考虑父View的宽高建议 ： widthMeasureSpec: Int, heightMeasureSpec: Int</span></span><br><span class="line">  <span class="keyword">val</span> width = resolveSize(size, widthMeasureSpec)</span><br><span class="line">  <span class="keyword">val</span> height = resolveSize(size, heightMeasureSpec)</span><br><span class="line">  setMeasuredDimension(width, height)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Xml ：View不会再填充整个屏幕：</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907102042312.png" alt="image-20210907102042312"></p>
<h4 id="父View的宽高建议"><a href="#父View的宽高建议" class="headerlink" title="父View的宽高建议"></a>父View的宽高建议</h4><p> onMeasure方法的两个参数 widthMeasureSpec，heightMeasureSpec是父View的宽高建议</p>
<p>有三种模式：</p>
<ol>
<li>不超过指定宽高 MeasureSpec.AT_MOST</li>
<li>精确指定宽高 MeasureSpec.EXACTLY</li>
<li>不限制 MeasureSpec.UNSPECIFIED</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> size = ((PADDING + RADIUS) * <span class="number">2</span>).toInt()</span><br><span class="line">  <span class="comment">// 获得限制宽/高的模式 ：MeasureSpec.getMode</span></span><br><span class="line">  <span class="keyword">val</span> specWidthMode = MeasureSpec.getMode(widthMeasureSpec)</span><br><span class="line">  <span class="comment">// 若模式是不限制，就可以无视了，若有限制，需要获得精确的值/限制的值，通过getSize拿到</span></span><br><span class="line">  <span class="keyword">val</span> specWidthSize = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">  <span class="keyword">var</span> width = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (MeasureSpec.EXACTLY == specWidthMode)&#123;</span><br><span class="line">    <span class="comment">// 精确模式</span></span><br><span class="line">    width = specWidthSize</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (MeasureSpec.AT_MOST == specWidthMode)&#123;</span><br><span class="line">    <span class="comment">// 最大值限制</span></span><br><span class="line">    width = <span class="keyword">if</span> (size &gt; widthMeasureSpec) widthMeasureSpec <span class="keyword">else</span> size</span><br><span class="line"></span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (MeasureSpec.UNSPECIFIED == specWidthMode) &#123;</span><br><span class="line">    <span class="comment">//无限制</span></span><br><span class="line">    width = size</span><br><span class="line">  &#125;</span><br><span class="line">  setMeasuredDimension(width, size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="resolveSize和resolveSizeAndState和"><a href="#resolveSize和resolveSizeAndState和" class="headerlink" title="resolveSize和resolveSizeAndState和"></a>resolveSize和resolveSizeAndState和</h4><p>父View的宽高限制/建议都是固定逻辑，系统已经有方法处理这套逻辑了</p>
<p>resolveSize：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> width = resolveSize(size, widthMeasureSpec)</span><br><span class="line"><span class="keyword">val</span> height = resolveSize(size, heightMeasureSpec)</span><br></pre></td></tr></table></figure>
<p>resolveSizeAndState和resolveSize的区别在于，当测量模式是AT_MOST进行最大值限制的时候，若测量的值超出了最大值限制，会上报给父view一个MEASURED_STATE_TOO_SMALL的值表达空间不足，然而在实际应用中一般不会去读这个值，所以一遍都用resovleSize()方法处理</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static int resolveSizeAndState(int size, int measureSpec, int childMeasuredState) &#123;</span><br><span class="line">    <span class="keyword">final</span> int specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> int specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> int result;</span><br><span class="line">    switch (specMode) &#123;</span><br><span class="line">        case MeasureSpec.AT_MOST:</span><br><span class="line">            <span class="keyword">if</span> (specSize &lt; size) &#123;</span><br><span class="line">                result = specSize | MEASURED_STATE_TOO_SMALL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case MeasureSpec.EXACTLY:</span><br><span class="line">            result = specSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case MeasureSpec.UNSPECIFIED:</span><br><span class="line">        default:</span><br><span class="line">            result = size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result | (childMeasuredState &amp; MEASURED_STATE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自定义Layout-ViewGroup"><a href="#自定义Layout-ViewGroup" class="headerlink" title="自定义Layout(ViewGroup)"></a>自定义Layout(ViewGroup)</h3><ul>
<li>重写 onMeasure()<ul>
<li>遍历每个子 View，测量子 View<ul>
<li>测量完成后，得出子 View 的实际位置和尺寸，并暂时保存</li>
<li>有些子 View 可能需要重新测量</li>
</ul>
</li>
<li> 测量出所有子 View 的位置和尺寸后，计算出自己的尺寸，并用 setMeasuredDimension(width, height) 保存</li>
</ul>
</li>
<li>重写 onLayout()<ul>
<li>遍历每个子 View，调用它们的 layout() 方法来将位置和尺寸传给它们</li>
</ul>
</li>
</ul>
<p>Eg：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagLayout</span></span>(context: Context?, attrs: AttributeSet?) : ViewGroup(context, attrs) &#123;</span><br><span class="line">  <span class="comment">// 存储每个子View的尺寸位置</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> childrenBounds = mutableListOf&lt;Rect&gt;()</span><br><span class="line">  <span class="comment">// 重写 onMeasure()</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 记录已用的宽度</span></span><br><span class="line">    <span class="keyword">var</span> widthUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 记录已用高度</span></span><br><span class="line">    <span class="keyword">var</span> heightUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 单行 已用 宽度</span></span><br><span class="line">    <span class="keyword">var</span> lineWidthUsed = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 单行最大高度</span></span><br><span class="line">    <span class="keyword">var</span> lineMaxHeight = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 获得父类限制的宽度</span></span><br><span class="line">    <span class="keyword">val</span> specWidthSize = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">    <span class="comment">// 获得父类的尺寸限制模式 ，有三种 UNSPECIFIED无限制 ，EXACTLY精确，AT_MOST不能超过限制的最大值</span></span><br><span class="line">    <span class="keyword">val</span> specWidthMode = MeasureSpec.getMode(widthMeasureSpec)</span><br><span class="line">    <span class="comment">//1. 遍历每个子 View，测量子 View</span></span><br><span class="line">    <span class="keyword">for</span> ((index, child) <span class="keyword">in</span> children.withIndex()) &#123;</span><br><span class="line">      <span class="comment">// 调用 子View的 mseasure方法测量View的尺寸和位置</span></span><br><span class="line">      <span class="comment">// 需要传递宽高限制 widthMeasureSpec，heightMeasureSpec，已经用的宽度/高度</span></span><br><span class="line">      <span class="comment">// 这个通用方法，原则上只要不超过父类的宽高可以随意设置</span></span><br><span class="line">      measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, heightUsed)</span><br><span class="line">      <span class="comment">// 换行：父View的尺寸限制模式 不是无限制 且 已用宽度加上这个子View的测量宽度 超过父类限制的最大值</span></span><br><span class="line">      <span class="keyword">if</span> (specWidthMode != MeasureSpec.UNSPECIFIED &amp;&amp;</span><br><span class="line">        lineWidthUsed + child.measuredWidth &gt; specWidthSize) &#123;</span><br><span class="line">        <span class="comment">// 换行 行的最大高度/行的已有宽度都要归零</span></span><br><span class="line">        lineWidthUsed = <span class="number">0</span></span><br><span class="line">        <span class="comment">// 存储当前的行最大高度，得到已用高度</span></span><br><span class="line">        heightUsed += lineMaxHeight</span><br><span class="line">        lineMaxHeight = <span class="number">0</span></span><br><span class="line">        <span class="comment">// 给子View测量位置/尺寸</span></span><br><span class="line">        measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, heightUsed)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 2. 测量量完成后，得出子 View 的实际位置和尺寸，并暂时保存</span></span><br><span class="line">      <span class="keyword">if</span> (index &gt;= childrenBounds.size) &#123;</span><br><span class="line">        childrenBounds.add(Rect())</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 拿到用于存储的Rect 对象</span></span><br><span class="line">      <span class="keyword">val</span> childBounds = childrenBounds[index]</span><br><span class="line">      <span class="comment">// 对Rect 对象修改，暂时存储具体的位置，尺寸</span></span><br><span class="line">      childBounds.<span class="keyword">set</span>(lineWidthUsed, heightUsed, lineWidthUsed + child.measuredWidth, heightUsed + child.measuredHeight)</span><br><span class="line">      <span class="comment">// 记录子view已用宽度</span></span><br><span class="line">      lineWidthUsed += child.measuredWidth</span><br><span class="line">      <span class="comment">// 计算 当前行宽度是否超过已用宽度</span></span><br><span class="line">      widthUsed = max(widthUsed, lineWidthUsed)</span><br><span class="line">      <span class="comment">// 计算当前子View的高度是否超过 之前其他行的最大高度</span></span><br><span class="line">      lineMaxHeight = max(lineMaxHeight, child.measuredHeight)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 算出自己的尺寸 宽度，高度</span></span><br><span class="line">    <span class="comment">// 宽度就是已用宽度度</span></span><br><span class="line">    <span class="keyword">val</span> selfWidth = widthUsed</span><br><span class="line">    <span class="comment">// 高度使用已用高度+本行最大行高（只有换行时存储上一行的行高到 heightUsed，所以这里要+本行行高）</span></span><br><span class="line">    <span class="keyword">val</span> selfHeight = heightUsed + lineMaxHeight</span><br><span class="line">    <span class="comment">// 应用计算出来的自身尺寸</span></span><br><span class="line">    setMeasuredDimension(selfWidth, selfHeight)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 重写 onLayout()</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//3. 遍历每个子 View，调用它们的 layout() 方法来将位置和尺寸传给它们</span></span><br><span class="line">    <span class="keyword">for</span> ((index, child) <span class="keyword">in</span> children.withIndex()) &#123;</span><br><span class="line">      <span class="comment">// 取出存储的每个子View的尺寸，位置信息</span></span><br><span class="line">      <span class="keyword">val</span> childBounds = childrenBounds[index]</span><br><span class="line">      <span class="comment">// 调用子View的layout ()  传递存储的信息</span></span><br><span class="line">      child.layout(childBounds.left, childBounds.top, childBounds.right, childBounds.bottom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">generateLayoutParams</span><span class="params">(attrs: <span class="type">AttributeSet</span>?)</span></span>: LayoutParams &#123;</span><br><span class="line">    <span class="keyword">return</span> MarginLayoutParams(context, attrs)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907163741810.png" alt="image-20210907163741810" style="zoom:67%;">

<h4 id="measureChildWithMargins"><a href="#measureChildWithMargins" class="headerlink" title="measureChildWithMargins"></a>measureChildWithMargins</h4><p>ViewGroup设置子VIew的尺寸/位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//  child： 具体设置的子View对象</span></span><br><span class="line">  <span class="comment">//  parentWidthMeasureSpec ：父View的宽</span></span><br><span class="line">  <span class="comment">//  widthUsed： 已用宽度</span></span><br><span class="line">  <span class="comment">//  parentHeightMeasureSpec： 父View的高</span></span><br><span class="line">  <span class="comment">//  heightUsed： 已用高度</span></span><br><span class="line">       <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">               mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</span><br><span class="line">                       + widthUsed, lp.width);</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">               mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</span><br><span class="line">                       + heightUsed, lp.height);</span><br><span class="line"></span><br><span class="line">       child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="getChildMeasureSpec"><a href="#getChildMeasureSpec" class="headerlink" title="getChildMeasureSpec"></a>getChildMeasureSpec</h4><p>根据父View的尺寸/限制模式，padding等信息获得子View尺寸</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size. So be it.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.</span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... let him have it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size... find out how big it should</span></span><br><span class="line">            <span class="comment">// be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size.... find out how</span></span><br><span class="line">            <span class="comment">// big it should be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oldnineping"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">oldnineping</p>
  <div class="site-description" itemprop="description">技术日记和杂七杂八的dx</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oldnineping</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
