<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="View 绘制流程View 绘制流程主要对象图示 View绘制流程函数调用虚线表示至少一次消息处理(API29  之后)  1. Activity与ViewActivity与View是通过PhoneWindow(Window) 对象关联的 Activity 与通过attach()方法Window（实际是PhoneWIndow）关联， Window通过setContentView()与View关联">
<meta property="og:type" content="article">
<meta property="og:title" content="自定义view布局02:View绘制流程">
<meta property="og:url" content="http://example.com/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="地球上的小东西">
<meta property="og:description" content="View 绘制流程View 绘制流程主要对象图示 View绘制流程函数调用虚线表示至少一次消息处理(API29  之后)  1. Activity与ViewActivity与View是通过PhoneWindow(Window) 对象关联的 Activity 与通过attach()方法Window（实际是PhoneWIndow）关联， Window通过setContentView()与View关联">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180408351.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180743677.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165219071.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165416162.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210909160559140.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210916223001494.png">
<meta property="article:published_time" content="2021-09-07T09:58:44.000Z">
<meta property="article:modified_time" content="2021-11-01T10:20:10.996Z">
<meta property="article:author" content="oldnineping">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="自定义view">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180408351.png">

<link rel="canonical" href="http://example.com/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>自定义view布局02:View绘制流程 | 地球上的小东西</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球上的小东西</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">hiahiahiahia</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/07/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8002-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          自定义view布局02:View绘制流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-07 17:58:44" itemprop="dateCreated datePublished" datetime="2021-09-07T17:58:44+08:00">2021-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-01 18:20:10" itemprop="dateModified" datetime="2021-11-01T18:20:10+08:00">2021-11-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E8%87%AA%E5%AE%9A%E4%B9%89view/" itemprop="url" rel="index"><span itemprop="name">自定义view</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="View-绘制流程"><a href="#View-绘制流程" class="headerlink" title="View 绘制流程"></a>View 绘制流程</h1><h2 id="View-绘制流程主要对象图示"><a href="#View-绘制流程主要对象图示" class="headerlink" title="View 绘制流程主要对象图示"></a>View 绘制流程主要对象图示</h2><p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180408351.png" alt=" "></p>
<h2 id="View绘制流程函数调用"><a href="#View绘制流程函数调用" class="headerlink" title="View绘制流程函数调用"></a>View绘制流程函数调用</h2><p>虚线表示至少一次消息处理(API29  之后)</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210907180743677.png" alt="image-20210907180743677"></p>
<p>1.</p>
<h2 id="Activity与View"><a href="#Activity与View" class="headerlink" title="Activity与View"></a>Activity与View</h2><p>Activity与View是通过PhoneWindow(Window) 对象关联的</p>
<p>Activity 与通过attach()方法Window（实际是PhoneWIndow）关联，</p>
<p>Window通过setContentView()与View关联</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165219071.png" alt="image-20210908165219071"></p>
<h3 id="Activity的实例化和生命周期"><a href="#Activity的实例化和生命周期" class="headerlink" title="Activity的实例化和生命周期"></a>Activity的实例化和生命周期</h3><p>ActivityThread类负责实例化Acitivty类并调用Activity的生命周期方法</p>
<p>所谓的</p>
<p>ActivityThread类中的</p>
<ul>
<li><code>handleLaunchActivity()</code>-&gt;<code>performLaunchActivity()</code>方法会实例化Activity对象并调用Activity对象的onCreate()</li>
<li><code>handleStartActivity()</code>方法调用Activity的onStart()</li>
<li><code>handleResumeActivity()</code>-&gt;<code> performResumeActivity()</code>方法调用Activity的<code>onResume()</code></li>
</ul>
<h4 id="ActivityThread"><a href="#ActivityThread" class="headerlink" title="ActivityThread"></a>ActivityThread</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用onCreate</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Activity handleLaunchActivity(ActivityClientRecord r,</span><br><span class="line">          PendingTransactionActions pendingActions, Intent customIntent) &#123;</span><br><span class="line">...                                         </span><br><span class="line">       <span class="comment">// 实例化Activity对象</span></span><br><span class="line">      <span class="keyword">final</span> Activity a = performLaunchActivity(r, customIntent);                                  		...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">     ...</span><br><span class="line">        Activity activity = <span class="literal">null</span>;</span><br><span class="line">    		java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">    			<span class="comment">//调用Instrumentation.newActivity() 方法创建一个Activity对象并返回</span></span><br><span class="line">          activity = mInstrumentation.newActivity(</span><br><span class="line">                  cl, component.getClassName(), r.intent);</span><br><span class="line">     ...</span><br><span class="line">    <span class="comment">// 调用activity  attach方法</span></span><br><span class="line">    activity.attach(appContext,...);</span><br><span class="line">   		 ...</span><br><span class="line">    <span class="comment">// 最终会调用 activity onCreate方法</span></span><br><span class="line">    <span class="comment">// 通过 Instrumentation.callActivityOnCreate() 调用</span></span><br><span class="line">    <span class="comment">// 所以可以看出Activity onCreate() 调用发生在 attach() 方法之后</span></span><br><span class="line">    <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">              &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用resume </span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> void  (IBinder token, boolean finalStateRequest, boolean isForward,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 调用Activity onResume方法</span></span><br><span class="line">      <span class="keyword">final</span> ActivityClientRecord r = performResumeActivity(token, finalStateRequest, reason);</span><br><span class="line">		...</span><br><span class="line">      <span class="keyword">if</span> (r.window == <span class="literal">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">          <span class="comment">// 也就是PhoneWindow</span></span><br><span class="line">          r.window = r.activity.getWindow();</span><br><span class="line">          View decor = r.window.getDecorView();</span><br><span class="line">					<span class="comment">// 获得的是  WindowManagerImpl </span></span><br><span class="line">          ViewManager wm = a.getWindowManager();</span><br><span class="line">          <span class="comment">// 获得窗口属性</span></span><br><span class="line">          WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">          a.mDecor = decor;</span><br><span class="line">         </span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!a.mWindowAdded) &#123;</span><br><span class="line">                  a.mWindowAdded = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 将decorView窗口属性放进去</span></span><br><span class="line">                <span class="comment">// 使用的是 WindowManagerImpl 的addView 方法</span></span><br><span class="line">                  wm.addView(decor, l);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// The activity will get a callback for this &#123;@link LayoutParams&#125; change</span></span><br><span class="line">                  <span class="comment">// earlier. However, at that time the decor will not be set (this is set</span></span><br><span class="line">                  <span class="comment">// in this method), so no action will be taken. This call ensures the</span></span><br><span class="line">                  <span class="comment">// callback occurs with the decor set.</span></span><br><span class="line">                  a.onWindowAttributesChanged(l);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@VisibleForTesting</span><span class="comment">// 会调用 activity的onResume方法</span></span><br><span class="line">  <span class="keyword">public</span> ActivityClientRecord performResumeActivity(IBinder token, boolean finalStateRequest,</span><br><span class="line">          String reason) &#123;</span><br><span class="line">   r.activity.performResume(r.startsNotResumed, reason);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="实例化Activity"><a href="#实例化Activity" class="headerlink" title="实例化Activity"></a>实例化Activity</h4><p>利用反射实例化Activity</p>
<h5 id="Instrumentation-newActivity"><a href="#Instrumentation-newActivity" class="headerlink" title="Instrumentation.newActivity()"></a>Instrumentation.newActivity()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    String pkg = intent != <span class="keyword">null</span> &amp;&amp; intent.getComponent() != <span class="keyword">null</span></span><br><span class="line">            ? intent.getComponent().getPackageName() : <span class="keyword">null</span>;</span><br><span class="line">          <span class="comment">// instantiateActivity方法 利用反射实例化Activity对象 </span></span><br><span class="line">    <span class="keyword">return</span> getFactory(pkg).instantiateActivity(cl, className, intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">Activity <span class="title">instantiateActivity</span><span class="params">(<span class="meta">@NonNull</span> ClassLoader cl, <span class="meta">@NonNull</span> String className, <span class="meta">@Nullable</span> Intent intent)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">       <span class="comment">// 反射实例化Activity对象  </span></span><br><span class="line">        <span class="keyword">return</span> (Activity) cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Activity生命周期方法"><a href="#Activity生命周期方法" class="headerlink" title="Activity生命周期方法"></a>Activity生命周期方法</h3><h4 id="attach"><a href="#attach" class="headerlink" title="attach()"></a>attach()</h4><p>它是Activity内部的初始化方法(activity对象创建出来后就马上调用)</p>
<p><code>attach() </code>的调用发生在<code>onCreate()</code>之前</p>
<p>被<code>ActivityThread</code>调用，在<code> handleLaunchActivity()</code>-&gt; <code> -</code>&gt; <code>activity.attach(appContext,...);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// Window 对象被赋值</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">		...</span><br><span class="line">      <span class="comment">// 对Window设置WindowManager</span></span><br><span class="line">        mWindow.setWindowManager(</span><br><span class="line">                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">                mToken, mComponent.flattenToString(),</span><br><span class="line">                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);   </span><br><span class="line">	  <span class="comment">// 对Activity的 WindowManager赋值， get出来的是 WindowManagerImpl </span></span><br><span class="line">   mWindowManager = mWindow.getWindowManager();</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h4 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate()"></a>onCreate()</h4><p>和attach()一样被ActivityThread调用，在</p>
<p><code>ActivityThread.handleLaunchActivity()</code>-&gt; <code>ActivityThread.performLaunchActivity()</code>-&gt;</p>
<p><code>Instrumentation.callActivityOnCreate()</code>-&gt;<code>Activity.performCreate()</code>-&gt;<code>Activity.onCreate()</code></p>
<h5 id="Instrumentation-callActivityOnCreate"><a href="#Instrumentation-callActivityOnCreate" class="headerlink" title="Instrumentation.callActivityOnCreate()"></a>Instrumentation.callActivityOnCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle,</span></span></span><br><span class="line"><span class="function"><span class="params">        PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//调用Acitivity 对象的 performCreate() </span></span><br><span class="line">    <span class="comment">// performCreate() 会调用内部的onCreate方法</span></span><br><span class="line">    activity.performCreate(icicle, persistentState);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Activity-performCreate"><a href="#Activity-performCreate" class="headerlink" title="Activity.performCreate()"></a>Activity.performCreate()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">  			<span class="comment">// 调用onCreate方法</span></span><br><span class="line">        <span class="keyword">if</span> (persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">            onCreate(icicle, persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onCreate(icicle);</span><br><span class="line">        &#125;</span><br><span class="line">        ..</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="onResume"><a href="#onResume" class="headerlink" title="onResume()"></a>onResume()</h4><p><code>ActivityThread.handleResumeActivity()</code>-&gt;<code>ActivityThread.performResumeActivity()</code>-&gt;</p>
<p><code>Activity.performResume()</code>-&gt;<code>Instrumentation.callActivityOnResume()</code>-&gt;<code>Activity.OnResume()</code></p>
<h5 id="Activity-performResume"><a href="#Activity-performResume" class="headerlink" title="Activity.performResume()"></a>Activity.performResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performResume</span><span class="params">(<span class="keyword">boolean</span> followedByPause, String reason)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    mInstrumentation.callActivityOnResume(<span class="keyword">this</span>);</span><br><span class="line">  ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Instrumentation-callActivityOnResume"><a href="#Instrumentation-callActivityOnResume" class="headerlink" title="Instrumentation.callActivityOnResume()"></a>Instrumentation.callActivityOnResume()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnResume</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.mResumed = <span class="keyword">true</span>;</span><br><span class="line">    activity.onResume();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                am.match(activity, activity, activity.getIntent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Activity-setContentView"><a href="#Activity-setContentView" class="headerlink" title="Activity.setContentView()"></a>Activity.setContentView()</h3><p>Activity 设置布局是通过window（确切的说是PhoneWindow）对象连接的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="meta">@LayoutRes</span> <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Activity 内部window是 PhoneWindow对象</span></span><br><span class="line">      getWindow().setContentView(layoutResID);</span><br><span class="line">      initWindowDecorActionBar();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h2 id="Window-amp-PhoneWindow"><a href="#Window-amp-PhoneWindow" class="headerlink" title="Window&amp;PhoneWindow"></a>Window&amp;PhoneWindow</h2><p>Window与View通过DecorVIew产生联系</p>
<p>Activity内部持有 mWindow对象，mWindow 依赖PhoneWindow对象</p>
<p>PhoneWindow持有mDecor对象，mDecor其实是DecorView对象（继承自FrameLayout）</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210908165416162.png" alt="image-20210908165416162"></p>
<h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><h4 id="Window-getLocalFeatures"><a href="#Window-getLocalFeatures" class="headerlink" title="Window.getLocalFeatures()"></a>Window.getLocalFeatures()</h4><p>Windows的特征，Activity中调用的<code>requestWindowFeature(Window.FEATURE_NO_TITLE)</code>就是修改的这个值</p>
<p><strong>为什么requestWindowFeature() 方法要写在setContentView前面？</strong></p>
<p>因为setContentView() 要用到getLocalFeatures()的返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getLocalFeatures</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mLocalFeatures;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="findViewById"><a href="#findViewById" class="headerlink" title="findViewById"></a>findViewById</h4><p>实际调用的是DecorView的findviewby，id，就是找到系统布局模版中id是@android:id/content的布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">findViewById</span><span class="params">(<span class="meta">@IdRes</span> <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getDecorView().findViewById(id);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="getAttributes"><a href="#getAttributes" class="headerlink" title="getAttributes"></a>getAttributes</h4><p>窗口属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WindowManager.LayoutParams mWindowAttributes =</span><br><span class="line">      <span class="keyword">new</span> WindowManager.LayoutParams();</span><br><span class="line">     </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">      type = TYPE_APPLICATION;</span><br><span class="line">      format = PixelFormat.OPAQUE;</span><br><span class="line">  &#125;    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> WindowManager.<span class="function">LayoutParams <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mWindowAttributes;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="setWindowManager"><a href="#setWindowManager" class="headerlink" title="setWindowManager"></a>setWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 创建一个 WindowManagerImpl 对象</span></span><br><span class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h3><p>Activity 调用 <code>setContentView(int layoutResID)</code>时实际调用的是<code>window.setContentView(int resId)</code></p>
<p>而Activity 内部持有的是PhoneWindow对象的实例，所以其实调用的是PhonewIndow对象的方法</p>
<h4 id="调用installDecor-初始化的过程："><a href="#调用installDecor-初始化的过程：" class="headerlink" title="调用installDecor()初始化的过程："></a>调用installDecor()初始化的过程：</h4><ul>
<li><p>与DecorVIew建立联系</p>
<p>实例化一个DecorView对象，交给PhoneWIndow</p>
<p><code>setContentView(int layoutResID)</code> -&gt;<code>installDecor()</code>-&gt;<code> generateDecor(-1);</code></p>
</li>
<li><p>帮助 DecorView 添加一个根布局（root）</p>
<p>根据Window.getLocalFeatures()获得开发者配置的WIndow特性，选择不同的布局模板，交给DecorVIew创建根布局</p>
<p> <code>setContentView(int layoutResID)</code> -&gt; <code>installDecor();</code>-&gt;<code>generateLayout(mDecor)</code></p>
<p>-&gt; <code> mDecor.onResourcesLoaded(mLayoutInflater, layoutResource)</code></p>
</li>
</ul>
<p>![image-20210909142715857](../../../Library/Application Support/typora-user-images/image-20210909142715857.png)</p>
<ul>
<li><p>将Activity 自定义的布局加入Decor的根布局中id为<code>@android:id/content</code>的FrameLayout中</p>
<p>![image-20210909150251632](../../../Library/Application Support/typora-user-images/image-20210909150251632.png)</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">MenuBuilder</span>.<span class="title">Callback</span> </span>&#123;  </span><br><span class="line">  	<span class="comment">// DecorView是 Window里面的顶层View</span></span><br><span class="line">		<span class="keyword">private</span> DecorView mDecor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">  			 <span class="comment">// 初始化时 mContentParent 是 null</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 初始化Decor</span></span><br><span class="line">            installDecor();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            mContentParent.removeAllViews();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                    getContext());</span><br><span class="line">            transitionTo(newScene);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 将Activity的布局 layoutResID ，传入DecorView的根布局中</span></span><br><span class="line">            </span><br><span class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">        &#125;</span><br><span class="line">        mContentParent.requestApplyInsets();</span><br><span class="line">        <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">            cb.onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line"> 		&#125;</span><br><span class="line">   <span class="comment">// 初始化 DecorView 并为它添加根布局</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mForceDecorInstall = <span class="keyword">false</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建 DecorView 对象 赋值给mDecor</span></span><br><span class="line">            mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">            mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 初始化时mContentParent是 null的</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 给mContentParent 赋值</span></span><br><span class="line">          <span class="comment">//generateLayout() 返回的是ID为 android.R.id.content的FrameLayout（系统模版布局中）</span></span><br><span class="line">            mContentParent = generateLayout(mDecor); </span><br><span class="line">        &#125;      </span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 根据一些常用的配置进行设置</span></span><br><span class="line">			<span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowNoTitle, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_NO_TITLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBar, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="comment">// Don&#x27;t allow an action bar if there is no title.</span></span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBarOverlay, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            requestFeature(FEATURE_ACTION_BAR_OVERLAY);</span><br><span class="line">        &#125;  </span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// Inflate the window decor.</span></span><br><span class="line">       <span class="keyword">int</span> layoutResource;</span><br><span class="line">       <span class="comment">// features调用Window.getLocalFeatures()</span></span><br><span class="line">       <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="comment">// features 表示window的特性 ，比如有无title ，actionbar等</span></span><br><span class="line">      <span class="comment">// 根据 features 的不同对 layoutResource 赋值成不同的布局，就可以体现不同特性</span></span><br><span class="line">      <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            layoutResource = R.layout.screen_progress;</span><br><span class="line">           </span><br><span class="line">        &#125; </span><br><span class="line">         ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// 赋值 给  layoutResource 指定布局</span></span><br><span class="line">            layoutResource = R.layout.screen_simple;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mDecor.startChanging();</span><br><span class="line">  			<span class="comment">// 通过传入的打气筒和 layoutResource，创建一个View命名为root</span></span><br><span class="line">        <span class="comment">//  mDecor通过addView(root) 将view对象添加到内部 </span></span><br><span class="line">        mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line">				<span class="comment">// 调用的是window.findViewById()-&gt;DecorView.findViewById()</span></span><br><span class="line">  			<span class="comment">// 最终要找到的是系统模版中id是@android:id/content的ViewGroup</span></span><br><span class="line">        ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">        </span><br><span class="line">  			<span class="comment">// 根据配置做出一些设置</span></span><br><span class="line">  				...</span><br><span class="line">        <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) </span><br><span class="line">            mDecor.setWindowBackground(mBackgroundDrawable);</span><br><span class="line">            ...</span><br><span class="line">            mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回的是系统模板中id为android.R.id.content的FrameLayout  </span></span><br><span class="line">        <span class="keyword">return</span> contentParent;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="screen-simple-xml"><a href="#screen-simple-xml" class="headerlink" title="screen_simple.xml"></a>screen_simple.xml</h4><p>android-sdk-macosx/platforms/android-30/data/res/layout/screen_simple.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Actionbar 的布局，ViewStub可以节约内存--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/action_mode_bar_stub&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">&quot;@+id/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">&quot;@layout/action_mode_bar&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">&quot;?attr/actionBarTheme&quot;</span> /&gt;</span></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">         android:id=&quot;@android:id/content&quot;</span><br><span class="line">         android:layout_width=&quot;match_parent&quot;</span><br><span class="line">         android:layout_height=&quot;match_parent&quot;</span><br><span class="line">         android:foregroundInsidePadding=&quot;false&quot;</span><br><span class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="DecorView"><a href="#DecorView" class="headerlink" title="DecorView"></a>DecorView</h2><ul>
<li><p>根据PhoneWindow 传递的根布局信息创建根布局</p>
<p><code>onResourcesLoaded()</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 创建DecorView实例</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">        <span class="comment">// new 一个DecorView 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// 将PhoneWindow根据window内部feature属性设置的根布局加入到DecorView内部 </span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onResourcesLoaded</span><span class="params">(LayoutInflater inflater, <span class="keyword">int</span> layoutResource)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="comment">// 创建一个View对象，</span></span><br><span class="line">        <span class="keyword">final</span> View root = inflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (mDecorCaptionView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mDecorCaptionView.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addView(mDecorCaptionView,</span><br><span class="line">                        <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">            &#125;</span><br><span class="line">            mDecorCaptionView.addView(root,</span><br><span class="line">                    <span class="keyword">new</span> ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//通过add View 将这系统模板布局View加入到DecorView里面</span></span><br><span class="line">         </span><br><span class="line">            addView(root, <span class="number">0</span>, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        mContentRoot = (ViewGroup) root;</span><br><span class="line">        initializeElevation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h2><p>DecorView的父View（其实不是一个View）</p>
<p>打印<code>println(window.decorView.parent.toString())</code>得到parent为ViewRootImpl</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210909160559140.png" alt="image-20210909160559140"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootImpl</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>,</span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">AttachInfo</span>.<span class="title">Callbacks</span>, <span class="title">ThreadedRenderer</span>.<span class="title">DrawCallbacks</span> </span>&#123; </span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> Thread mThread;</span><br><span class="line">    <span class="keyword">final</span> View.AttachInfo mAttachInfo;</span><br><span class="line">          </span><br><span class="line">    <span class="keyword">final</span> ViewRootHandler mHandler = <span class="keyword">new</span> ViewRootHandler();</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewRootHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123; </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getMessageName</span><span class="params">(Message message)</span> </span>&#123;...&#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123; ...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">// 构造时赋值mThread对象</span></span><br><span class="line">    <span class="comment">// ViewRootImpl构造方法仅在WindowManagerGlobal中调用过</span></span><br><span class="line">    <span class="comment">// 调用它的方法是ActivityThread.performResumeActivity() ，所以mThread必然是主线程</span></span><br><span class="line">    <span class="comment">// checkThread()中将使用mThread  </span></span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">    <span class="comment">// 创建对象，传入handler</span></span><br><span class="line">    mAttachInfo = <span class="keyword">new</span> View.AttachInfo(mWindowSession, mWindow, display, <span class="keyword">this</span>, mHandler,    	<span class="keyword">this</span>, context);  </span><br><span class="line">    ...</span><br><span class="line">    &#125;        </span><br><span class="line">    <span class="comment">//检查线程    </span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 判断   Thread.currentThread()是否和 mThread对象 相同</span></span><br><span class="line">        <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</span><br><span class="line">                    <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 防止重复绘制的</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">        <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">            <span class="comment">// 检查线程</span></span><br><span class="line">            checkThread();</span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">            scheduleTraversals();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> 	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// view 即为DecorView</span></span><br><span class="line">     mView = view;</span><br><span class="line">   ...</span><br><span class="line">     <span class="comment">// 第一次调用 requestLayout，是自主调用，不是成为其他View的Parent后被迫调用</span></span><br><span class="line">     requestLayout();</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 将ViewRootImpl 设置为DecorView的 Parent</span></span><br><span class="line">     <span class="comment">// 这样才能串联自定义布局-&gt;系统模板布局-&gt;DocerView-ViewRootImpl</span></span><br><span class="line">     view.assignParent(<span class="keyword">this</span>);</span><br><span class="line"> 	&#125;  </span><br><span class="line">          </span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">          <span class="comment">// 向主线程post 一个 Runnable 对象： mTraversalRunnable, </span></span><br><span class="line">          <span class="comment">// postCallback类似handler post，是一个异步操作</span></span><br><span class="line">            mChoreographer.postCallback(</span><br><span class="line">                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</span><br><span class="line">            notifyRendererOfFramePending();</span><br><span class="line">            pokeDrawLockIfNeeded();</span><br><span class="line">     ..</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// runnable 调用了doTraversal()方法</span></span><br><span class="line">          <span class="comment">// 因为被异步post ，所以doTraversal会在下次循环时调用</span></span><br><span class="line">            doTraversal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 下次循环调用的  performTraversals()</span></span><br><span class="line">            performTraversals();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 核心方法 Traversals: 遍历</span></span><br><span class="line">    <span class="comment">// 生命周期就是拿着一个对象，调用对象上面的方法，</span></span><br><span class="line">    <span class="comment">// 这个方法也是依托顶层DecorView来出发（如同ActivityThread对应Activity生命周期方法的调用）</span></span><br><span class="line">    <span class="comment">// 它们是： performMeasure()， performLayout(), performDraw(),         </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 状态设置</span></span><br><span class="line">			... </span><br><span class="line">        mIsInTraversal = <span class="keyword">true</span>;</span><br><span class="line">        mWillDrawSoon = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span> windowSizeMayChange = <span class="keyword">false</span>;  </span><br><span class="line">       <span class="comment">// 1. 测量过程  调用decoerview.perform Measur() 先测量Window，再测量View树</span></span><br><span class="line">                </span><br><span class="line">      <span class="comment">// 尺寸相关，窗口属性， 预定义宽高，</span></span><br><span class="line">      <span class="comment">// 如果是Activity它的值和 ActivityThread，WindowManager.addView() 的窗口属性是一样的</span></span><br><span class="line">      WindowManager.LayoutParams lp = mWindowAttributes;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowWidth;</span><br><span class="line">        <span class="keyword">int</span> desiredWindowHeight;</span><br><span class="line">        <span class="keyword">if</span> (mFirst) &#123;</span><br><span class="line">            mFullRedrawNeeded = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 第一次必然进入，  mLayoutRequested = true，布局必然重新布置</span></span><br><span class="line">            mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">           <span class="comment">// 判断一下Window的级别         </span></span><br><span class="line">            <span class="keyword">if</span> (shouldUseDisplaySize(lp)) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Activity lp type参数是Application，而非系统窗口/键盘</span></span><br><span class="line">              <span class="comment">// 所以赋值为屏幕的宽高</span></span><br><span class="line">                desiredWindowWidth = frame.width();</span><br><span class="line">                desiredWindowHeight = frame.height();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将DecorView依附到Window上</span></span><br><span class="line">            <span class="comment">//host 是DecorView</span></span><br><span class="line">            host.dispatchAttachedToWindow(mAttachInfo, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; ...&#125; </span><br><span class="line">         <span class="comment">//传如DecorView，完成系统状态栏/导航栏的添加</span></span><br><span class="line">					dispatchApplyInsets(host); </span><br><span class="line">            ...</span><br><span class="line">       <span class="comment">// View执行post操作时，若发生崩溃 AttachInfo == null，</span></span><br><span class="line">       <span class="comment">// 也就拿不到handler对象，可执行的runnable会暂时存在一个队列中</span></span><br><span class="line">       <span class="comment">// 此时就是执行队列中runnable的时机  </span></span><br><span class="line">       getRunQueue().executeActions(mAttachInfo.mHandler);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//  第一次绘执行performTravelsal  mLayoutRequested = true    </span></span><br><span class="line">      <span class="comment">//  mStopped只有Acitivity Stop的时候才为true  </span></span><br><span class="line">      <span class="keyword">boolean</span> layoutRequested = mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);</span><br><span class="line">      <span class="keyword">if</span> (layoutRequested) &#123;</span><br><span class="line">        ...</span><br><span class="line">            <span class="comment">// 第一次测量：对整个视图树的测量，是确定window的大小</span></span><br><span class="line">            windowSizeMayChange |= measureHierarchy(host, lp, res,</span><br><span class="line">                    desiredWindowWidth, desiredWindowHeight);</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 第一次执行必然进入</span></span><br><span class="line">      <span class="keyword">if</span> (mFirst || windowShouldResize || viewVisibilityChanged || cutoutChanged || params != <span class="keyword">null</span>|| mForceNextWindowRelayout) &#123;</span><br><span class="line">          ...</span><br><span class="line">           <span class="comment">// 屏幕的宽高已经确定，但Window大小并不是应用层决定的，所有的服务都是系统服务WMS完成的，</span></span><br><span class="line">           <span class="comment">// 所以尺寸调整在relayoutWindow方法通知WMS，同时执行时我们的Window尺寸会从初识值变成固定值</span></span><br><span class="line">           relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);  </span><br><span class="line">          ... </span><br><span class="line">             updatedConfiguration = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// mStopped只有Acitivity Stop的时候才为true，所以activity启动状态下一定为true</span></span><br><span class="line">      <span class="keyword">if</span> (!mStopped || mReportNextDraw) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> focusChangedDueToTouchMode = ensureTouchModeLocally(</span><br><span class="line">                        (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != <span class="number">0</span>);             <span class="comment">// updatedConfiguration 第一次进入时设置为true，可以进入</span></span><br><span class="line">                <span class="keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()</span><br><span class="line">                        || mHeight != host.getMeasuredHeight() || dispatchApplyInsets ||</span><br><span class="line">                        updatedConfiguration) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                     <span class="comment">//第二次测量尺寸，这次是真正的测量， mDecorView 测量所有子View</span></span><br><span class="line">                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line">                   ....</span><br><span class="line">                    layoutRequested = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ... </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//2. 视图树的布局过程 调用 DecorView的 performLayout 对View树进行布局，</span></span><br><span class="line">        <span class="comment">//这一步可以得到View真正的位置和大小</span></span><br><span class="line">          </span><br><span class="line">        <span class="comment">// didLayout= true ，所以 triggerGlobalLayoutListener = true</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);          </span><br><span class="line">        <span class="keyword">boolean</span> triggerGlobalLayoutListener = didLayout</span><br><span class="line">                || mAttachInfo.mRecomputeGlobalAttributes;</span><br><span class="line">        <span class="keyword">if</span> (didLayout) &#123;</span><br><span class="line">           <span class="comment">//调用子View的layout方法进行布局，布局完成后就能确定尺寸和位置了</span></span><br><span class="line">            performLayout(lp, mWidth, mHeight);</span><br><span class="line">					...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">if</span> (triggerGlobalLayoutListener) &#123;</span><br><span class="line">            mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">// 整个布局树已经完成，触发回调，这也是为什么这个回调会被推荐用来获取控件的大小</span></span><br><span class="line">          <span class="comment">// 因为用post的方法，在onResume中取，会在下一个消息序列获取宽和高</span></span><br><span class="line">          <span class="comment">// 而使用回调可以在同一个消息队列中获得宽和高</span></span><br><span class="line">            mAttachInfo.mTreeObserver.dispatchOnGlobalLayout();</span><br><span class="line">        &#125;</span><br><span class="line">			 ...</span><br><span class="line">         <span class="comment">//3. 绘制过程 调用DecorView的performDraw()方法对View进行绘制</span></span><br><span class="line">         </span><br><span class="line">         <span class="comment">// isViewVisible若 = false 则不绘制</span></span><br><span class="line">        <span class="keyword">boolean</span> cancelDraw = mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cancelDraw) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;</span><br><span class="line">                    mPendingTransitions.get(i).startChangingAnimations();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingTransitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">					<span class="comment">// 大多数情况下都会走入 performDraw，API 29之前</span></span><br><span class="line">          <span class="comment">// 要判断SurfaceView是否是新创建的，</span></span><br><span class="line">          <span class="comment">// 若是新创建的，则在第二次调用performTraversals时才能调用performDraw</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 绘制过程不是直接调用DecorView的方法，重点是根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            performDraw();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 若因为某些原因没能成功执行 performDraw() </span></span><br><span class="line">          <span class="comment">// 测量，布局流程也不会重新执行一遍，只重新执行绘制 performMeasrue() ，performLayout()</span></span><br><span class="line">          <span class="comment">// 因为若是测量过 mLayoutRequested = true ，不会重新走测量/逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (isViewVisible) &#123;</span><br><span class="line">                <span class="comment">// Try again</span></span><br><span class="line">                scheduleTraversals();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingTransitions != <span class="keyword">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAttachInfo.mContentCaptureEvents != <span class="keyword">null</span>) &#123;</span><br><span class="line">            notifyContentCatpureEvents();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mIsInTraversal = <span class="keyword">false</span>;          </span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">measureHierarchy</span><span class="params">(<span class="keyword">final</span> View host, <span class="keyword">final</span> WindowManager.LayoutParams lp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Resources res, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowWidth, <span class="keyword">final</span> <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// 是否是一次成功的测量，默认false</span></span><br><span class="line">        <span class="keyword">boolean</span> goodMeasure = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (lp.width == ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">if</span> (!goodMeasure) &#123;</span><br><span class="line">          <span class="comment">// 传入布局，也就是window的宽高和布局参数传进去，也就是View中 onMeasure方法需要的</span></span><br><span class="line">            childWidthMeasureSpec = getRootMeasureSpec(desiredWindowWidth, lp.width);</span><br><span class="line">            childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);</span><br><span class="line">          <span class="comment">// 第一次：测量大小，其实是测量window的大小，开始测量</span></span><br><span class="line">            performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">            ..</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开始测量  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// mView 也就是DecorView，执行measure方法，接下来一层一层的子View也会进行遍历，完成测量</span></span><br><span class="line">            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 获得测量参数  </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> measureSpec;</span><br><span class="line">        <span class="keyword">switch</span> (rootDimension) &#123;</span><br><span class="line">        <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</span><br><span class="line">            <span class="comment">// Window can&#x27;t resize. Force root view to be windowSize.</span></span><br><span class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</span><br><span class="line">          ...</span><br><span class="line">        <span class="keyword">return</span> measureSpec;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="comment">// 布局过程</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> desiredWindowHeight)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">        <span class="keyword">final</span> View host = mView;</span><br><span class="line">        ... <span class="comment">// 调用 decorView和所有子View的 layout 进行布局</span></span><br><span class="line">            host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</span><br><span class="line">           ...</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 绘制过程</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</span><br><span class="line">          <span class="comment">// 根据是否使用硬件加速来确定使用硬件绘制还是软件绘制</span></span><br><span class="line">            <span class="keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;</span><br><span class="line">              ...</span><br><span class="line">                <span class="comment">// 硬件绘制 draw() 方法</span></span><br><span class="line">                mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             ...</span><br><span class="line">								<span class="comment">// 软件绘制 draw() 方法</span></span><br><span class="line">                <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset,</span><br><span class="line">                        scalingRequired, dirty, surfaceInsets)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> scalingRequired, Rect dirty, Rect surfaceInsets)</span> </span>&#123;</span><br><span class="line">            ...</span><br><span class="line">						<span class="comment">// 软件绘制</span></span><br><span class="line">            mView.draw(canvas);</span><br><span class="line">           ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;      </span><br><span class="line">      </span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<h2 id="View-class"><a href="#View-class" class="headerlink" title="View.class"></a>View.class</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@UiThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">Drawable</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</span></span><br><span class="line"><span class="class">        <span class="title">AccessibilityEventSource</span> </span>&#123;	</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    AttachInfo mAttachInfo;  </span><br><span class="line">    <span class="keyword">final</span> Handler mHandler;          </span><br><span class="line">    <span class="comment">// 设置View的Parent      </span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">assignParent</span><span class="params">(ViewParent parent)</span> </span>&#123;</span><br><span class="line">		  </span><br><span class="line">    		<span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">   		     mParent = parent;</span><br><span class="line">    		&#125; ..</span><br><span class="line">    &#125;</span><br><span class="line">          </span><br><span class="line">	</span><br><span class="line">		<span class="comment">// 建立View和Window之间的依赖</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchAttachedToWindow</span><span class="params">(AttachInfo info, <span class="keyword">int</span> visibility)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// AttachInfo是ViewRootImpl传入的，我们可以用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">        mAttachInfo = info;</span><br><span class="line">				...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 系统自带方法也是用 mAttachInfo有没有值来判断View是否依附于Window</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAttachedToWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mAttachInfo != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切换线程需要借助handler，handler是随着AttachInfo传来的</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">        <span class="comment">// 有时发生崩溃了，但是View仍然被创建出来了，Handler就是空的，此时post不会立刻发送Runnable</span></span><br><span class="line">        <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> attachInfo.mHandler.post(action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若发生崩溃，attachInfo = null ，先把Runnable存到一个队列当中</span></span><br><span class="line">        getRunQueue().post(action);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mHandler是创建AttachInfo对象时构造函数传来的，而AttachInfo对象是ViewRootImpl构造函数中创建的</span></span><br><span class="line">          </span><br><span class="line">    AttachInfo(IWindowSession session, IWindow window, Display display,</span><br><span class="line">                ViewRootImpl viewRootImpl, Handler handler, Callbacks effectPlayer,</span><br><span class="line">                Context context) &#123;</span><br><span class="line">            ...</span><br><span class="line">            mViewRootImpl = viewRootImpl;</span><br><span class="line">            mHandler = handler;</span><br><span class="line">            ...</span><br><span class="line">        &#125;  </span><br><span class="line">    <span class="comment">// 表示正在布局中，防止重复布局的措施      </span></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">         <span class="comment">// 表示正在布局的flag，在layout中才会消除掉</span></span><br><span class="line">        mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据flag确定View是否处于布局过程中      </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLayoutRequested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line">    &#125;          </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">     ....</span><br><span class="line">			<span class="comment">// 重置标志位</span></span><br><span class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">      <span class="comment">// 判断是否已经在布局中，若正在布局中，则不会往上层调用 requestLayout()</span></span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">            mParent.requestLayout();</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WindowManagerImpl，WindowManager，WIndowManagerGlobal"><a href="#WindowManagerImpl，WindowManager，WIndowManagerGlobal" class="headerlink" title="WindowManagerImpl，WindowManager，WIndowManagerGlobal"></a>WindowManagerImpl，WindowManager，WIndowManagerGlobal</h2><p>每个Acitivty 都有一个WIndowManager对象，一个程序可能有很多歌WIndowManagerImpl，不同Manager都会把操作转交给WindowManagerGlobal，这样以后想做统一操作在Global中操作非常简单</p>
<h3 id="WindowManagerGlobal"><a href="#WindowManagerGlobal" class="headerlink" title="WindowManagerGlobal"></a>WindowManagerGlobal</h3><p>记录所有的View和ViewRootImpl 这个类是隐藏的，可以得到</p>
<p>Activity在生命周期中能拿到Global，而Dialog没有生命周期，只能用反射拿到所有底层View和所有属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerGlobal</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 记录所有的View和ViewRootImpl，布局参数</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;ViewRootImpl&gt;();    </span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =</span><br><span class="line">            <span class="keyword">new</span> ArrayList&lt;WindowManager.LayoutParams&gt;();		</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">            Display display, Window parentWindow, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">      ViewRootImpl root;</span><br><span class="line">       <span class="comment">// 初始化   ViewRootImpl</span></span><br><span class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);	</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 每次创建后都会存储View，ViewRootImpl和各种参数</span></span><br><span class="line">        mViews.add(view);</span><br><span class="line">        mRoots.add(root);</span><br><span class="line">      <span class="comment">// 和Windows的布局参数是统一的</span></span><br><span class="line">        mParams.add(wparams);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 关键 调用 ViewRootImpl的setView方法</span></span><br><span class="line">      root.setView(view, wparams, panelParentView, userId);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="WindowManagerImpl"><a href="#WindowManagerImpl" class="headerlink" title="WindowManagerImpl"></a>WindowManagerImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h4 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h4><p>Activity 的成员变量，是一个接口继承了ViewManager，实际上使用的实例是WindowManagerImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemService(Context.WINDOW_SERVICE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowManager</span> <span class="keyword">extends</span> <span class="title">ViewManager</span> </span>&#123;</span><br><span class="line">  	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ViewManager"><a href="#ViewManager" class="headerlink" title="ViewManager"></a>ViewManager</h4><p>只是一个接口 ActivityThread 中 有使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title">WindowManager</span> </span>&#123;</span><br><span class="line">  <span class="comment">// global是个单例对象</span></span><br><span class="line">	 <span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br><span class="line">  </span><br><span class="line"> 		 <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">       <span class="comment">//add View 丢该global去做</span></span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="在子线程中更新-UI-不报错的几种方式"><a href="#在子线程中更新-UI-不报错的几种方式" class="headerlink" title="在子线程中更新 UI 不报错的几种方式"></a>在子线程中更新 UI 不报错的几种方式</h2><p>子线程更新UI不一定会报错</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">requestWindowFeature(Window.FEATURE_NO_TITLE)</span><br><span class="line">setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">text = findViewById(R.id.text)</span><br><span class="line"><span class="comment">// 直接在子线程更新ui 不会崩溃</span></span><br><span class="line">thread &#123;</span><br><span class="line">    text.text = <span class="string">&quot;ok!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text.setOnClickListener(<span class="keyword">object</span>: View.OnClickListener &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        println(window.decorView.parent.toString())</span><br><span class="line">        <span class="comment">// 子线程更新 ui 会崩溃</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            text.text = <span class="string">&quot;onCreate!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>报错信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Process: com.hencoder.customviewdrawing, PID: 23675</span><br><span class="line">  android.view.ViewRootImpl<span class="variable">$CalledFromWrongThreadException</span>: Only the original thread that created a view hierarchy can touch its views.</span><br><span class="line">      at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:8825)</span><br><span class="line">      at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1535)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.view.View.requestLayout(View.java:24661)</span><br><span class="line">      at android.widget.TextView.checkForRelayout(TextView.java:9762)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6326)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6154)</span><br><span class="line">      at android.widget.TextView.setText(TextView.java:6106)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:31)</span><br><span class="line">      at com.hencoder.customviewdrawing.MainActivity$onCreate$2$onClick<span class="variable">$1</span>.invoke(MainActivity.kt:26)</span><br><span class="line">      at kotlin.concurrent.ThreadsKt$thread$thread<span class="variable">$1</span>.run(Thread.kt:30)</span><br></pre></td></tr></table></figure>
<p>对应报错的位置则是View.requestLayout() 中一致调用到ViewRootImpl.requestLayout()</p>
<p>而ViewRootImpl是decorView的parentView</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mMeasureCache != <span class="keyword">null</span>) mMeasureCache.clear();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// Only trigger request-during-layout logic if this is the view requesting it,</span></span><br><span class="line">           <span class="comment">// not the views in its parent hierarchy</span></span><br><span class="line">           ViewRootImpl viewRoot = getViewRootImpl();</span><br><span class="line">           <span class="keyword">if</span> (viewRoot != <span class="keyword">null</span> &amp;&amp; viewRoot.isInLayout()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">this</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mPrivateFlags |= PFLAG_FORCE_LAYOUT;</span><br><span class="line">       mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line">			<span class="comment">// 若parent == null 根本不会调用  ViewRootImp.requestLayout()</span></span><br><span class="line">       <span class="comment">//  更不会调用  ViewRootImpl.checkThread();</span></span><br><span class="line">       <span class="keyword">if</span> (mParent != <span class="keyword">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">           mParent.requestLayout();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mAttachInfo != <span class="keyword">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="keyword">this</span>) &#123;</span><br><span class="line">           mAttachInfo.mViewRequestingLayout = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="为什么子线程更新UI会报错？"><a href="#为什么子线程更新UI会报错？" class="headerlink" title="为什么子线程更新UI会报错？"></a>为什么子线程更新UI会报错？</h3><p>ViewRootImpl成为控件树最顶层DecorView的Parent时，这样才有可能更新UI的时候触发他的requestLayout(),</p>
<p>只有触发了requestLayout()才会调用它的检查线程方法checkThread()</p>
<h3 id="1-主线程申请成功后子线程申请"><a href="#1-主线程申请成功后子线程申请" class="headerlink" title="1.主线程申请成功后子线程申请"></a>1.主线程申请成功后子线程申请</h3><p>利用View 防止重复绘制的优化，先进行一次requestLayout()，第二次就会被忽略</p>
<p>若调用View 触发requestLayout()，会让整条View链的所有View 设置一个Flag：<code> mPrivateFlags |= PFLAG_FORCE_LAYOUT;</code>,表示正在布局，在layout的时候才会把它消除掉，</p>
<p>再次调用View的requestLayout()时，View会根据标志位判断，若标志位表示正在布局，则代表已经申请过requestLayout(），View不会再调用上层父布局的requestLayout()，这样就不会触发ViewRootImpl的线程检查</p>
<p>类似的，TextView里面</p>
<p>现在主线程调用setText，会触发 reqeustLayout()</p>
<p>子线程调用setText时，相当于连续触发reqeustLayout()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">     setTextInternal(text);<span class="comment">// 已经设置好文字了</span></span><br><span class="line">    <span class="keyword">if</span> (mLayout != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// mLayout 不为空，会触发requestLayout()</span></span><br><span class="line">        checkForRelayout();</span><br><span class="line">    &#125;   ....         </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ....  requestLayout(); ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> textview = findViewById&lt;TextView&gt;(R.id.textview)</span><br><span class="line"></span><br><span class="line">textview.setOnClickLitener &#123;</span><br><span class="line">  textView.text = <span class="string">&quot;Main&quot;</span> <span class="comment">// 或者    it.requestLayout()</span></span><br><span class="line">  tread &#123;</span><br><span class="line">    textview.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​                                                                             </p>
<h3 id="2-在子线程中创建-ViewRootImpl"><a href="#2-在子线程中创建-ViewRootImpl" class="headerlink" title="2. 在子线程中创建 ViewRootImpl"></a><strong>2.</strong> 在子线程中创建 ViewRootImpl</h3><p>ViewRootImpl检查线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display, IWindowSession session,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> useSfChoreographer)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line"> ... mThread = Thread.currentThread(); ...</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查线程使用的mThread 对象</span></span><br><span class="line">      <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>mThread对象是初始化时构建的，创建ViewRootImpl时所在的线程就是mThread所在的线程<br>ViewRootImpl是WindowManagerGlobal 调用addView()时创建的<br>由于WindowMangaerGlobal是隐藏类，我们可以通过WindowManager来做这件事 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">thread &#123;</span><br><span class="line">  <span class="comment">// ViewRootImpl 需要一个Handler（ ViewRootHandler），而Handler需要Looper，子线程没有Looper</span></span><br><span class="line">  Looper.prepare()</span><br><span class="line">  <span class="comment">// 在子线程中创建一个View</span></span><br><span class="line">  <span class="keyword">val</span> button = Button(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// 让它在子线程中创建一个ViewRootImpl，它最终会调用WindowManagerGlobal.addView()</span></span><br><span class="line">  windowManager.addView(button,WinowManager.LayoutParams())</span><br><span class="line">  button.setOnClickLitener &#123;</span><br><span class="line">    buttun.text = <span class="string">&quot;<span class="subst">$&#123;Thread.currentThread().name&#125;</span> : <span class="subst">$&#123;SystemClock.uptimeMillis()&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 只有Handler和Looper ，handler无法正常处理任务，还需要让Looper轮训起来</span></span><br><span class="line">  Looper.loop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="子线程弹Toast"><a href="#子线程弹Toast" class="headerlink" title="子线程弹Toast"></a>子线程弹Toast</h4><p>报错不同，但是同样可以通过代码前后增加<code>   Looper.prepare()</code>,<code>    Looper.loop()</code>解决</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210916223001494.png" alt="image-20210916223001494"></p>
<h3 id="3-利用硬件加速机制绕开-requestLayout"><a href="#3-利用硬件加速机制绕开-requestLayout" class="headerlink" title="3. 利用硬件加速机制绕开 requestLayout()"></a>3. 利用硬件加速机制绕开 requestLayout()</h3><p>在硬件加速的支持下，如果控件只是经常了 invalidate() ，而没有触发requestLayout() 是不会触发。ViewRootImpl的checkThread() 的。</p>
<p>子View会依赖父ViewGroup的invalidate()实现，而作为最顶层的ViewRootImpl，它的invalidate()方法会直接调用scheduleTraversals();绘制图形，而不像requestLayout() 在调用scheduleTraversals()之前要chekThread</p>
<p>TextView.setView()会调用  checkForRelayout() 方法，宽度不变或者宽高都不变则只会调用invalidate();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence text, BufferType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">boolean</span> notifyBefore, <span class="keyword">int</span> oldlen)</span> </span>&#123;</span><br><span class="line">      checkForRelayout() </span><br><span class="line">   &#125;    </span><br><span class="line"></span><br><span class="line">	<span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForRelayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 判断宽度是不是固定/不变的</span></span><br><span class="line">       <span class="keyword">if</span> ((mLayoutParams.width != LayoutParams.WRAP_CONTENT</span><br><span class="line">               || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))</span><br><span class="line">               &amp;&amp; (mHint == <span class="keyword">null</span> || mHintLayout != <span class="keyword">null</span>)</span><br><span class="line">               &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">         ...</span><br><span class="line">           makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,</span><br><span class="line">                         mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(), <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mEllipsize != TextUtils.TruncateAt.MARQUEE) &#123;</span><br><span class="line">               <span class="comment">// In a fixed-height view, so use our new text layout.</span></span><br><span class="line">               <span class="keyword">if</span> (mLayoutParams.height != LayoutParams.WRAP_CONTENT</span><br><span class="line">                       &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 高度是不是和以前一样/固定的</span></span><br><span class="line">               <span class="keyword">if</span> (mLayout.getHeight() == oldht</span><br><span class="line">                       &amp;&amp; (mHintLayout == <span class="keyword">null</span> || mHintLayout.getHeight() == oldht)) &#123;</span><br><span class="line">                   autoSizeText();</span><br><span class="line">                 <span class="comment">// 只调用invalidate()</span></span><br><span class="line">                   invalidate();</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 同时调用  invalidate 和 requestLayout</span></span><br><span class="line">           requestLayout();</span><br><span class="line">           invalidate();</span><br><span class="line">       &#125; 。。。</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       invalidate(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">       invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// 的最终调用</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">         </span></span></span><br><span class="line"><span class="function"><span class="params">     ...</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">final</span> ViewParent p = mParent;</span></span></span><br><span class="line"><span class="function"><span class="params">          ...</span></span></span><br><span class="line"><span class="function"><span class="params">               // 父ViewGroup的  invalidateChild ，传入自身          </span></span></span><br><span class="line"><span class="function"><span class="params">               p.invalidateChild(<span class="keyword">this</span>, damage)</span></span>;</span><br><span class="line">          ...</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ViewGroup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span> &amp;&amp; attachInfo.mHardwareAccelerated) &#123;</span><br><span class="line">        <span class="comment">// 如果是硬件加速，则进入硬件加速捷径</span></span><br><span class="line">        onDescendantInvalidated(child, child);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View target)</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//一致调用它的parent的方法，最顶层为ViewRootImpl</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParent.onDescendantInvalidated(<span class="keyword">this</span>, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewRootImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDescendantInvalidated</span><span class="params">(<span class="meta">@NonNull</span> View child, <span class="meta">@NonNull</span> View descendant)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">       <span class="comment">// 直接调用了 invalidate</span></span><br><span class="line">      invalidate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      mDirty.set(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</span><br><span class="line">      <span class="keyword">if</span> (!mWillDrawSoon) &#123;</span><br><span class="line">        <span class="comment">// 直接绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mHandlingLayoutInLayoutRequest 标志位表示是否正在布局</span></span><br><span class="line">      <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">          <span class="comment">// 检查线程</span></span><br><span class="line">          checkThread();</span><br><span class="line">          mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">          <span class="comment">// 绘制</span></span><br><span class="line">          scheduleTraversals();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-SurfaceView"><a href="#4-SurfaceView" class="headerlink" title="4.SurfaceView"></a>4.SurfaceView</h3><p>Android 中有一个控件 SurfaceView ，它可以通过 holder 获得 Canvas 对象， 可以直接在子线程中更新 UI。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89view/" rel="tag"># 自定义view</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/" rel="prev" title="自定义view布局01:布局流程完全解析">
      <i class="fa fa-chevron-left"></i> 自定义view布局01:布局流程完全解析
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/10/08/View%E7%9A%84%E8%A7%A6%E6%91%B8%E5%8F%8D%E9%A6%88%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" rel="next" title="View的触摸反馈原理全解析">
      View的触摸反馈原理全解析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#View-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">View 绘制流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#View-%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E4%B8%BB%E8%A6%81%E5%AF%B9%E8%B1%A1%E5%9B%BE%E7%A4%BA"><span class="nav-number">1.1.</span> <span class="nav-text">View 绘制流程主要对象图示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">View绘制流程函数调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity%E4%B8%8EView"><span class="nav-number">1.3.</span> <span class="nav-text">Activity与View</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%92%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.3.1.</span> <span class="nav-text">Activity的实例化和生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">ActivityThread</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96Activity"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">实例化Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Instrumentation-newActivity"><span class="nav-number">1.3.1.2.1.</span> <span class="nav-text">Instrumentation.newActivity()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%96%B9%E6%B3%95"><span class="nav-number">1.3.2.</span> <span class="nav-text">Activity生命周期方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#attach"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">attach()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#onCreate"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">onCreate()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Instrumentation-callActivityOnCreate"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">Instrumentation.callActivityOnCreate()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Activity-performCreate"><span class="nav-number">1.3.2.2.2.</span> <span class="nav-text">Activity.performCreate()</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#onResume"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">onResume()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Activity-performResume"><span class="nav-number">1.3.2.3.1.</span> <span class="nav-text">Activity.performResume()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Instrumentation-callActivityOnResume"><span class="nav-number">1.3.2.3.2.</span> <span class="nav-text">Instrumentation.callActivityOnResume()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-setContentView"><span class="nav-number">1.3.3.</span> <span class="nav-text">Activity.setContentView()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Window-amp-PhoneWindow"><span class="nav-number">1.4.</span> <span class="nav-text">Window&amp;PhoneWindow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Window"><span class="nav-number">1.4.1.</span> <span class="nav-text">Window</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Window-getLocalFeatures"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">Window.getLocalFeatures()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findViewById"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">findViewById</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getAttributes"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">getAttributes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setWindowManager"><span class="nav-number">1.4.2.</span> <span class="nav-text">setWindowManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PhoneWindow"><span class="nav-number">1.4.3.</span> <span class="nav-text">PhoneWindow</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8installDecor-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">调用installDecor()初始化的过程：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#screen-simple-xml"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">screen_simple.xml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecorView"><span class="nav-number">1.5.</span> <span class="nav-text">DecorView</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ViewRootImpl"><span class="nav-number">1.6.</span> <span class="nav-text">ViewRootImpl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View-class"><span class="nav-number">1.7.</span> <span class="nav-text">View.class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WindowManagerImpl%EF%BC%8CWindowManager%EF%BC%8CWIndowManagerGlobal"><span class="nav-number">1.8.</span> <span class="nav-text">WindowManagerImpl，WindowManager，WIndowManagerGlobal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WindowManagerGlobal"><span class="nav-number">1.8.1.</span> <span class="nav-text">WindowManagerGlobal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WindowManagerImpl"><span class="nav-number">1.8.2.</span> <span class="nav-text">WindowManagerImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#WindowManager"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">WindowManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ViewManager"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">ViewManager</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%AD%90%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%9B%B4%E6%96%B0-UI-%E4%B8%8D%E6%8A%A5%E9%94%99%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">1.9.</span> <span class="nav-text">在子线程中更新 UI 不报错的几种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AD%90%E7%BA%BF%E7%A8%8B%E6%9B%B4%E6%96%B0UI%E4%BC%9A%E6%8A%A5%E9%94%99%EF%BC%9F"><span class="nav-number">1.9.1.</span> <span class="nav-text">为什么子线程更新UI会报错？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%BB%E7%BA%BF%E7%A8%8B%E7%94%B3%E8%AF%B7%E6%88%90%E5%8A%9F%E5%90%8E%E5%AD%90%E7%BA%BF%E7%A8%8B%E7%94%B3%E8%AF%B7"><span class="nav-number">1.9.2.</span> <span class="nav-text">1.主线程申请成功后子线程申请</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9C%A8%E5%AD%90%E7%BA%BF%E7%A8%8B%E4%B8%AD%E5%88%9B%E5%BB%BA-ViewRootImpl"><span class="nav-number">1.9.3.</span> <span class="nav-text">2. 在子线程中创建 ViewRootImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%BC%B9Toast"><span class="nav-number">1.9.3.1.</span> <span class="nav-text">子线程弹Toast</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%A9%E7%94%A8%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E6%9C%BA%E5%88%B6%E7%BB%95%E5%BC%80-requestLayout"><span class="nav-number">1.9.4.</span> <span class="nav-text">3. 利用硬件加速机制绕开 requestLayout()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-SurfaceView"><span class="nav-number">1.9.5.</span> <span class="nav-text">4.SurfaceView</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oldnineping"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">oldnineping</p>
  <div class="site-description" itemprop="description">技术日记和杂七杂八的dx</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oldnineping</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
