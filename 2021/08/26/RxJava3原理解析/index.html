<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="RxJava 3 的原理完全解析基本用法123456789101112131415161718192021222324 @GET(&quot;users&#x2F;&amp;#123;username&amp;#125;&#x2F;repos&quot;)&#x2F;&#x2F; Observable和Flow都过重，网络请求 推荐singlefun getRepos(@Path(&quot;username&quot;) username: Stri">
<meta property="og:type" content="article">
<meta property="og:title" content="RxJava3原理解析">
<meta property="og:url" content="http://example.com/2021/08/26/RxJava3%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="地球上的小东西">
<meta property="og:description" content="RxJava 3 的原理完全解析基本用法123456789101112131415161718192021222324 @GET(&quot;users&#x2F;&amp;#123;username&amp;#125;&#x2F;repos&quot;)&#x2F;&#x2F; Observable和Flow都过重，网络请求 推荐singlefun getRepos(@Path(&quot;username&quot;) username: Stri">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174653269.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174752970.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210827153255139.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155354768.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155602490.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155936495.png">
<meta property="og:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174959565.png">
<meta property="article:published_time" content="2021-08-26T08:40:47.000Z">
<meta property="article:modified_time" content="2021-12-10T02:09:41.675Z">
<meta property="article:author" content="oldnineping">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="RxJava3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174653269.png">

<link rel="canonical" href="http://example.com/2021/08/26/RxJava3%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>RxJava3原理解析 | 地球上的小东西</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">地球上的小东西</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">hiahiahiahia</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/26/RxJava3%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="oldnineping">
      <meta itemprop="description" content="技术日记和杂七杂八的dx">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="地球上的小东西">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RxJava3原理解析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-26 16:40:47" itemprop="dateCreated datePublished" datetime="2021-08-26T16:40:47+08:00">2021-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-10 10:09:41" itemprop="dateModified" datetime="2021-12-10T10:09:41+08:00">2021-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/RxJava3/" itemprop="url" rel="index"><span itemprop="name">RxJava3</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="RxJava-3-的原理完全解析"><a href="#RxJava-3-的原理完全解析" class="headerlink" title="RxJava 3 的原理完全解析"></a>RxJava 3 的原理完全解析</h1><h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="meta">@GET(<span class="meta-string">&quot;users/&#123;username&#125;/repos&quot;</span>)</span></span><br><span class="line"><span class="comment">// Observable和Flow都过重，网络请求 推荐single</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getRepos</span><span class="params">(<span class="meta">@Path(<span class="meta-string">&quot;username&quot;</span>)</span> username: <span class="type">String</span>)</span></span>: Single&lt;List&lt;Repo&gt;&gt;</span><br><span class="line">...</span><br><span class="line">api.getRepos(<span class="string">&quot;rengwuxian&quot;</span>)</span><br><span class="line"> .subscribeOn(Schedulers.io())<span class="comment">//请求切换到io线程</span></span><br><span class="line"> .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 回调在主线程</span></span><br><span class="line">  .subscribe(<span class="keyword">object</span> : SingleObserver&lt;MutableList&lt;Repo&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(repos: <span class="type">MutableList</span>&lt;<span class="type">Repo</span>&gt;)</span></span> &#123;</span><br><span class="line">       textView.text = <span class="string">&quot;Result :<span class="subst">$&#123;repos!![<span class="number">0</span>].name&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSubscribe</span><span class="params">(d: <span class="type">Disposable</span>?)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 订阅产生之后就会回调（网络请求之前）所以适合初始化</span></span><br><span class="line">   <span class="comment">// dispose 丢弃，一般使用时会通知上游停止生产</span></span><br><span class="line">   textView.text = <span class="string">&quot;正在请求&quot;</span></span><br><span class="line">   disposeable = d</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">     textView.text = e.message ?: e.javaClass.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h2><p>RxJava 的整体结构是一条链，其中:</p>
<ol>
<li>链的最上游:生产者 Observable</li>
<li>链的最下游:观察者 Observer</li>
<li>链的中间:各个中介节点，既是下游的 Observable，又是上游的 Observer</li>
</ol>
<h2 id="创建："><a href="#创建：" class="headerlink" title="创建："></a>创建：</h2><p>Single 为例:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">val</span> single = Single.just(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"> single.subscribe(<span class="keyword">object</span> : SingleObserver&lt;String?&gt; &#123;</span><br><span class="line"> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(t: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">       textView.text = t</span><br><span class="line">  &#125;</span><br><span class="line">        ...</span><br><span class="line"> &#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Single</span>&lt;<span class="type">@NonNull T</span>&gt; <span class="title">implements</span> <span class="title">SingleSource</span>&lt;<span class="type">T</span>&gt; </span>&#123; </span><br><span class="line"> 	</span><br><span class="line">  <span class="keyword">public</span> static &lt;<span class="meta">@NonNull</span> T&gt; Single&lt;T&gt; just(T item) &#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="comment">// 钩子函数，重点在于传入了SingleJust实例</span></span><br><span class="line">        <span class="keyword">return</span> RxJavaPlugins.onAssembly(new SingleJust&lt;&gt;(item));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> void subscribe(<span class="meta">@NonNull</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">       </span><br><span class="line">				<span class="comment">// 钩子函数，</span></span><br><span class="line">        observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重点方法</span></span><br><span class="line">            subscribeActual(observer);</span><br><span class="line">        &#125; ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>SingleJust:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleJust</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleJust(T value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">      <span class="comment">// Disposable.disposed 表示已经被丢弃</span></span><br><span class="line">      <span class="comment">// singlejust是立刻执行后取消的任务，所以可以直接取消</span></span><br><span class="line">        observer.onSubscribe(Disposable.disposed());</span><br><span class="line">      <span class="comment">// 成功，将内部存储的对象传过去也就是Single.just(&quot;1&quot;)中传的1</span></span><br><span class="line">        observer.onSuccess(value);</span><br><span class="line">      <span class="comment">// 没有onError 因为它是不可能失败的，把一个准备好的对象传过去是不会失败的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174653269.png" alt="image-20210826174653269"></p>
<h2 id="操作符-Operator-map-等等"><a href="#操作符-Operator-map-等等" class="headerlink" title="操作符 Operator(map() 等等):"></a>操作符 Operator(map() 等等):</h2><ol>
<li>基于原 Observable 创建一个新的 Observable</li>
<li>Observable 内部创建一个 Observer</li>
<li>通过定制 Observable 的 subscribeActual() 方法和 Observer 的 onSuccess() 方法，来实现自己的中介⻆色(例如数据转换、线程切换)</li>
</ol>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174752970.png" alt="image-20210826174752970"></p>
<p>Eg:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">operatorRx</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> single:Single&lt;<span class="built_in">Int</span>&gt; = Single.just(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> singleString = single.map(<span class="keyword">object</span> :Function&lt;<span class="built_in">Int</span>,String&gt;&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(t: <span class="type">Int</span>?)</span></span>: String &#123;</span><br><span class="line">            <span class="keyword">return</span>  t.toString()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Single.map方法：基于原 Observable 创建一个新的 Observable</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CheckReturnValue</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="meta">@SchedulerSupport(SchedulerSupport.NONE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> &lt;<span class="meta">@NonNull</span> R&gt; Single&lt;R&gt; map(<span class="meta">@NonNull</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">    Objects.requireNonNull(mapper, <span class="string">&quot;mapper is null&quot;</span>);</span><br><span class="line">    <span class="comment">//基于原 Observable 创建一个新的 Observable：创建一个SingleMap，将自己身和需要转换的操作符(map)</span></span><br><span class="line">    <span class="comment">//传过去</span></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(new SingleMap&lt;&gt;(<span class="keyword">this</span>, mapper));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SingleMap：Observable 内部创建一个 Observer</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleMap</span>&lt;<span class="type">T, R</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleMap(SingleSource&lt;? extends T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t) &#123;</span><br><span class="line">      <span class="comment">// 真正执行的代码，将会创建一个MapSingleObserver</span></span><br><span class="line">        source.subscribe(new MapSingleObserver&lt;T, R&gt;(t, mapper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapSingleObserver</span>&lt;<span class="type">T, R</span>&gt; <span class="title">implements</span> <span class="title">SingleObserver</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> R&gt; t;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> R&gt; t, Function&lt;? <span class="keyword">super</span> T, ? extends R&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">this</span>.t = t;</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">            t.onSubscribe(d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">            R v;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 若需要转换则使用传来的操作符接口进行转换</span></span><br><span class="line">                v = Objects.requireNonNull(mapper.apply(value), <span class="string">&quot;The mapper function returned a null value.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwIfFatal(e);</span><br><span class="line">                onError(e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">						<span class="comment">//转换成功后传递给下游（最表面的观察者，也是开发者真正调用的那个接口回调）</span></span><br><span class="line">            t.onSuccess(v);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若再增加操作符也是一样的，只不过会增加更多的被观察者，观察者</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210827153255139.png" alt="image-20210827153255139"></p>
<h2 id="Disposable"><a href="#Disposable" class="headerlink" title="Disposable:"></a>Disposable:</h2><p>上游停止生产，上下游切断联系</p>
<p> 可以通过 dispose() 方法来让上游或内部调度器(或两者都有)停止工作，达到「丢弃」的效果。</p>
<blockquote>
<p> SingleJust，没有延迟没有后续，可以直接取消</p>
</blockquote>
<blockquote>
<p>总结：Disposable是一个桥接器，dispose时，先看这个生产者（被观察者）有没有来自上游的后续任务，有没有自己生产的后续任务（延时任务）停止工作。</p>
</blockquote>
<h3 id="有延迟的任务如何取消"><a href="#有延迟的任务如何取消" class="headerlink" title="有延迟的任务如何取消"></a>有延迟的任务如何取消</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延迟调用， ，每间隔一秒调用一次</span></span><br><span class="line">Observable.interval(<span class="number">0</span>,<span class="number">1</span>,TimeUnit.SECONDS)</span><br><span class="line"> .observeOn(AndroidSchedulers.mainThread())<span class="comment">// 延迟发生在子线程，所以回调到主线程主线程</span></span><br><span class="line"> .subscribe(<span class="keyword">object</span>: Observer&lt;<span class="built_in">Long</span>?&gt; &#123;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onComplete</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSubscribe</span><span class="params">(d: <span class="type">Disposable</span>?)</span></span> &#123; &#125;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onNext</span><span class="params">(t: <span class="type">Long</span>?)</span></span> &#123;</span><br><span class="line">     textView.text = t.toString()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Throwable</span>?)</span></span> &#123;&#125;&#125; )</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableInterval</span> <span class="title">extends</span> <span class="title">Observable</span>&lt;<span class="type">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> long initialDelay;</span><br><span class="line">    <span class="keyword">final</span> long period;</span><br><span class="line">    <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> <span class="built_in">Long</span>&gt; observer) &#123;</span><br><span class="line">       <span class="comment">//核心方法 实例化 IntervalObserver(下游的observer)</span></span><br><span class="line">        IntervalObserver <span class="keyword">is</span> = new IntervalObserver(observer);</span><br><span class="line">        ...</span><br><span class="line">      	<span class="keyword">if</span> (sch instanceof TrampolineScheduler) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在后台处理轮训任务，每次执行完毕都会调用  IntervalObserver（is）的run方法</span></span><br><span class="line">            Disposable d = sch.schedulePeriodicallyDirect(<span class="keyword">is</span>, initialDelay, period, unit);</span><br><span class="line">            <span class="keyword">is</span>.setResource(d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 没有继承Observer ,继承了一个可取消的disposable</span></span><br><span class="line">  <span class="comment">// 调用dispose方法时，会调用真正的dispose实现</span></span><br><span class="line">  <span class="comment">// 之所以如此复杂，是因为它既要保持链性结构，又要轮训后执行的run方法和dispose指向同一对象统一管理</span></span><br><span class="line">      static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntervalObserver</span> </span></span><br><span class="line">      extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">      implements Disposable, Runnable &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 每次轮训回调都会调用一下run方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">get</span>() != DisposableHelper.DISPOSED) &#123;</span><br><span class="line">                downstream.onNext(count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置内部的dispose</span></span><br><span class="line">        <span class="keyword">public</span> void setResource(Disposable d) &#123;</span><br><span class="line">            DisposableHelper.setOnce(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> DisposableHelper</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 调用内部的disposeable的值</span></span><br><span class="line">  <span class="keyword">public</span> static boolean dispose(AtomicReference&lt;Disposable&gt; field) &#123;</span><br><span class="line">      Disposable current = field.<span class="keyword">get</span>();</span><br><span class="line">      Disposable d = DISPOSED;</span><br><span class="line">    <span class="comment">// 拿到内部的Disposable，若没有被取消，则执行Disposable的dispose方法</span></span><br><span class="line">      <span class="keyword">if</span> (current != d) &#123;</span><br><span class="line">          current = field.getAndSet(d);</span><br><span class="line">          <span class="keyword">if</span> (current != d) &#123;</span><br><span class="line">              <span class="keyword">if</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">                  current.dispose();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 只设置一次disposable对象</span></span><br><span class="line">  <span class="keyword">public</span> static boolean setOnce(AtomicReference&lt;Disposable&gt; field, Disposable d) &#123;</span><br><span class="line">      Objects.requireNonNull(d, <span class="string">&quot;d is null&quot;</span>);</span><br><span class="line">    <span class="comment">//dispose对象为空的时候才设置</span></span><br><span class="line">      <span class="keyword">if</span> (!field.compareAndSet(<span class="literal">null</span>, d)) &#123;</span><br><span class="line">          d.dispose();</span><br><span class="line">          <span class="keyword">if</span> (field.<span class="keyword">get</span>() != DISPOSED) &#123;</span><br><span class="line">              reportDisposableSet();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="有上游的任务该如何取消"><a href="#有上游的任务该如何取消" class="headerlink" title="有上游的任务该如何取消"></a>有上游的任务该如何取消</h3><p>若是没有延迟和后续的single.map：上游dispose对象会直接传递到下一级，取消任务和它无关</p>
<p>若事件是有延迟无后续Singledelay</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">         .delay(<span class="number">1</span>,TimeUnit.SECONDS)</span><br><span class="line">         .subscribe(<span class="keyword">object</span>: SingleObserver&lt;<span class="built_in">Int</span>?&gt;&#123;</span><br><span class="line">             <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">(t: <span class="type">Int</span>?)</span></span> &#123;</span><br><span class="line">             &#125;...&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleDelay</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line">    <span class="keyword">final</span> long time;</span><br><span class="line">    <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">final</span> boolean delayError;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleDelay(SingleSource&lt;? extends T&gt; source, long time, TimeUnit unit, Scheduler scheduler, boolean delayError) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">        <span class="keyword">this</span>.unit = unit;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">				<span class="comment">//自己的disposeable 实例</span></span><br><span class="line">        <span class="keyword">final</span> SequentialDisposable sd = new SequentialDisposable();</span><br><span class="line">        observer.onSubscribe(sd);</span><br><span class="line">       <span class="comment">// 不能直接传递上游的disposable，若dipose消息发出时，消息还在上游，上游直接拿到disposable对象，本层终止程序没有问题</span></span><br><span class="line">      <span class="comment">// 若消息已经传到本层级，那么停止消息就应该自己处理（上游singlejust已经没有处理的必要，本层却有延迟功能，这层应该关闭自己的定时器）</span></span><br><span class="line">        source.subscribe(new Delay(sd, observer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Delay</span> <span class="title">implements</span> <span class="title">SingleObserver</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> SequentialDisposable sd;</span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        Delay(SequentialDisposable sd, SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sd = sd;</span><br><span class="line">            <span class="keyword">this</span>.downstream = observer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">           <span class="comment">//收到上游消息之前，若收到取消任务的通知，直接替换上游的disposable</span></span><br><span class="line">           <span class="comment">//本地的disposable被赋值成上游的，即可通知上游终止任务</span></span><br><span class="line">            sd.replace(d);</span><br><span class="line">        &#125;</span><br><span class="line">  			<span class="comment">//若已经收到上游的消息，无论成功失败都需要自己处理</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(<span class="keyword">final</span> T value) &#123;</span><br><span class="line">         		<span class="comment">// disposable替换成线程调度器，若通知取消任务要自主调用线程调度器关闭延时</span></span><br><span class="line">            sd.replace(scheduler.scheduleDirect(new OnSuccess(value), time, unit));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(<span class="keyword">final</span> Throwable e) &#123;</span><br><span class="line">          <span class="comment">// disposable替换成线程调度器，若通知取消任务要自主调用线程调度器关闭延时</span></span><br><span class="line">            sd.replace(scheduler.scheduleDirect(new OnError(e), delayError ? time : <span class="number">0</span>, unit));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OnSuccess</span> <span class="title">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交给内部的Disposable解决</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SequentialDisposable</span></span></span><br><span class="line">extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">implements Disposable &#123; ...</span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable(Disposable initial) &#123;</span><br><span class="line">        lazySet(initial);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> boolean replace(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.replace(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">    &#125; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有后续无延迟的任务如何取消"><a href="#有后续无延迟的任务如何取消" class="headerlink" title="有后续无延迟的任务如何取消"></a>有后续无延迟的任务如何取消</h3><p>ObservableMap的任务取消</p>
<p>dispose也是拿到上游的disposable进行取消，几乎等同于直接拿到上游的对象进行取消<br>map只是通过包装在消息传达时多做一些操作符操作而已</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableMap</span>&lt;<span class="type">T, U</span>&gt; <span class="title">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="type">T, U</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ObservableMap(ObservableSource&lt;T&gt; source, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; function) &#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">        <span class="keyword">this</span>.function = function;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> U&gt; t) &#123;</span><br><span class="line">        source.subscribe(new MapObserver&lt;T, U&gt;(t, function));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MapObserver</span>&lt;<span class="type">T, U</span>&gt; <span class="title">extends</span> <span class="title">BasicFuseableObserver</span>&lt;<span class="type">T, U</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper;</span><br><span class="line"></span><br><span class="line">        MapObserver(Observer&lt;? <span class="keyword">super</span> U&gt; <span class="keyword">actual</span>, Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; mapper) &#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="keyword">actual</span>);</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onNext(T t) &#123;</span><br><span class="line">            <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">				...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicFuseableObserver</span>&lt;<span class="type">T, R</span>&gt; <span class="title">implements</span> <span class="title">Observer</span>&lt;<span class="type">T</span>&gt;, <span class="type">QueueDisposable</span>&lt;<span class="type">R</span>&gt; </span>&#123; </span><br><span class="line">  <span class="comment">// 设置下游</span></span><br><span class="line">  <span class="keyword">public</span> BasicFuseableObserver(Observer&lt;? <span class="keyword">super</span> R&gt; downstream) &#123;</span><br><span class="line">        <span class="keyword">this</span>.downstream = downstream;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">      <span class="comment">//验证过上游</span></span><br><span class="line">        <span class="keyword">if</span> (DisposableHelper.validate(<span class="keyword">this</span>.upstream, d)) &#123;</span><br><span class="line">						<span class="comment">// 设置上游</span></span><br><span class="line">            <span class="keyword">this</span>.upstream = d;</span><br><span class="line">            <span class="keyword">if</span> (d instanceof QueueDisposable) &#123;</span><br><span class="line">                <span class="keyword">this</span>.qd = (QueueDisposable&lt;T&gt;)d;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (beforeDownstream()) &#123;</span><br><span class="line"></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                afterDownstream();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// dispose也是拿到上游的disposed进行取消，几乎等同于直接拿到上游的对象进行取消</span></span><br><span class="line">  <span class="comment">// map只是通过包装在消息传达时多做一些操作符操作而已</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        upstream.dispose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="有后续有延迟的任务如何取消"><a href="#有后续有延迟的任务如何取消" class="headerlink" title="有后续有延迟的任务如何取消"></a>有后续有延迟的任务如何取消</h3><p>Observable </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Observable&lt;T&gt; delay(long time, <span class="meta">@NonNull</span> TimeUnit unit, <span class="meta">@NonNull</span> Scheduler scheduler, boolean delayError) &#123;</span><br><span class="line">    Objects.requireNonNull(unit, <span class="string">&quot;unit is null&quot;</span>);</span><br><span class="line">    Objects.requireNonNull(scheduler, <span class="string">&quot;scheduler is null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(new ObservableDelay&lt;&gt;(<span class="keyword">this</span>, time, unit, scheduler, delayError));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ObservableDelay</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableDelay</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">AbstractObservableWithUpstream</span>&lt;<span class="type">T, T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">public</span> void subscribeActual(Observer&lt;? <span class="keyword">super</span> T&gt; t) &#123;</span><br><span class="line">        Observer&lt;T&gt; observer;</span><br><span class="line">        <span class="keyword">if</span> (delayError) &#123;</span><br><span class="line">            observer = (Observer&lt;T&gt;)t;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            observer = new SerializedObserver&lt;&gt;(t);</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 线程调度器，创建延迟任务</span></span><br><span class="line">        Scheduler.Worker w = scheduler.createWorker();</span><br><span class="line"></span><br><span class="line">        source.subscribe(new DelayObserver&lt;&gt;(observer, delay, unit, w, delayError));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">      static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayObserver</span>&lt;<span class="type">T</span>&gt; <span class="title">implements</span> <span class="title">Observer</span>&lt;<span class="type">T</span>&gt;, <span class="type">Disposable &#123;</span></span></span><br><span class="line">        <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line">        <span class="keyword">final</span> long delay;</span><br><span class="line">        <span class="keyword">final</span> TimeUnit unit;</span><br><span class="line">        <span class="keyword">final</span> Scheduler.Worker w;</span><br><span class="line">        <span class="keyword">final</span> boolean delayError;</span><br><span class="line"></span><br><span class="line">        Disposable upstream;</span><br><span class="line"></span><br><span class="line">        DelayObserver(Observer&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, long delay, TimeUnit unit, Worker w, boolean delayError) &#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.delay = delay;</span><br><span class="line">            <span class="keyword">this</span>.unit = unit;</span><br><span class="line">            <span class="keyword">this</span>.w = w;</span><br><span class="line">            <span class="keyword">this</span>.delayError = delayError;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 上游下游的连接</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">          <span class="comment">// 验证上游</span></span><br><span class="line">            <span class="keyword">if</span> (DisposableHelper.validate(<span class="keyword">this</span>.upstream, d)) &#123;</span><br><span class="line">              <span class="comment">//上游赋值</span></span><br><span class="line">                <span class="keyword">this</span>.upstream = d;</span><br><span class="line">              <span class="comment">//调用下游的onSubscribe 订阅流程，传递的对象是自身（继承了Disposeable对象）</span></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onNext(<span class="keyword">final</span> T t) &#123;</span><br><span class="line">           <span class="comment">// 延迟调度器进行调度</span></span><br><span class="line">            w.schedule(new OnNext(t), delay, unit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            <span class="comment">// 延迟调度器进行调度</span></span><br><span class="line">            w.schedule(new OnError(t), delayError ? delay : <span class="number">0</span>, unit);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            <span class="comment">// 上游取消，不要在发消息了</span></span><br><span class="line">            upstream.dispose();</span><br><span class="line">						<span class="comment">// 延迟调度器也取消，有下游的消息也不要再发了</span></span><br><span class="line">            w.dispose();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="线程调度器"><a href="#线程调度器" class="headerlink" title="线程调度器"></a>线程调度器</h2><h3 id="subscribeOn"><a href="#subscribeOn" class="headerlink" title="subscribeOn()"></a>subscribeOn()</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>在 Scheduler 指定的线程里启动 subscribe()</p>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><ul>
<li>切换起源 Observable 的线程（也就是下游订阅上游事件的时候切线程）;</li>
<li>当多次调用 subscribeOn() 的时候，只有最上面的会对起源 Observable 起作用。</li>
</ul>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155354768.png" alt="image-20210830155354768"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleSubscribeOn</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleSubscribeOn(SingleSource&lt;? extends T&gt; source, Scheduler scheduler) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="keyword">final</span> SubscribeOnObserver&lt;T&gt; parent = new SubscribeOnObserver&lt;&gt;(observer, source);</span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line">				<span class="comment">// 核心方法 切换线程，parent是runnable接口</span></span><br><span class="line">        Disposable f = scheduler.scheduleDirect(parent);</span><br><span class="line">				<span class="comment">// 将上游的disposable对象替换为本地的disposable代理类</span></span><br><span class="line">        parent.task.replace(f);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeOnObserver</span>&lt;<span class="type">T</span>&gt;</span></span><br><span class="line">    extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">    implements SingleObserver&lt;T&gt;, Disposable, Runnable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = <span class="number">7000911171163930287L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SequentialDisposable task;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleSource&lt;? extends T&gt; source;</span><br><span class="line"></span><br><span class="line">        SubscribeOnObserver(SingleObserver&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, SingleSource&lt;? extends T&gt; source) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.source = source;</span><br><span class="line">          	<span class="comment">//task 被赋值，SequentialDisposable 也是个代理类，不执行实际逻辑</span></span><br><span class="line">            <span class="keyword">this</span>.task = new SequentialDisposable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">          <span class="comment">// disposable实际赋值，上游传递来的disposable</span></span><br><span class="line">            DisposableHelper.setOnce(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">            downstream.onSuccess(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(Throwable e) &#123;</span><br><span class="line">            downstream.onError(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">           <span class="comment">// 通知上游的disposeable取消任务</span></span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">           <span class="comment">// 通知内部取消任务</span></span><br><span class="line">            task.dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">            <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">          <span class="comment">// 切换线程后对上游进行订阅</span></span><br><span class="line">            source.subscribe(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SequentialDisposable</span></span></span><br><span class="line">extends AtomicReference&lt;Disposable&gt;</span><br><span class="line">implements Disposable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = -<span class="number">754898800686245608L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable() &#123;</span><br><span class="line">        <span class="comment">// nothing to do</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SequentialDisposable(Disposable initial) &#123;</span><br><span class="line">        lazySet(initial);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> boolean update(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.<span class="keyword">set</span>(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> boolean replace(Disposable next) &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.replace(<span class="keyword">this</span>, next);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">        DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">        <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若多次调用subscribeOn方法切换线程，只会有一个线程影响任务的执行，多次调用是没有用的</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155602490.png" alt="image-20210830155602490"></p>
<h3 id="observeOn"><a href="#observeOn" class="headerlink" title="observeOn()"></a>observeOn()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleObserveOn</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">Single</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> SingleSource&lt;T&gt; source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SingleObserveOn(SingleSource&lt;T&gt; source, Scheduler scheduler) &#123;</span><br><span class="line">        <span class="keyword">this</span>.source = source;</span><br><span class="line">        <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void subscribeActual(<span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</span><br><span class="line">       	<span class="comment">// 订阅过程不切线程</span></span><br><span class="line">        source.subscribe(new ObserveOnSingleObserver&lt;&gt;(observer, scheduler));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserveOnSingleObserver</span>&lt;<span class="type">T</span>&gt; <span class="title">extends</span> <span class="title">AtomicReference</span>&lt;<span class="type">Disposable</span>&gt;</span></span><br><span class="line">    implements SingleObserver&lt;T&gt;, Disposable, Runnable &#123;</span><br><span class="line">        <span class="keyword">private</span> static <span class="keyword">final</span> long serialVersionUID = <span class="number">3528003840217436037L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SingleObserver&lt;? <span class="keyword">super</span> T&gt; downstream;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">        T value;</span><br><span class="line">        Throwable error;</span><br><span class="line"></span><br><span class="line">        ObserveOnSingleObserver(SingleObserver&lt;? <span class="keyword">super</span> T&gt; <span class="keyword">actual</span>, Scheduler scheduler) &#123;</span><br><span class="line">            <span class="keyword">this</span>.downstream = <span class="keyword">actual</span>;</span><br><span class="line">            <span class="keyword">this</span>.scheduler = scheduler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSubscribe(Disposable d) &#123;</span><br><span class="line">           <span class="comment">// 订阅过程，不切换线程</span></span><br><span class="line">            <span class="keyword">if</span> (DisposableHelper.setOnce(<span class="keyword">this</span>, d)) &#123;</span><br><span class="line">               <span class="comment">//赋值dispose（来自上游的disposable），</span></span><br><span class="line">              <span class="comment">//实际上下游取消的时候就会取消掉上游的任务（因为没有切换线程）</span></span><br><span class="line">                downstream.onSubscribe(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onSuccess(T value) &#123;</span><br><span class="line">          <span class="comment">// 上游事件到达后切线程</span></span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">          <span class="comment">// 收到线程后再取消，将内部的disposable替换成切线程的任务</span></span><br><span class="line">          <span class="comment">// 不需要通知上游，直接取消即可</span></span><br><span class="line">            Disposable d = scheduler.scheduleDirect(<span class="keyword">this</span>);</span><br><span class="line">            DisposableHelper.replace(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void onError(Throwable e) &#123;</span><br><span class="line">          <span class="comment">// 事件到达后切线程</span></span><br><span class="line">            <span class="keyword">this</span>.error = e;</span><br><span class="line">          <span class="comment">// 事件到达后取消的是切线程</span></span><br><span class="line">            Disposable d = scheduler.scheduleDirect(<span class="keyword">this</span>);</span><br><span class="line">          <span class="comment">// 将disposable替换呢为b</span></span><br><span class="line">            DisposableHelper.replace(<span class="keyword">this</span>, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void run() &#123;</span><br><span class="line">            Throwable ex = error;</span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="literal">null</span>) &#123;</span><br><span class="line">                downstream.onError(ex);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                downstream.onSuccess(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> void dispose() &#123;</span><br><span class="line">            DisposableHelper.dispose(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> boolean isDisposed() &#123;</span><br><span class="line">            <span class="keyword">return</span> DisposableHelper.isDisposed(<span class="keyword">get</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>在内部创建的 Observer 的 onNext() onError() onSuccess() 等回调方法里，通过 Scheduler 指定的线程来调用下级 Observer 的对应回调方法</p>
<p>在任务下发到下游的时候才切线程，订阅上游事件的时候不切线程</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210830155936495.png" alt="image-20210830155936495"></p>
<h4 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h4><p>切换 observeOn() 下面的 Observer 的回调所在的线程<br> 当多次调用 observeOn() 的时候，每个都会进行一次线程切换，影响范围是它 下面的每个 Observer (除非又遇到新的 observeOn())</p>
<p><img src="https://gitee.com/laonaiping/blog-images/raw/master/img/image-20210826174959565.png" alt="image-20210826174959565"></p>
<h3 id="Scheduler-的原理"><a href="#Scheduler-的原理" class="headerlink" title="Scheduler 的原理"></a>Scheduler 的原理</h3><ol>
<li><p>Schedulers.newThread() 和 Schedulers.io():</p>
<ul>
<li>当 scheduleDirect() 被调用的时候，会创建一个 Worker，Worker 的内部 会有一个 Executor，由 Executor 来完成实际的线程切换; </li>
<li>scheduleDirect() 还会创建出一个 Disposable 对象，交给外层的 Observer，让它能执行 dispose() 操作，取消订阅链;</li>
<li>newThread() 和 io() 的区别在于，io() 可能会对 Executor 进行重用。</li>
</ul>
</li>
<li><p>androidSchedulers.mainThread():</p>
<p>通过内部的 Handler 把任务放到主线程去做。</p>
</li>
</ol>
<p>Scheduler</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"> <span class="keyword">public</span> Disposable scheduleDirect(<span class="meta">@NonNull</span> Runnable run, long delay, <span class="meta">@NonNull</span> TimeUnit unit) &#123;</span><br><span class="line">     <span class="keyword">final</span> Worker w = createWorker();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> Runnable decoratedRun = RxJavaPlugins.onSchedule(run);</span><br><span class="line"></span><br><span class="line">     DisposeTask task = new DisposeTask(decoratedRun, w);</span><br><span class="line"></span><br><span class="line">     w.schedule(task, delay, unit);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> task;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Schedulers-newThread-和iSchedulers-io"><a href="#Schedulers-newThread-和iSchedulers-io" class="headerlink" title="Schedulers.newThread()和iSchedulers.io()"></a>Schedulers.newThread()和iSchedulers.io()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">    .subscribeOn(Schedulers.newThread())<span class="comment">//newThread()是io的基础</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NewThreadWorker(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThreadWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line">		<span class="comment">//包含一个executor进行线程调度，每次都会用全新的executor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewThreadWorker</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">        executor = SchedulerPoolFactory.create(threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerPoolFactory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">create</span><span class="params">(ThreadFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ScheduledExecutorService exec = Executors.newScheduledThreadPool(<span class="number">1</span>, factory);</span><br><span class="line">        tryPutIntoPool(PURGE_ENABLED, exec);</span><br><span class="line">        <span class="keyword">return</span> exec;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IoScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">  	...</span><br><span class="line">		<span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Worker <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EventLoopWorker(pool.get());</span><br><span class="line">    &#125;  </span><br><span class="line">   ...</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EventLoopWorker</span> <span class="keyword">extends</span> <span class="title">Scheduler</span>.<span class="title">Worker</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CompositeDisposable tasks;</span><br><span class="line">      <span class="comment">// Executor 重用池，newThread是没有重用池的，这就是io和newThread的区别</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CachedWorkerPool pool;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ThreadWorker threadWorker;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AtomicBoolean once = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"></span><br><span class="line">        EventLoopWorker(CachedWorkerPool pool) &#123;</span><br><span class="line">            <span class="keyword">this</span>.pool = pool;</span><br><span class="line">            <span class="keyword">this</span>.tasks = <span class="keyword">new</span> CompositeDisposable();</span><br><span class="line">            <span class="keyword">this</span>.threadWorker = pool.get();</span><br><span class="line">        &#125;</span><br><span class="line">    ....</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadWorker</span> <span class="keyword">extends</span> <span class="title">NewThreadWorker</span> </span>&#123;</span><br><span class="line">			<span class="comment">// 继承了NewThreadWork</span></span><br><span class="line">        <span class="keyword">long</span> expirationTime;</span><br><span class="line"></span><br><span class="line">        ThreadWorker(ThreadFactory threadFactory) &#123;</span><br><span class="line">            <span class="keyword">super</span>(threadFactory);</span><br><span class="line">            <span class="keyword">this</span>.expirationTime = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getExpirationTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpirationTime</span><span class="params">(<span class="keyword">long</span> expirationTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.expirationTime = expirationTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<h3 id="切到主线程"><a href="#切到主线程" class="headerlink" title="切到主线程"></a>切到主线程</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Single.just(<span class="number">1</span>)</span><br><span class="line">    .observeOn(AndroidSchedulers.mainThread())</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidSchedulers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Scheduler DEFAULT</span><br><span class="line">            = <span class="keyword">new</span> HandlerScheduler(<span class="keyword">new</span> Handler(Looper.getMainLooper()), <span class="keyword">true</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerScheduler</span> <span class="keyword">extends</span> <span class="title">Scheduler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;NewApi&quot;)</span> <span class="comment">// Async will only be true when the API is available to call.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Disposable <span class="title">scheduleDirect</span><span class="params">(Runnable run, <span class="keyword">long</span> delay, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (run == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;run == null&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (unit == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;unit == null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        run = RxJavaPlugins.onSchedule(run);</span><br><span class="line">        ScheduledRunnable scheduled = <span class="keyword">new</span> ScheduledRunnable(handler, run);</span><br><span class="line">        Message message = Message.obtain(handler, scheduled);</span><br><span class="line">        <span class="keyword">if</span> (async) &#123;</span><br><span class="line">            message.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用handler切回到主线程</span></span><br><span class="line">        handler.sendMessageDelayed(message, unit.toMillis(delay));</span><br><span class="line">        <span class="keyword">return</span> scheduled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/RxJava3/" rel="tag"># RxJava3</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/25/Android%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%BA%E5%88%B6/" rel="prev" title="Android的多线程机制">
      <i class="fa fa-chevron-left"></i> Android的多线程机制
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/06/%E8%87%AA%E5%AE%9A%E4%B9%89view%E5%B8%83%E5%B1%8001:%E5%B8%83%E5%B1%80%E6%B5%81%E7%A8%8B%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/" rel="next" title="自定义view布局01:布局流程完全解析">
      自定义view布局01:布局流程完全解析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RxJava-3-%E7%9A%84%E5%8E%9F%E7%90%86%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">RxJava 3 的原理完全解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">框架结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%EF%BC%9A"><span class="nav-number">1.3.</span> <span class="nav-text">创建：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6-Operator-map-%E7%AD%89%E7%AD%89"><span class="nav-number">1.4.</span> <span class="nav-text">操作符 Operator(map() 等等):</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disposable"><span class="nav-number">1.5.</span> <span class="nav-text">Disposable:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%BB%B6%E8%BF%9F%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%A6%82%E4%BD%95%E5%8F%96%E6%B6%88"><span class="nav-number">1.5.1.</span> <span class="nav-text">有延迟的任务如何取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E4%B8%8A%E6%B8%B8%E7%9A%84%E4%BB%BB%E5%8A%A1%E8%AF%A5%E5%A6%82%E4%BD%95%E5%8F%96%E6%B6%88"><span class="nav-number">1.5.2.</span> <span class="nav-text">有上游的任务该如何取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%90%8E%E7%BB%AD%E6%97%A0%E5%BB%B6%E8%BF%9F%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%A6%82%E4%BD%95%E5%8F%96%E6%B6%88"><span class="nav-number">1.5.3.</span> <span class="nav-text">有后续无延迟的任务如何取消</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%90%8E%E7%BB%AD%E6%9C%89%E5%BB%B6%E8%BF%9F%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%A6%82%E4%BD%95%E5%8F%96%E6%B6%88"><span class="nav-number">1.5.4.</span> <span class="nav-text">有后续有延迟的任务如何取消</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-number">1.6.</span> <span class="nav-text">线程调度器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#subscribeOn"><span class="nav-number">1.6.1.</span> <span class="nav-text">subscribeOn()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#observeOn"><span class="nav-number">1.6.2.</span> <span class="nav-text">observeOn()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-1"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C-1"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduler-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">1.6.3.</span> <span class="nav-text">Scheduler 的原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Schedulers-newThread-%E5%92%8CiSchedulers-io"><span class="nav-number">1.6.4.</span> <span class="nav-text">Schedulers.newThread()和iSchedulers.io()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E5%88%B0%E4%B8%BB%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.6.5.</span> <span class="nav-text">切到主线程</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="oldnineping"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">oldnineping</p>
  <div class="site-description" itemprop="description">技术日记和杂七杂八的dx</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">oldnineping</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
